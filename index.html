<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1d1d5c">
	<title>ğŸŠ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
   <link rel="manifest" href="/notes-pwa/manifest.json">
 <style>
    	@font-face {
    font-family: 'KingHwa';
    src: url('/notes-pwa/fonts/KingHwa.woff') format('woff');
    font-weight: 200;
    font-style: normal;
    font-display: swap;
}
        body { 
            font-family: 'KingHwa', "KaiTi", serif;
            padding: 20px; 
            background-color: #1d1d5c; /* ç½‘é¡µèƒŒæ™¯è‰² */
            color: #f7ebeb; /* æ­£æ–‡é¢œè‰² */
            font-size: 11.5px;
           
    background-size: 4px 30px;
    background-position: -1px -1px;
        }
        .post pre, .post div {
    font-weight: 200;
}
.tag-filter {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #1d1d5c;
    z-index: 1000;
    padding: 10px 20px;
    padding-right: 20px; /* æ–°å¢ */
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    padding-bottom: 15px;
    height: auto;
    align-items: center;
    overflow-x: auto;
    white-space: nowrap;
    flex-wrap: nowrap;
    scrollbar-width: thin;
    scrollbar-color: #1d1d5c #1d1d5c;
}

.tag-filter::after { /* æ–°å¢ä¼ªå…ƒç´  */
    content: "";
    display: inline-block;
    min-width: 20px;
    height: 1px;
}

/* é’ˆå¯¹Webkitæµè§ˆå™¨ï¼ˆChrome, Safariç­‰ï¼‰çš„æ»šåŠ¨æ¡æ ·å¼ */
.tag-filter::-webkit-scrollbar {
    height: 1px;
    background-color: #1d1d5c; /* è½¨é“èƒŒæ™¯è‰² */
}

.tag-filter::-webkit-scrollbar-thumb {
    background-color: transparent; /* æ»‘å—é¢œè‰² - ä½¿ç”¨æ ‡ç­¾æ©™è‰² */
    border-radius: 1px;
    height: 1px;
}

.tag-filter::-webkit-scrollbar-track {
    background: #1d1d5c; /* è½¨é“é¢œè‰² */
}

 .tag {
    background-color: transparent;
    color: #ba5757;
    font-size: 12px;
    padding: 5px 6px;
    cursor: pointer;
    border-radius: 3px;
    display: inline-block; /* ç¡®ä¿æ ‡ç­¾æ¨ªå‘æ’åˆ— */
    white-space: nowrap; /* é˜²æ­¢æ ‡ç­¾å†…æ–‡å­—æ¢è¡Œ */
}

.tag.active {
    background-color: transparent;
    font-weight: bold;
    text-decoration: underline;
    /* å°†å¤–é˜´å½±æ”¹ä¸ºå†…é˜´å½± */
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); /* ä½¿ç”¨insetå…³é”®å­—åˆ›å»ºå†…é˜´å½± */
    /* å¯é€‰ï¼šæ·»åŠ ä¸€ç‚¹æ–‡å­—å‡¹é™·æ•ˆæœ */
    text-shadow: 0 -1px 1px rgba(0,0,0,0.3);
}

   .posts-container { 
    column-count: 3;     /* åˆ†ä¸‰åˆ— */
    column-gap: 7.5px;  /* åˆ—é—´è· */
    margin-top: 40px; /* ç•™å‡ºé¡¶éƒ¨ç©ºé—´ */
    margin-bottom: 60px; /* ç•™å‡ºåº•éƒ¨ç©ºé—´ */
}
/* å¹³æ¿æ¨ªå±/å¤§å±è®¾å¤‡ */
@media (min-width: 1024px) {
    .posts-container {
        column-count: 3 !important;
    }
}

/* æ‰‹æœºè®¾å¤‡ */
@media (max-width: 550px) {
    .posts-container {
        column-count: 1 !important;
    }
}

/* å¹³æ¿åˆ†å±æ¨¡å¼é€‚é…ï¼ˆçº¦50%å®½åº¦æ—¶ä¿æŒä¸‰åˆ—ï¼‰*/
@media (min-width: 550px) and (max-width: 850px) {
    .posts-container {
        column-count: 2 !important;
    }
}
.post {
    break-inside: avoid; /* é˜²æ­¢å†…å®¹è·¨åˆ—æ–­å¼€ */
    margin-bottom: 0;/* æ›¿ä»£åŸgapé—´è· */
    width: 100%;         /* å æ»¡åˆ—å®½ */
    position: relative;
    z-index: 2;  /* å»ºç«‹æ–°çš„å±‚å ä¸Šä¸‹æ–‡å¹¶é«˜äºé®ç½© */
    /* ä¿æŒå…¶ä»–åŸæœ‰æ ·å¼ */
}
        .post { 
            background: transparent; /* å¸–å­èƒŒæ™¯ */
            padding: 10px;
            display: flex;
            flex-direction: column;
            line-height: 1.7;    /* å¢åŠ è¡Œè· */
    letter-spacing: 0.3px; /* å¢åŠ å­—é—´è· */
    /* å·²æœ‰æ ·å¼ä¿æŒä¸å˜ */
    padding-top: 0 !important;
    padding-bottom: 5px !important;
        }
        .post-actions {
    margin-top: 10px;
    display: none; /* é»˜è®¤éšè— */
}
.post pre {
	position: relative; /* æ–°å¢å®šä½ */
    z-index: 3; /* ç¡®ä¿æ–‡å­—åœ¨é®ç½©ä¸Šå±‚ */
    white-space: pre-wrap !important; /* å¼ºåˆ¶ä¿ç•™ç©ºç™½ */
    word-break: break-word !important;
    font-family: inherit !important; /* ä¿æŒå­—ä½“ä¸€è‡´ */
    margin: 0 !important;
    line-height: 1.5;
}

.post-actions button {
    background-color: #141440 !important; /* æ ‡ç­¾æ©™è‰² */
    color: #f7ebeb !important; /* æ­£æ–‡é¢œè‰² */
    border: none;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    padding: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3) !important;
}

.edit-mode .post-actions {
    display: flex;
    gap: 10px;
    justify-content: space-between; /* è®©æŒ‰é’®ä¸¤ç«¯å¯¹é½ */
}
        .post-media {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .post-media iframe {
            width: 100%;
            aspect-ratio: 4/3; /* ä»…è§†é¢‘ä¿æŒæ¯”ä¾‹ */
        }
        .post-media img {
            max-width: 100%;
            height: auto; /* å›¾ç‰‡è‡ªé€‚åº” */
        }
        
        
        /* æ–°å¢åˆ†é¡µå®šä½æ ·å¼ */
.posts-container {
    position: relative;
}
.pagination {
    position: fixed;
    left: 0;
    right: 0;       /* å·¦å³è´´è¾¹ */
    bottom: 0;      /* ç´§è´´åº•éƒ¨ */
    background: #1d1d5c;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.3);
    padding: 4px 0;
    z-index: 998;
    margin: 0;      /* æ¸…é™¤é»˜è®¤å¤–è¾¹è· */
    width: 100%;    /* å¼ºåˆ¶å…¨å®½ */
    transform: none !important; /* ç§»é™¤ä»»ä½•å˜æ¢ */
}
    

        /* æ–°å¢è¾“å…¥æ¡†æ ·å¼ */
        .add-btn {
            position: fixed;
            z-index: 1000;
            bottom: 50px;
            right: 30px;
            width: 45px;
            height: 45px;
            background: #1d1d5c; /* åŠ å·é”®èƒŒæ™¯è‰² */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: #f7ebeb; /* åŠ å·é”®é¢œè‰² */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important; /* æ©™è‰²é˜´å½±æ•ˆæœ */
        }
        .edit-btn {
    position: fixed;
    z-index: 1000;
    bottom: 100px;  /* ä½äºæ·»åŠ æŒ‰é’®ä¸Šæ–¹ */
    right: 30px;
    width: 45px;
    height: 45px;
    background: #1d1d5c; /* ç¼–è¾‘é”®èƒŒæ™¯è‰² */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 24px;
    color: #f7ebeb;  /* ç¼–è¾‘é”®é¢œè‰² */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important; 
}
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ba5757;
            padding: 20px;
            border-radius: 10px;
            border: 0px solid #1d1d5c;
            width: 400px;
        }
   #content {
    width: 95%;
    height: 400px;
    background: transparent;
    border: none;
    outline: none;
    color: #f7ebeb; /* è¾“å…¥å­—è‰² */
    padding: 10px;
    margin-bottom: 10px;
    white-space: pre-wrap;
}
        .tag-manager {
        display: none;
        position: fixed;
        z-index: 999;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(186, 87, 87, 0.25);
        padding: 20px;
        border-radius: 10px;
        border: 0px solid #000000;
        max-width: 80%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .tag-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        margin: 5px 0;
        border-bottom: 1px solid #000000;
    }

    .tag-count {
        color: #f7ebeb; /* æ ‡ç­¾ä½¿ç”¨æ¬¡æ•°è‰² */
        font-size: 0.9em;
        margin-right: 10px;
    }

    .tag-actions {
        display: flex;
        gap: 5px;
    }
    .pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
   
}
.page-number {
    color: #ba5757; /* é¡µç è‰² */
    font-size: 12px;
    cursor: pointer;
    padding: 5px 10px;
}
.page-number.active {
    text-decoration: underline;
}
.post div {
    white-space: pre-wrap;
    word-wrap: break-word;
}
.youtube-container {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
}

.youtube-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}



.youtube-play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: transparent;
    border: none;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
    color: #f7ebeb;
    font-size: 24px;
    z-index: 1;
}



/* é’ˆå¯¹æœç´¢æ¡†çš„placeholder */
#searchInput::placeholder { /* ç°ä»£æµè§ˆå™¨ */
    color: #ba5757; /* ä½¿ç”¨ä¸æ ‡ç­¾ç›¸åŒçš„æš—çº¢è‰² */
    opacity: 0.4; /* ç¡®ä¿é¢œè‰²ä¸é€æ˜ */
}

#searchInput::-webkit-input-placeholder { /* Chrome/Safari */
    color: #ba5757;
}
#searchInput::-moz-placeholder { /* Firefox 19+ */
    color: #ba5757;
}
#searchInput:-ms-input-placeholder { /* IE 10+ */
    color: #ba5757;
}

/* é’ˆå¯¹æ¨¡æ€æ¡†è¾“å…¥åŒºçš„placeholder */
#content::placeholder {
    color: #1d1d5c;
    opacity: 0.4;
}
#content::-webkit-input-placeholder {
    color: #1d1d5c;
}
#content::-moz-placeholder {
    color: #1d1d5c;
}
#content:-ms-input-placeholder {
    color: #1d1d5c;
}
.bilibili-player-video-top,
.bilibili-player-video-info,
.bilibili-player-video-info-hover,
.bilibili-player-video-info-switch-btn,
.bilibili-player-video-info-container {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

/* é‡è®¾éŸ³é¢‘æ’­æ”¾å™¨æ•´ä½“æ ·å¼ */
audio::-webkit-media-controls-panel {
    background-color: rgba(30,30,92,0.9) !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    min-width: unset !important; /* ç§»é™¤å›ºå®šæœ€å°å®½åº¦ */
    width: 100% !important;      /* å¼ºåˆ¶å®½åº¦è‡ªé€‚åº” */
}

/* æ’­æ”¾æŒ‰é’®å’ŒéŸ³é‡æŒ‰é’®æ ·å¼ */
audio::-webkit-media-controls-play-button,
audio::-webkit-media-controls-mute-button {
    filter: invert(0.1);
    flex: 0 0 auto !important; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
}
.play-button {
    margin-right: 8px !important;
}

/* æ—¶é—´æ˜¾ç¤ºæ ·å¼ */
audio::-webkit-media-controls-current-time-display,
audio::-webkit-media-controls-time-remaining-display {
    color: #1b1b3d;
    font-size: 11px !important;
    padding: 0 0px !important;
    flex: 0 0 auto !important; /* é˜²æ­¢æ—¶é—´æ˜¾ç¤ºè¢«å‹ç¼© */
    min-width: 35px !important; /* ç¡®ä¿æ—¶é—´æ˜¾ç¤ºæœ‰è¶³å¤Ÿç©ºé—´ */
    text-align: center !important;
}

/* è¿›åº¦æ¡æ ·å¼ */
audio::-webkit-media-controls-timeline {
    height: 1px !important;
    flex: 1 1 100px !important; /* å…è®¸è¿›åº¦æ¡ä¼¸ç¼©ä½†ä¿æŒæœ€å°å®½åº¦ */
}
audio::-webkit-media-controls-timeline-container,
audio::-webkit-media-controls-current-time-display,
audio::-webkit-media-controls-time-remaining-display {
    flex: 1 !important; /* å…è®¸æ—¶é—´æ˜¾ç¤ºåŒºåŸŸä¼¸ç¼© */
}
.audio-container {
    width: 100% !important;
    max-width: 100% !important;
}
.custom-controls {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 1px !important; /* å¢åŠ å·¦å³é—´è· */
}
/* è¿›åº¦æ¡æ»‘å—æ ·å¼ */
audio::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    width: 2px !important;
    height: 2px !important;
    background: #ba5757 !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    margin-top: -2px !important;
}

/* Firefoxæµè§ˆå™¨è¿›åº¦æ¡æ»‘å—æ ·å¼ */
audio::-moz-range-thumb {
    width: 2px !important;
    height: 2px !important;
    background: #ba5757 !important;
    border-radius: 50% !important;
    cursor: pointer !important;
}
/* éŸ³é¢‘æ’­æ”¾å™¨è¿›åº¦æ¡æ ·å¼ */
input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 2px;
    background: #1d1d5c;
    border-radius: 1px;
    margin: 0 1px;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 4.5px;
    height: 4.5px;
    background: #626082;
    border-radius: 50%;
    cursor: pointer;
    margin-top: -1.5px;
}


input[type="range"]::-moz-range-thumb {
    width: 8px;
    height: 8px;
    background: #ba5757;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

input[type="range"]::-webkit-slider-runnable-track {
  height: 1px !important;
  background: rgba(141, 138, 186, 0.2)!important;
}

input[type="range"]::-moz-range-track {
  height: 1px !important;
  background: rgba(186, 87, 87, 0.2) !important;
}
blockquote {
    border-left: 1.5px solid #14143e;
    margin: 0.3em 0;  /* ç®€åŒ–ä¸Šä¸‹è¾¹è·çš„å†™æ³• */
    padding: 4px 8px 4px 8px;  /* ç§»é™¤å³å†…è¾¹è·ï¼Œåªä¿ç•™å·¦å†…è¾¹è· */
    color: #a8a8e4;
    background: rgba(24, 11, 36, 0.1);
    font-size: 9px;
    font-family: 'Arial, sans-serif';
    font-weight: 400;
    white-space: pre-wrap;
    line-height: 1.6;
    display: inline-block;
    width: 100%;
    box-sizing: border-box;
}

hr {
    border: 0;
    height: 0;
    border-top: 1px dashed rgba(168,168,228,0.3); /* å¤‡ç”¨è™šçº¿æ ·å¼ */
    margin: 5px 0;
}
/* ä¸‹åˆ’çº¿æ ·å¼ */
.underline-divider {
    border-bottom: 1px solid #a8a8e4;
    margin: 3px 0 !important;
    width: 100%;
}

/* å¼•ç”¨æ¡†å†…è¡¥å¿ */
/* å¼•ç”¨æ¡†å†…æ°´å¹³çº¿è¡¥å¿ */
blockquote hr.blockquote-divider {
    border: none;
    border-top: 1px dashed rgba(168, 168, 228, 0.3);
    margin: 5px -8px; /* æŠµæ¶ˆå¼•ç”¨æ¡†çš„å†…è¾¹è· */
    width: calc(100% + 16px); /* æ‰©å±•å®½åº¦ä»¥å¯¹é½è§†è§‰è¾¹ç¼˜ */
}

    </style>
</head>
<body>
	<div style="position:fixed;z-index: 999; bottom:50px; left:30px; display:flex; gap:10px;">
    <button onclick="exportPosts()" style="background:#1d1d5c; color:#f7ebeb; border:none; width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important;">â‡©</button>
    <input type="file" id="importFile" style="display:none" onchange="importPosts(this)">
    <button onclick="document.getElementById('importFile').click()" style="background:#1d1d5c; color:#f7ebeb; border:none; width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important;">â‡§</button>
</div>
  <!-- åŸä»£ç  -->
<div class="add-btn" onclick="toggleModal(false)">+</div>
<!-- æ–°å¢ç¼–è¾‘æŒ‰é’® -->
<div class="edit-btn" onclick="toggleEditMode()">âœ</div>
<button onclick="showTagManager()" style="position:fixed; z-index: 1000;bottom:150px; right:30px;border:none; width:45px; height:45px; background:#1d1d5c; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:24px; color:#f7ebeb;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important;">â™</button>

    <div class="modal">
    <textarea id="content" placeholder="è¾“å…¥å†…å®¹ã€åª’ä½“é“¾æ¥å’Œæ ‡ç­¾ï¼ˆç¤ºä¾‹ï¼‰ï¼š
ä»Šå¤©å‘ç°ä¸€ä¸ªå¥½è§†é¢‘
https://youtu.be/abc123
#éŸ³ä¹ #æ¨è
æœç´¢ï¼šç©ºæ ¼=ä¸ /æ–œæ =æˆ–  åŒæ˜Ÿå·æ˜¯ç²—ä½“
å•æ˜Ÿå·æ–œä½“
æµªå·æ˜¯åˆ é™¤
ä¸‰æ˜Ÿå·æ˜¯æ°´å¹³çº¿
å¤§äºå·æ˜¯å¼•ç”¨å†…å®¹"></textarea>
    <div style="display:flex;gap:10px;justify-content:center;">
        <button id="saveBtn" style="background:#f7ebeb;color:#1d1d5c;border:none;padding:8px 20px;border-radius:5px;">âœ”</button>
        
    </div>
</div>
<div class="tag-manager" id="tagManager">
    <h3 style="color:#e6d2f9;margin-bottom:20px;">æ ‡ç­¾ç®¡ç†</h3>
    <div id="tagList"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">
        <button onclick="cleanUnusedTags()" style="background:#f7ebeb;color:#1d1d5c;border:none;padding:8px 20px;border-radius:5px;">æ¸…ç†æœªä½¿ç”¨æ ‡ç­¾</button>
        <button onclick="document.getElementById('tagManager').style.display='none'" style="background:#f7ebeb;color:#1d1d5c;border:none;padding:8px 20px;border-radius:5px;">å…³é—­</button>
    </div>
</div>

    <div id="tagFilter" class="tag-filter"></div>
    <div class="search-box" style="position:fixed;bottom:100px;left:-40px;z-index:1000;display:flex;flex-direction:row-reverse;align-items:center;gap:5px;">
    <input type="text" id="searchInput" placeholder="â˜ƒâ˜‚â˜€" 
        style="padding:5px;border-radius:3px;border:none;background:transparent;color:#ba5757;width:50%;outline:none;">
    <button onclick="searchPosts()" 
        style="background:#1d1d5c;color:#f7ebeb;border:none;width:45px;height:45px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important;">
        â˜
    </button>
</div>
    <div id="postsContainer" class="posts-container"></div>

    <script>
    	// åŸä»£ç ç¬¬45è¡Œä¿®æ”¹ä¸º â–¼â–¼â–¼
document.addEventListener('DOMContentLoaded', () => {
    try {
        posts = [];
        allTags = new Set();
        const savedPosts = localStorage.getItem('posts');
        if (savedPosts) {
            posts = JSON.parse(savedPosts).map(p => ({ 
                ...p, 
                id: p.id || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                tags: p.tags || [],
                lastModified: p.lastModified || Date.now() // ä¸ºæ—§æ•°æ®æ·»åŠ æ—¶é—´æˆ³
            }))
// æ·»åŠ ä¸€æ¬¡æ€§æ´—ç‰Œï¼ˆFisher-Yatesç®—æ³•ï¼‰
.sort(() => Math.random() - 0.5); 
            const savedTags = localStorage.getItem('tags');
            allTags = new Set(savedTags ? JSON.parse(savedTags) : []);
        }
        renderTags();
        renderPosts(posts);
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        alert('æ•°æ®åŠ è½½å¼‚å¸¸ï¼Œå·²é‡ç½®');
        localStorage.clear();
        location.reload();
    }
});
        // ä¿æŒåŸæœ‰JavaScripté€»è¾‘ä¸å˜
        let posts = [];
        let allTags = new Set();
        let isEditMode = false;
        let currentFilterTag = null; // æ–°å¢å…¨å±€å˜é‡
        let currentSearchTerm = null; // ä¿å­˜å½“å‰æœç´¢è¯
        
        // â–¼â–¼â–¼ æ–°å¢çš„åˆ‡æ¢æ¨¡æ€æ¡†å‡½æ•° â–¼â–¼â–¼
function toggleModal(isEdit = false) {
    const modal = document.querySelector('.modal');
    if (modal.style.display === 'block') {
        modal.style.display = 'none';
        return;
    }

    // é‡ç½®æ¨¡æ€æ¡†ä¸ºåˆå§‹çŠ¶æ€
    modal.innerHTML = `
        <textarea id="content" placeholder="è¾“å…¥å†…å®¹ã€åª’ä½“é“¾æ¥å’Œæ ‡ç­¾ï¼ˆç¤ºä¾‹ï¼‰ï¼š
ä»Šå¤©å‘ç°ä¸€ä¸ªå¥½è§†é¢‘
https://youtu.be/abc123
#éŸ³ä¹ #æ¨è

æœç´¢ï¼šç©ºæ ¼=ä¸ /æ–œæ =æˆ–  åŒæ˜Ÿå·æ˜¯ç²—ä½“

*æ–œä½“*
**åŠ ç²—**
~åˆ é™¤çº¿~
***æ˜¯æ°´å¹³çº¿
> æ˜¯å¼•ç”¨å†…å®¹"></textarea>
        <div style="display:flex;justify-content:center;">
            <button id="saveBtn" style="background:#f7ebeb;color:#1d1d5c;border:none;padding:8px 20px;border-radius:5px;">âœ”</button>
        </div>
    `;

    const saveBtn = modal.querySelector('#saveBtn');
    
    if (!isEdit) {
        saveBtn.onclick = addPost;
    }

    modal.style.display = 'block';
}
// â–²â–²â–² æ–°å¢çš„åˆ‡æ¢æ¨¡æ€æ¡†å‡½æ•° â–²â–²â–²

        function detectMediaType(url) {
        	const originalUrl = url;
        
        // åœ¨ detectMediaType å‡½æ•°çš„éŸ³é¢‘æ£€æµ‹é€»è¾‘ä¸­æ·»åŠ  â–¼â–¼â–¼
   const audioRegex = /(?:https?:\/\/.*archive\.org\/.*\.mp3|\.mp3)(?:\?.*)?$/i;
   if (audioRegex.test(url)) {
       return {
           type: 'audio',
           url: url,       // ç›´æ¥ä½¿ç”¨åŸå§‹é“¾æ¥ï¼ˆæ— éœ€å¤„ç†ï¼‰
           original: url   // æ˜ç¡®ä¿å­˜åŸå§‹é“¾æ¥
       };
   }
    
    // Bç«™æ£€æµ‹
    const bilibiliRegex = /(?:https?:\/\/)?(?:www\.)?bilibili\.com\/video\/(BV\w+)(\/|\?|&|$)/i;
    const bilibiliMatch = originalUrl.match(bilibiliRegex);
    if (bilibiliMatch) {
        return {
            type: 'bilibili',
            url: `https://player.bilibili.com/player.html?bvid=${bilibiliMatch[1]}&page=1`,
            original: originalUrl // å­˜å‚¨åŸå§‹é“¾æ¥
        };
    }

	// æ£€æµ‹ MP4 è§†é¢‘ç›´é“¾
const mp4Regex = /https?:\/\/.+\.mp4(\?.+)?$/i;
    if (mp4Regex.test(url)) {
        return {
            type: 'video', // æ–°å¢ç±»å‹
            url: url,
            original: url
        };
    }	
		
    // OK.ruæ£€æµ‹
// ä¿®æ”¹detectMediaTypeå‡½æ•°ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼
const okruRegex = /(?:https?:\/\/)?(?:www\.)?ok\.ru\/video\/(\d+)(?:\/|\?|&|$)/i;
    const okruMatch = originalUrl.match(okruRegex);
    if (okruMatch) {
        return {
            type: 'okru',
            url: `https://ok.ru/videoembed/${okruMatch[1]}`,
            original: originalUrl // å­˜å‚¨åŸå§‹é“¾æ¥
        };
    }
            // åŸæœ‰åª’ä½“æ£€æµ‹é€»è¾‘
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
    return { 
        type: 'youtube', 
        url: `https://www.youtube-nocookie.com/embed/${youtubeMatch[1]}` 
    };
}

            const imgurRegex = /https?:\/\/(?:i\.)?imgur\.com\/(\w+)(\.\w+)?/;
            const imgurMatch = url.match(imgurRegex);
            if (imgurMatch) {
                return { 
                    type: 'image', 
                    url: `https://i.imgur.com/${imgurMatch[1]}${imgurMatch[2] || '.jpg'}` 
                };
            }

            if (/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(url)) {
                return { type: 'image', url: url };
            }

            return null;
        }

        function parseInput(input) {
    const lines = input.split('\n');
    const media = [];
    const tags = [];
    const contentLines = [];

    lines.forEach(originalLine => {
        // æ”¹ä¸ºæ›´ç²¾ç¡®çš„æ®µè½ä¿ç•™é€»è¾‘
        const preservedLine = originalLine
            .replace(/(#\w+)/g, 'SPLIT_MARKER$1SPLIT_MARKER') // æ ‡è®°æ ‡ç­¾
            .replace(/(https?:\/\/\S+)/gi, 'SPLIT_MARKER$1SPLIT_MARKER') // æ ‡è®°é“¾æ¥
            .split('SPLIT_MARKER');

        let lineContent = '';
        preservedLine.forEach(segment => {
            if (!segment) return;
            
            // æ£€æµ‹åª’ä½“é“¾æ¥
            const mediaType = detectMediaType(segment);
            if (mediaType) {
                media.push(mediaType);
                return;
            }

            // æ£€æµ‹æ ‡ç­¾
            if (segment.startsWith('#')) {
                tags.push(segment.slice(1));
                return;
            }

            // ä¿ç•™åŸå§‹å†…å®¹ï¼ˆåŒ…å«ç©ºæ ¼ï¼‰
            lineContent += segment;
        });
        
        contentLines.push(lineContent); // ä¿ç•™åŸå§‹æ¢è¡Œå’Œç©ºæ ¼
    });

    return {
        content: contentLines.join('\n').replace(/\n+$/,''),
        media,
        tags
    };
}

        function addPost() {
    const modal = document.querySelector('.modal');
    const textarea = modal.querySelector('#content');
    const input = textarea.value;
    
    const { content, media, tags } = parseInput(input);
    
    tags.forEach(tag => allTags.add(tag));
    posts.unshift({ 
        id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        content, 
        media, 
        tags,
        lastModified: Date.now() // æ·»åŠ åˆ›å»ºæ—¶é—´æˆ³ 
    });

    if (saveToLocalStorage()) {
        renderTags();
        renderPosts(posts);
        modal.style.display = 'none';
        textarea.value = '';
    } else {
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

        function renderTags() {
    const tagContainer = document.getElementById('tagFilter');
    tagContainer.innerHTML = '<div class="tag" onclick="renderPosts(posts); currentFilterTag = null">å…¨éƒ¨</div>';
    
    allTags.forEach(tag => {
        const tagElement = document.createElement('div');
        tagElement.className = 'tag' + (currentFilterTag === tag ? ' active' : '');
        tagElement.textContent = tag;
        tagElement.onclick = () => {
            currentFilterTag = tag; // æ›´æ–°å½“å‰é€‰ä¸­æ ‡ç­¾
            renderPosts(posts.filter(p => p.tags.includes(tag)));
        };
        tagContainer.appendChild(tagElement);
    });
}

        function renderPosts(postsToRender) {
if (!postsToRender) {
    if (currentSearchTerm) {
        postsToRender = posts.filter(p => 
            p.content.toLowerCase().includes(currentSearchTerm) || 
            p.tags.some(t => t.toLowerCase().includes(currentSearchTerm))
        );
    } else if (currentFilterTag) {
        postsToRender = posts.filter(p => p.tags.includes(currentFilterTag));
    } else {
        postsToRender = posts;
    }
}
        	// åœ¨renderPostså‡½æ•°é¡¶éƒ¨æ·»åŠ (çº¦ç¬¬189è¡Œ)
if (!postsToRender) postsToRender = posts; // ç¡®ä¿æœ‰é»˜è®¤å€¼
// ä¿å­˜æ’­æ”¾çŠ¶æ€
const mediaStates = {};
document.querySelectorAll('.post-media audio, .post-media video').forEach(media => {
    const postId = media.closest('.post').dataset.id;
    mediaStates[postId] = {
        time: media.currentTime,
        playing: !media.paused
    };
});

    const container = document.getElementById('postsContainer');
    const postsPerPage = 50;
const totalPages = Math.ceil(postsToRender.length / postsPerPage);
if (!window.currentPage) window.currentPage = 1;
const startIndex = (window.currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const currentPosts = postsToRender.slice(startIndex, endIndex);

// è·å–ç°æœ‰å¸–å­
        const existingPosts = document.querySelectorAll('.post');
        const existingPostIds = new Set(Array.from(existingPosts).map(post => post.dataset.id));

        // ç§»é™¤ä¸å†éœ€è¦çš„å¸–å­ï¼ˆä¿ç•™æ’­æ”¾ä¸­æˆ–åŒ…å« iframe çš„å¸–å­ï¼‰
        existingPosts.forEach(postElement => {
            const postId = postElement.dataset.id;
            const isInCurrentPage = currentPosts.some(p => p.id === postId);
            const isPlaying = mediaStates[postId]?.playing;
            const hasIframe = mediaStates[postId]?.iframe;
            if (!isInCurrentPage && !isPlaying && !hasIframe) {
                postElement.remove();
            }
        });
    // æ¸²æŸ“å¸–å­
    currentPosts.forEach(post => {
    	// è·³è¿‡å·²å­˜åœ¨çš„å¸–å­
if (document.querySelector(`.post[data-id="${post.id}"]`)) return;
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.dataset.id = post.id;  // ç»™æ¯ä¸ªå¸–å­è´´ä¸ªæ¡å½¢ç 
        const actions = document.createElement('div');
        actions.className = 'post-actions';
        actions.innerHTML = `
    <button onclick="if(confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¸–å­å—ï¼Ÿ')) deletePost('${post.id}')">Ã—</button>
    <button onclick="editPost('${post.id}')">âœ</button>
`;
        postElement.appendChild(actions);
        if (post.content) {
    const contentDiv = document.createElement('pre');
    contentDiv.style.whiteSpace = 'pre-wrap';
    contentDiv.style.wordWrap = 'break-word';
    contentDiv.style.margin = '0';
    contentDiv.style.fontFamily = 'inherit';
    contentDiv.innerHTML = post.content
    // æ–°å¢ç²—ä½“æ”¯æŒï¼ˆ**æˆ–__åŒ…è£¹ï¼‰
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/__([^_]+)__/g, '<strong>$1</strong>')
    // åŸæœ‰æ–œä½“æ”¯æŒ
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/_([^_]+)_/g, '<em>$1</em>')
    // åŸæœ‰åˆ é™¤çº¿
    .replace(/~([^~]+)~/g, '<del>$1</del>')
    // å¤„ç†å¼•ç”¨æ¡†å†…çš„æ°´å¹³çº¿ï¼ˆ>***ï¼‰
// ä¿®æ”¹åçš„å¼•ç”¨å¤„ç†é€»è¾‘
.replace(/(^>.*(\n>.*)*)/gm, (match) => {
    // å¤„ç†å¼•ç”¨å—å†…çš„æ°´å¹³çº¿å¹¶ä¿ç•™æ¢è¡Œ
    const processedContent = match
        .replace(/^>\s*\*{3,}\s*$/gm, '<hr class="blockquote-divider">') // è½¬æ¢æ°´å¹³çº¿
        .replace(/^>\s*/gm, '') // ç§»é™¤æ¯è¡Œå¼€å¤´çš„>å’Œç©ºæ ¼
        .replace(/\n/g, '<br>'); // ä¿ç•™æ¢è¡Œç¬¦

    return `<blockquote>${processedContent}</blockquote>`;
})
    // æ–°å¢å¼•ç”¨ï¼ˆ>å¼€å¤´è¡Œï¼‰
.replace(/(^>.*(\n>.*)*)/gm, (match) => {
        // ç§»é™¤æ¯è¡Œå¼€å¤´çš„>å’Œç©ºæ ¼ï¼Œåˆå¹¶å†…å®¹
        const content = match.replace(/^>\s*/gm, '');
        return `<blockquote>${content}</blockquote>`;
    });
    postElement.appendChild(contentDiv);
}
        
        if (post.media.length) {
            const mediaContainer = document.createElement('div');
            mediaContainer.className = 'post-media';
            
            post.media.forEach(media => {
   if (media.type === 'okru') {
    mediaContainer.style.margin = '0';
    mediaContainer.style.display = 'block'; // æ·»åŠ è¿™è¡Œ
    mediaContainer.style.lineHeight = '0'; // æ·»åŠ è¿™è¡Œï¼Œæ¶ˆé™¤è¡Œé«˜é€ æˆçš„ç©ºéš™

    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.aspectRatio = '4/3';
    container.style.cursor = 'pointer';
    container.style.backgroundColor = '#1d1d5c';
    container.style.overflow = 'hidden'; // éšè—æº¢å‡ºéƒ¨åˆ†
    
    // ä»å¸–å­å†…å®¹ä¸­æå–å¤šä¸ªæµ·æŠ¥URL
    const postContent = post.content;
    const posterMatches = [...postContent.matchAll(/<!--\s*poster="([^"]+)"\s*-->/g)];
    
    if (posterMatches.length > 0) {
        const posterUrls = posterMatches.map(match => match[1]);
        
        // åˆ›å»ºæ»‘åŠ¨å®¹å™¨
        const slideContainer = document.createElement('div');
        slideContainer.style.position = 'absolute';
        slideContainer.style.top = '0';
        slideContainer.style.left = '0';
        slideContainer.style.width = `${posterUrls.length * 100}%`; // æ€»å®½åº¦ä¸ºæ‰€æœ‰å›¾ç‰‡å®½åº¦ä¹‹å’Œ
        slideContainer.style.height = '100%';
        slideContainer.style.display = 'flex';
        slideContainer.style.transition = 'transform 0.2s ease'; // å¿«é€Ÿæ»‘åŠ¨æ•ˆæœ
        
        // åˆ›å»ºæ‰€æœ‰å›¾ç‰‡
        posterUrls.forEach(url => {
            const imageWrapper = document.createElement('div');
            imageWrapper.style.width = `${100 / posterUrls.length}%`; // æ¯å¼ å›¾ç‰‡å æ€»å®½åº¦çš„ç›¸ç­‰ä»½é¢
            imageWrapper.style.height = '100%';
            
            const thumbnail = document.createElement('img');
            thumbnail.style.width = '100%';
            thumbnail.style.height = '100%';
            thumbnail.style.objectFit = 'cover';
            thumbnail.src = url;
            
            imageWrapper.appendChild(thumbnail);
            slideContainer.appendChild(imageWrapper);
        });
        
        container.appendChild(slideContainer);
        
        // åˆ›å»ºåŠé€æ˜é®ç½©
        const overlay = document.createElement('div');
        overlay.style.position = 'absolute';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0, 0, 0, 0.2)';
        overlay.style.zIndex = '1';
        container.appendChild(overlay);
        
        // åˆ›å»ºæ’­æ”¾æŒ‰é’®
        const playButton = document.createElement('div');
        playButton.style.position = 'absolute';
        playButton.style.top = '50%';
        playButton.style.left = '50%';
        playButton.style.transform = 'translate(-50%, -50%)';
        playButton.style.width = '60px';
        playButton.style.height = '60px';
        playButton.style.display = 'flex';
        playButton.style.alignItems = 'center';
        playButton.style.justifyContent = 'center';
        playButton.style.zIndex = '2';
        
        // åˆ›å»ºæ’­æ”¾å›¾æ ‡
        const playIcon = document.createElement('div');
        playIcon.style.width = '0';
        playIcon.style.height = '0';
        playIcon.style.borderStyle = 'solid';
        playIcon.style.borderWidth = '10px 0 10px 18px';
        playIcon.style.borderColor = 'transparent transparent transparent rgba(255, 255, 255, 0.3)';
        playIcon.style.marginLeft = '5px';
        
        playButton.appendChild(playIcon);
        container.appendChild(playButton);

        // å¦‚æœæœ‰å¤šä¸ªæµ·æŠ¥ï¼Œæ·»åŠ è‡ªåŠ¨è½®æ’­
        if (posterUrls.length > 1) {
            let currentIndex = 0;
            
            // åˆ‡æ¢å‡½æ•°
            const switchPoster = () => {
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * posterUrls.length);
    } while (newIndex === currentIndex && posterUrls.length > 1);
    
    currentIndex = newIndex;
    slideContainer.style.transform = `translateX(-${(100 / posterUrls.length) * currentIndex}%)`;
};

            // è‡ªåŠ¨è½®æ’­ï¼Œ10ç§’åˆ‡æ¢ä¸€æ¬¡
            setInterval(switchPoster, 10000);
        }
        
        // ç‚¹å‡»æ’­æ”¾è§†é¢‘
        container.onclick = () => {
            const iframe = document.createElement('iframe');
            const videoId = media.url.split('/videoembed/')[1];
            
            const wrapperDiv = document.createElement('div');
            wrapperDiv.style.position = 'relative';
            wrapperDiv.style.width = '100%';
            wrapperDiv.style.aspectRatio = '4/3';
            wrapperDiv.style.overflow = 'hidden';
            
            iframe.src = `https://ok.ru/videoembed/${videoId}?autoplay=1`;
            iframe.style.position = 'absolute';
            iframe.style.top = '50%';
            iframe.style.left = '50%';
            iframe.style.width = '133.33%';
            iframe.style.height = '100%';
            iframe.style.transform = 'translate(-50%, -50%)';
            iframe.style.border = 'none';
            iframe.setAttribute('allowfullscreen', '');
            iframe.setAttribute('allow', 'autoplay');
            
            wrapperDiv.appendChild(iframe);
            container.innerHTML = '';
            container.appendChild(wrapperDiv);
        };
        
    } else {
        // å¦‚æœæ²¡æœ‰æµ·æŠ¥ï¼Œä½¿ç”¨é»˜è®¤iframe
        const iframe = document.createElement('iframe');
        const videoId = media.url.split('/videoembed/')[1];
        
        iframe.src = `https://ok.ru/videoembed/${videoId}`;
        iframe.style.position = 'absolute';
        iframe.style.top = '0';
        iframe.style.left = '0';
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.setAttribute('allowfullscreen', '');
        
        container.appendChild(iframe);
    }
    
    mediaContainer.appendChild(container);
}
		    if (media.type === 'video') { // æ£€æµ‹è§†é¢‘ç±»å‹
                    const container = document.createElement('div');
                    container.style.position = 'relative';
                    container.style.width = '100%';
                    container.style.aspectRatio = '16/9'; // 16:9æ¯”ä¾‹
                    container.style.overflow = 'hidden';

                    const video = document.createElement('video');
                    video.dataset.mediaId = post.id;
                    video.src = media.url;
                    video.controls = true; // æ·»åŠ æ§åˆ¶æŒ‰é’®
                    video.style.width = '100%'; // è®¾ç½®ä¸º100%å®½åº¦
                    video.style.height = '100%'; // è®¾ç½®ä¸º100%é«˜åº¦
                    video.setAttribute('allowfullscreen', ''); // å…è®¸å…¨å±

                    container.appendChild(video);
                    mediaContainer.appendChild(container);
		    }
                if (media.type === 'image') {
    // æŸ¥æ‰¾æˆ–åˆ›å»ºä¸“é—¨çš„å›¾ç‰‡è½®æ’­å®¹å™¨
    let imageSlideContainer = mediaContainer.querySelector('.image-slide-container');
    if (!imageSlideContainer) {
        imageSlideContainer = document.createElement('div');
        imageSlideContainer.className = 'image-slide-container';
        imageSlideContainer.style.position = 'relative';
        imageSlideContainer.style.width = '100%';
        imageSlideContainer.style.overflow = 'hidden';
        
        // åˆ›å»ºå›¾ç‰‡åŒ…è£…å™¨
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.transition = 'transform 0.5s ease';
        wrapper.style.width = '100%';
        
        imageSlideContainer.appendChild(wrapper);
        mediaContainer.appendChild(imageSlideContainer);
    }
    
    const wrapper = imageSlideContainer.querySelector('div');
    
    // åˆ›å»ºå›¾ç‰‡å®¹å™¨
    const imgContainer = document.createElement('div');
    imgContainer.style.flex = '0 0 100%';
    imgContainer.style.width = '100%';
    
    // æ·»åŠ å›¾ç‰‡
    const img = document.createElement('img');
    img.src = media.url;
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    
    imgContainer.appendChild(img);
    wrapper.appendChild(imgContainer);
}

// åœ¨å¤„ç†å®Œæ‰€æœ‰åª’ä½“åè®¾ç½®è½®æ’­
const imageCount = post.media.filter(m => m.type === 'image').length;
if (imageCount > 1) {
    const imageSlideContainer = mediaContainer.querySelector('.image-slide-container');
    if (imageSlideContainer) {
        const wrapper = imageSlideContainer.querySelector('div');
        
        // æ·»åŠ éšæœºåˆå§‹é¡µ
        const initialSlide = Math.floor(Math.random() * imageCount);
        let currentSlide = initialSlide;
        
        // è®¾ç½®åˆå§‹ä½ç½®
        wrapper.style.transform = `translateX(-${initialSlide * 100}%)`;
        
        // è‡ªåŠ¨è½®æ’­å‡½æ•°
        function autoSlide() {
            currentSlide = (currentSlide + 1) % imageCount;
            wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        }
        
        // è®¾ç½®20ç§’è½®æ’­é—´éš”
        setInterval(autoSlide, 50000);
    }
}
                
       if (media.type === 'audio') {
    const audioContainer = document.createElement('div');
    audioContainer.style.position = 'relative';
    audioContainer.style.width = '100%';
    audioContainer.style.height = '30px';
    audioContainer.style.display = 'flex';
    audioContainer.style.alignItems = 'center';
    audioContainer.style.gap = '0'; // å‡å°‘æ§ä»¶é—´è·
    audioContainer.style.padding = '0'; // å‡å°‘å†…è¾¹è·
    audioContainer.style.margin = '0'; // ç§»é™¤å¤–è¾¹è·

    const audio = document.createElement('audio');
    audio.preload = 'metadata';
    audio.src = media.url;
    audio.dataset.mediaId = post.id

    // è‡ªå®šä¹‰æ§ä»¶å®¹å™¨
    const customControls = document.createElement('div');
    customControls.style.width = '100%';
    customControls.style.height = '30px';
    customControls.style.display = 'flex';
    customControls.style.alignItems = 'center';
    customControls.style.backgroundColor = 'rgba(84,84,133,0)';
    customControls.style.borderRadius = '5px';
    customControls.style.gap = '0'; // å‡å°‘æ§ä»¶é—´è·
    customControls.style.padding = '0'; // ç§»é™¤å†…è¾¹è·
    customControls.style.margin = '0'; // ç§»é™¤å¤–è¾¹è·

    // æ’­æ”¾/æš‚åœæŒ‰é’®
    const playButton = document.createElement('button');
    playButton.innerHTML = 'â–¶';
    playButton.style.backgroundColor = 'transparent';
    playButton.style.border = 'none';
    playButton.style.color = '#8d8aba';
    playButton.style.cursor = 'pointer';
    playButton.style.padding = '0';
    playButton.style.margin = '0';
    playButton.style.width = '20px'; // å›ºå®šå®½åº¦
    playButton.style.height = '20px';
    playButton.style.display = 'flex';
    playButton.style.alignItems = 'center';
    playButton.style.justifyContent = 'center';

    // è¿›åº¦æ¡
    const progressBar = document.createElement('input');
    progressBar.type = 'range';
    progressBar.value = 0;
    progressBar.min = 0;
    progressBar.max = 100;
    progressBar.step = 0.1;
    progressBar.style.flex = '1';
    progressBar.style.margin = '0 5px'; // å‡å°‘è¿›åº¦æ¡è¾¹è·
    progressBar.style.padding = '0'; // ç§»é™¤å†…è¾¹è·

    // æ—¶é—´æ˜¾ç¤º
    const timeDisplay = document.createElement('span');
    timeDisplay.style.fontFamily = 'Arial, sans-serif';
    timeDisplay.style.color = 'rgba(141, 138, 186, 0.7)';
    timeDisplay.style.fontSize = '9px';
    timeDisplay.style.whiteSpace = 'nowrap';
    timeDisplay.style.minWidth = '60px'; // å‡å°‘æœ€å°å®½åº¦
    timeDisplay.style.display = 'inline-block';
    timeDisplay.style.textAlign = 'right';
    timeDisplay.style.flexShrink = '0';
    timeDisplay.style.padding = '0 2px'; // å‡å°‘å†…è¾¹è·
    timeDisplay.style.marginLeft = '0'; // ç§»é™¤å·¦è¾¹è·

    // åˆå§‹è®¾ç½®ä¸º0:00 / 0:00
    timeDisplay.textContent = '0:00-0:00';

    // æ·»åŠ å…ƒæ•°æ®åŠ è½½äº‹ä»¶
    audio.addEventListener('loadedmetadata', () => {
        const totalMinutes = Math.floor(audio.duration / 60);
        const totalSeconds = Math.floor(audio.duration % 60);
        timeDisplay.textContent = `0:00-${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
    });

    // æ’­æ”¾/æš‚åœé€»è¾‘
    playButton.onclick = () => {
        if (audio.paused) {
            audio.play();
            playButton.innerHTML = 'âšâš';
        } else {
            audio.pause();
            playButton.innerHTML = 'â–¶';
        }
    };

    // æ›´æ–°è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
    audio.addEventListener('timeupdate', () => {
        const percentage = (audio.currentTime / audio.duration) * 100;
        progressBar.value = percentage;
        
        const currentMinutes = Math.floor(audio.currentTime / 60);
        const currentSeconds = Math.floor(audio.currentTime % 60);
        const totalMinutes = Math.floor(audio.duration / 60);
        const totalSeconds = Math.floor(audio.duration % 60);
        
        timeDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}-${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
    });

    // æ‹–åŠ¨è¿›åº¦æ¡è°ƒæ•´æ’­æ”¾ä½ç½®
    progressBar.addEventListener('input', () => {
        const time = (progressBar.value / 100) * audio.duration;
        audio.currentTime = time;
    });

    // ç»„è£…æ§ä»¶
    customControls.appendChild(playButton);
    customControls.appendChild(progressBar);
    customControls.appendChild(timeDisplay);
    
    audioContainer.appendChild(audio);
    audioContainer.appendChild(customControls);
    mediaContainer.appendChild(audioContainer);
}



                
             if (media.type === 'bilibili') {
    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.aspectRatio = '4/3';
    container.style.overflow = 'hidden';
    
    const iframe = document.createElement('iframe');
    iframe.src = `${media.url}&high_quality=1&quality=4&qn=112&autoplay=0&danmaku=0`;
    iframe.dataset.mediaId = post.id;
    iframe.style.position = 'absolute';
    iframe.style.top = '50%';
    iframe.style.left = '50%';
    iframe.style.width = '133.33%';
    iframe.style.height = '100%';
    iframe.style.transform = 'translate(-50%, -50%)';
    iframe.style.border = 'none';
    iframe.setAttribute('allowfullscreen', 'true');
    
    // æ·»åŠ æ ·å¼æ¥éšè—å³ä¸Šè§’æç¤º
    const style = document.createElement('style');
    style.textContent = `
        .bilibili-player-video-top,
        .bilibili-player-video-info,
        .bilibili-player-video-info-hover,
        .bilibili-player-video-info-switch-btn,
        .bilibili-player-video-info-container {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
    `;
    container.appendChild(style);
    container.appendChild(iframe);
    mediaContainer.appendChild(container);
}

              
if (media.type === 'youtube') {
    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.cursor = 'pointer';
    container.style.backgroundColor = 'transparent';
    
    // åˆ›å»ºç¼©ç•¥å›¾
    const thumbnail = document.createElement('img');
    const videoId = media.url.split('/').pop();
    thumbnail.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    thumbnail.style.width = '100%';
    thumbnail.style.display = 'block';
    
    
    // æ·»åŠ æ’­æ”¾å›¾æ ‡
    const playIcon = document.createElement('div');
    playIcon.style.position = 'absolute';
    playIcon.style.bottom = '15px';
    playIcon.style.right = '15px';
    playIcon.style.width = '0';
    playIcon.style.height = '0';
    playIcon.style.borderTop = '8px solid transparent';
    playIcon.style.borderBottom = '8px solid transparent';
    playIcon.style.borderLeft = '12px solid rgba(255, 255, 255, 0.2)';
    
    // ç‚¹å‡»æ—¶æ›¿æ¢ä¸ºiframe
    container.onclick = () => {
    const iframe = document.createElement('iframe');
    const videoId = media.url.match(/(?:\/|v=)([a-zA-Z0-9_-]{11})/)[1];
    
    // åˆ›å»ºä¸€ä¸ªæ–°çš„åŒ…è£…å®¹å™¨
    const wrapperDiv = document.createElement('div');
    wrapperDiv.style.position = 'relative';
    wrapperDiv.style.width = '100%';
    wrapperDiv.style.aspectRatio = '4/3'; // è®¾ç½®4:3çš„å®¹å™¨æ¯”ä¾‹
    wrapperDiv.style.overflow = 'hidden'; // ç¡®ä¿è¶…å‡ºéƒ¨åˆ†è¢«è£å‰ª
    
    // è®¾ç½®iframeæ ·å¼
    iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1`;
    iframe.style.position = 'absolute';
    iframe.style.top = '50%';
    iframe.style.left = '50%';
    iframe.style.width = '133.33%'; // 4:3å®¹å™¨ä¸­æ˜¾ç¤º16:9å†…å®¹éœ€è¦çš„å®½åº¦
    iframe.style.height = '100%';
    iframe.style.transform = 'translate(-50%, -50%)'; // å±…ä¸­
    iframe.style.border = 'none';
    iframe.setAttribute('allowfullscreen', '');
    iframe.setAttribute('allow', 'autoplay');
    
    // å°†iframeæ·»åŠ åˆ°åŒ…è£…å®¹å™¨ä¸­
    wrapperDiv.appendChild(iframe);
    
    // æ¸…ç©ºåŸå®¹å™¨å¹¶æ·»åŠ æ–°çš„åŒ…è£…å®¹å™¨
    container.innerHTML = '';
    container.appendChild(wrapperDiv);
    };
    
    container.appendChild(thumbnail);
    container.appendChild(playIcon);
    mediaContainer.appendChild(container);
}
            });
            
            postElement.appendChild(mediaContainer);
        }
        
 
        
        container.appendChild(postElement);
    });
    // æ¢å¤æ’­æ”¾çŠ¶æ€
document.querySelectorAll('.post-media audio, .post-media video').forEach(media => {
    const postId = media.closest('.post').dataset.id;
    const state = mediaStates[postId];
    if (state) {
        media.currentTime = state.time;
        if (state.playing) media.play();
    }
});

    // åˆ›å»ºåˆ†é¡µ
    const pagination = document.createElement('div');
    pagination.className = 'pagination';
    
    // ç”Ÿæˆé¡µç 
    let pageNumbers = [];
    if (totalPages <= 7) {
        pageNumbers = Array.from({length: totalPages}, (_, i) => i + 1);
    } else {
        if (window.currentPage <= 3) {
            pageNumbers = [1, 2, 3, 4, '...', totalPages];
        } else if (window.currentPage >= totalPages - 2) {
            pageNumbers = [1, '...', totalPages-3, totalPages-2, totalPages-1, totalPages];
        } else {
            pageNumbers = [1, '...', window.currentPage-1, window.currentPage, window.currentPage+1, '...', totalPages];
        }
    }

    pageNumbers.forEach(num => {
        const pageElement = document.createElement('span');
        pageElement.className = 'page-number';
        if (num === '...') {
            pageElement.textContent = '...';
        } else {
            pageElement.textContent = num;
            if (num === window.currentPage) {
                pageElement.classList.add('active');
            }
            pageElement.onclick = () => {
                window.currentPage = num;
                renderPosts(postsToRender);
                document.documentElement.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
            };
        }
        pagination.appendChild(pageElement);
    });

    // æ”¹å›æ’å…¥åˆ°å®¹å™¨å†…
container.appendChild(pagination);
renderTags(); // ç¡®ä¿åˆ‡æ¢åˆ†é¡µæ—¶æ ‡ç­¾çŠ¶æ€åŒæ­¥
}
        
       // æ–°å¢ç¼–è¾‘æ¨¡å¼åˆ‡æ¢å‡½æ•°
function toggleEditMode() {
    isEditMode = !isEditMode;
    document.body.classList.toggle('edit-mode');
    // æ ¹æ®å½“å‰çŠ¶æ€é‡æ–°æ¸²æŸ“ â–¼â–¼â–¼
    if (currentSearchTerm) {
        searchPosts();
    } else if (currentFilterTag) {
        renderPosts(posts.filter(p => p.tags.includes(currentFilterTag)));
    } else {
        renderPosts(posts);
    }
}

// æ–°å¢åˆ é™¤åŠŸèƒ½
function deletePost(postId) {
    posts = posts.filter(p => p.id !== postId);
    if (saveToLocalStorage()) {  // æ›¿æ¢åŸæ¥çš„localStorage.setItem
        renderPosts(posts);
    } else {
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
    window.currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
       renderPosts(posts);
}

// æ–°å¢ç¼–è¾‘åŠŸèƒ½
function editPost(postId) {
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    toggleModal(true); // ä»¥ç¼–è¾‘æ¨¡å¼æ‰“å¼€æ¨¡æ€æ¡†
    
    const modal = document.querySelector('.modal');
    const textarea = modal.querySelector('#content');
    const saveBtn = modal.querySelector('#saveBtn');

    // å¡«å……å†…å®¹
    const mediaUrls = post.media.map(m => {
    // ä¼˜å…ˆä½¿ç”¨å­˜å‚¨çš„åŸå§‹é“¾æ¥
    if (m.original) return m.original;
    
    // å…¼å®¹æ—§æ•°æ®ï¼ˆæ²¡æœ‰originalå­—æ®µæ—¶ï¼‰
    if (m.type === 'youtube') {
        const videoId = m.url.split('/').pop().split('?')[0];
        return `https://youtu.be/${videoId}`;
    } else if (m.type === 'bilibili') {
        const bvid = new URL(m.url).searchParams.get('bvid');
        return `https://www.bilibili.com/video/${bvid}/`;
    } else if (m.type === 'okru') {
        const videoId = m.url.split('/videoembed/')[1];
        return `https://ok.ru/video/${videoId}`;
    }
    return m.url;
});
    
    textarea.value = [
    post.content,
    ...mediaUrls, // ä½¿ç”¨å¤„ç†åçš„é“¾æ¥
    ...post.tags.map(t => `#${t}`)
].join('\n');

// ä¿®æ”¹ä¿å­˜æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†é€»è¾‘ â–¼â–¼â–¼
saveBtn.onclick = () => {
    const { content, media, tags } = parseInput(textarea.value);
    Object.assign(post, { 
        content, 
        media, 
        tags,
       id: postId,
        lastModified: Date.now() // æ›´æ–°ä¿®æ”¹æ—¶é—´æˆ³
    });
    if (saveToLocalStorage()) {
        // æ ¹æ®å½“å‰çŠ¶æ€é‡æ–°æ¸²æŸ“
        if (currentSearchTerm) {
            searchPosts(); // ä¸»åŠ¨è§¦å‘æœç´¢åˆ·æ–°
        } else if (currentFilterTag) {
            renderPosts(posts.filter(p => p.tags.includes(currentFilterTag)));
        } else {
            renderPosts(posts);
        }
        modal.style.display = 'none';
    } else {
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
};
}
  

// åœ¨ç°æœ‰JavaScriptä»£ç æœ«å°¾æ·»åŠ ä»¥ä¸‹å‡½æ•°
function showTagManager() {
    const tagManager = document.getElementById('tagManager');
    const tagList = document.getElementById('tagList');
    tagList.innerHTML = '';
    
    // è·å–æ¯ä¸ªæ ‡ç­¾çš„ä½¿ç”¨æ¬¡æ•°
    const tagCounts = {};
    Array.from(allTags).forEach(tag => {
        tagCounts[tag] = posts.filter(post => post.tags.includes(tag)).length;
    });
    
    // æ˜¾ç¤ºæ ‡ç­¾åˆ—è¡¨
    Array.from(allTags).sort().forEach(tag => {
        const tagItem = document.createElement('div');
        tagItem.className = 'tag-item';
        tagItem.innerHTML = `
            <span>${tag}</span>
            <div style="display:flex;align-items:center;">
                <span class="tag-count">ä½¿ç”¨æ¬¡æ•°: ${tagCounts[tag]}</span>
                <div class="tag-actions">
                    <button onclick="renameTag('${tag}')" style="background:#f7ebeb;color:#1d1d5c;border:none;padding:4px 8px;border-radius:3px;">é‡å‘½å</button>
                    <button onclick="deleteTag('${tag}')" style="background:#f7ebeb;color:#1d1d5c;border:none;padding:4px 8px;border-radius:3px;">åˆ é™¤</button>
                </div>
            </div>
        `;
        tagList.appendChild(tagItem);
    });
    
    tagManager.style.display = 'block';
}

function renameTag(oldTag) {
    const newTag = prompt(`è¯·è¾“å…¥æ–°çš„æ ‡ç­¾åç§°ï¼ˆå½“å‰ï¼š${oldTag}ï¼‰ï¼š`);
    if (newTag && newTag !== oldTag) {
        posts.forEach(post => {
            const tagIndex = post.tags.indexOf(oldTag);
            if (tagIndex !== -1) {
                post.tags[tagIndex] = newTag;
            }
        });
        
        allTags.delete(oldTag);
        allTags.add(newTag);
        
        if (saveToLocalStorage()) {
            renderTags();
            renderPosts(posts);
            showTagManager();
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
}



function deleteTag(tag) {
    if (confirm(`ç¡®å®šè¦åˆ é™¤æ ‡ç­¾"${tag}"å—ï¼Ÿ`)) {
        posts.forEach(post => {
            post.tags = post.tags.filter(t => t !== tag);
        });
        
        allTags.delete(tag);
        
        if (saveToLocalStorage()) {
            renderTags();
            renderPosts(posts);
            showTagManager();
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
}


function cleanUnusedTags() {
    const usedTags = new Set();
    posts.forEach(post => {
        post.tags.forEach(tag => usedTags.add(tag));
    });
    
    const unusedTags = Array.from(allTags).filter(tag => !usedTags.has(tag));
    if (unusedTags.length === 0) {
        alert('æ²¡æœ‰æ‰¾åˆ°æœªä½¿ç”¨çš„æ ‡ç­¾ï¼');
        return;
    }
    
    if (confirm(`å‘ç° ${unusedTags.length} ä¸ªæœªä½¿ç”¨çš„æ ‡ç­¾ï¼Œæ˜¯å¦æ¸…ç†ï¼Ÿ\n${unusedTags.join(', ')}`)) {
        unusedTags.forEach(tag => allTags.delete(tag));
        
        // ä¿å­˜æ›´æ–°
        localStorage.setItem('tags', JSON.stringify([...allTags]));
        
        // åˆ·æ–°æ˜¾ç¤º
        renderTags();
        showTagManager();
    }
}
function searchPosts() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    currentSearchTerm = searchInput;
    if (!searchInput) {
        currentSearchTerm = null;
        renderPosts(posts);
        return;
    }

    // åˆ¤æ–­åˆ†éš”ç¬¦ç±»å‹ï¼šåŒ…å«æ–œæ åˆ™æŒ‰ORé€»è¾‘ï¼Œå¦åˆ™æŒ‰ANDé€»è¾‘
    const isOR = searchInput.includes('/');
    const separator = isOR ? '/' : /\s+/; // é€‰æ‹©åˆ†éš”ç¬¦
    
    // åˆ†å‰²å…³é”®è¯ï¼ˆå…¼å®¹è¿ç»­åˆ†éš”ç¬¦ï¼‰
    const keywords = searchInput.split(separator)
        .map(k => k.trim())
        .filter(k => k !== '');

    const filteredPosts = posts.filter(post => {
        // æ ¹æ®é€»è¾‘ç±»å‹é€‰æ‹©åŒ¹é…æ–¹å¼
        return isOR ? 
            // ORé€»è¾‘ï¼šä»»æ„å…³é”®è¯åŒ¹é…
            keywords.some(keyword => checkKeywordMatch(post, keyword)) : 
            // ANDé€»è¾‘ï¼šæ‰€æœ‰å…³é”®è¯å¿…é¡»åŒ¹é…
            keywords.every(keyword => checkKeywordMatch(post, keyword));
    });

    renderPosts(filteredPosts);
}

// å°è£…å…³é”®è¯åŒ¹é…é€»è¾‘
function checkKeywordMatch(post, keyword) {
    const contentMatch = post.content && post.content.toLowerCase().includes(keyword);
    const tagMatch = post.tags && post.tags.some(tag => tag.toLowerCase().includes(keyword));
    return contentMatch || tagMatch;
}

// æ·»åŠ å›è½¦é”®æœç´¢åŠŸèƒ½
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchPosts(); // è§¦å‘ä¿®æ”¹åçš„æœç´¢é€»è¾‘
    }
});
function exportPosts() {
    const data = {
        posts: posts.map(post => ({
            ...post,
            lastModified: post.lastModified || Date.now() // ç¡®ä¿æ—§æ•°æ®ä¹Ÿæœ‰æ—¶é—´æˆ³
        })),
        tags: Array.from(allTags)
    };
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `posts_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// åœ¨importPostså‡½æ•°ä¸­æ·»åŠ å†²çªæ£€æµ‹å’Œæç¤ºé€»è¾‘
async function importPosts(input) {
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
      try {
          const data = JSON.parse(e.target.result);
            
          let updatedCount = 0;
          const newPosts = [];
          const conflictList = [];
            
          // ç¬¬ä¸€é˜¶æ®µï¼šæ”¶é›†å†²çª
          data.posts.forEach(importedPost => {
              if (!importedPost.lastModified) {
                  importedPost.lastModified = Date.now();
              }
                
              const existingIndex = posts.findIndex(p => p.id === importedPost.id);
              if (existingIndex >= 0) {
                    const existingPost = posts[existingIndex];
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯çœŸæ­£çš„å†²çªï¼ˆå†…å®¹ä¸åŒä¸”éƒ½æœ‰ç¼–è¾‘å†å²ï¼‰
                    const isRealConflict = () => {
                        // åŸºæœ¬å­—æ®µæ¯”è¾ƒ
                        const basicFieldsDiff = 
                            importedPost.content !== existingPost.content ||
                            JSON.stringify(importedPost.tags) !== JSON.stringify(existingPost.tags) ||
                            JSON.stringify(importedPost.media) !== JSON.stringify(existingPost.media);
                        
                        // éƒ½æœ‰ç¼–è¾‘å†å²
                        const bothEdited = importedPost.lastModified && existingPost.lastModified;
                        
                        return basicFieldsDiff && bothEdited;
                    };

                    if (isRealConflict()) {
                        conflictList.push({
                            imported: importedPost,
                            existing: existingPost,
                            index: existingIndex,
                            // æ·»åŠ å†²çªç±»å‹æ ‡è¯†
                            type: 'content'
                        });
                    } else if (!isRealConflict() && importedPost.lastModified > existingPost.lastModified) {
                        // æ²¡æœ‰çœŸæ­£å†²çªä½†å¯¼å…¥ç‰ˆæœ¬è¾ƒæ–°ï¼Œè‡ªåŠ¨æ›´æ–°
                        posts[existingIndex] = importedPost;
                        updatedCount++;
                    }
                } else {
                    newPosts.push(importedPost);
                }
                // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
            });

            // ç¬¬äºŒé˜¶æ®µï¼šå¤„ç†å†²çª
            for (const conflict of conflictList) {
                const userChoice = await showConflictDialog(conflict);
                if (userChoice === 'import') {
                    posts[conflict.index] = conflict.imported;
                    updatedCount++;
                }
                // é€‰æ‹©"ä¿ç•™"åˆ™ä¸åšä»»ä½•æ“ä½œ
            }
            
            // ç¬¬ä¸‰é˜¶æ®µï¼šåˆå¹¶æ•°æ®
            posts = [...posts, ...newPosts];
            data.tags.forEach(tag => allTags.add(tag));
            
            if (saveToLocalStorage()) {
                renderTags();
                renderPosts(posts);
                alert(`å¯¼å…¥å®Œæˆï¼\næ–°å¢å¸–å­ï¼š${newPosts.length}\næ›´æ–°å¸–å­ï¼š${updatedCount}\nè§£å†³å†²çªï¼š${conflictList.length}`);
            }
        } catch(err) {
            alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// æ–°å¢å†²çªå¯¹æ¯”å¯¹è¯æ¡†
function showConflictDialog(conflict) {
    return new Promise((resolve) => {
        const dialog = document.createElement('div');
        dialog.style.position = 'fixed';
        dialog.style.top = '50%';
        dialog.style.left = '50%';
        dialog.style.transform = 'translate(-50%, -50%)';
        dialog.style.background = '#1d1d5c';
        dialog.style.padding = '20px';
        dialog.style.borderRadius = '10px';
        dialog.style.zIndex = '10000';
        dialog.style.maxWidth = '90vw';
        
        // å¯¹æ¯”å†…å®¹ç”Ÿæˆ
        const diffHtml = generateDiffHtml(conflict.existing, conflict.imported);
        
        dialog.innerHTML = `
            <h3 style="color:#ba5757;margin:0 0 15px 0">å‘ç°å†…å®¹å†²çª</h3>
            ${diffHtml}
 <div style="display:flex;justify-content:space-between;margin-top:20px;">
    <button onclick="this.parentElement.parentElement.resolution('keep')" 
        style="background:#ba5757;color:white;border:none;padding:6px 15px;border-radius:5px;">
        ä¿ç•™å½“å‰ç‰ˆæœ¬
    </button>
    <button onclick="this.parentElement.parentElement.resolution('import')" 
        style="background:#ba5757;color:white;border:none;padding:6px 15px;border-radius:5px;margin-left:auto;">
        ä½¿ç”¨å¯¼å…¥ç‰ˆæœ¬
    </button>
</div>

        `;
        
        // è‡ªå®šä¹‰å†³è®®æ–¹æ³•
        dialog.resolution = (choice) => {
            document.body.removeChild(dialog);
            resolve(choice);
        };
        
        document.body.appendChild(dialog);
    });
}

// ç”Ÿæˆå¯¹æ¯”HTML
function generateDiffHtml(current, imported) {
  // åªæ˜¾ç¤ºå®é™…æœ‰å·®å¼‚çš„å­—æ®µ
  const diffFields = [
      { name: 'content', title: 'å†…å®¹' },
      { name: 'tags', title: 'æ ‡ç­¾', format: v => JSON.stringify(v, null, 2) },
      { name: 'media', title: 'åª’ä½“', format: v => JSON.stringify(v, null, 2) }
  ].filter(field => {
      const currentVal = field.format ? field.format(current[field.name]) : current[field.name];
      const importedVal = field.format ? field.format(imported[field.name]) : imported[field.name];
      return currentVal !== importedVal;
  });

  if (diffFields.length === 0) {
      return `<div style="color:#ba5757;">IDç›¸åŒä½†æœªæ£€æµ‹åˆ°å†…å®¹å·®å¼‚</div>`;
  }

  const diffSections = diffFields.map(field => {
      const currentVal = field.format ? field.format(current[field.name]) : current[field.name];
      const importedVal = field.format ? field.format(imported[field.name]) : imported[field.name];
        
      return `
          <div class="diff-section">
              <div class="diff-title">${field.title}å¯¹æ¯”</div>
              <div class="diff-row">
                  <div class="diff-version" style="border-right:1px solid #ba5757;">
                      <div class="diff-header">å½“å‰ç‰ˆæœ¬</div>
                      <div class="diff-content">${currentVal}</div>
                  </div>
                  <div class="diff-version">
                      <div class="diff-header">å¯¼å…¥ç‰ˆæœ¬</div>
                      <div class="diff-content">${importedVal}</div>
                  </div>
              </div>
          </div>
      `;
  }).join('');

  return `
<style>
    .diff-row { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
        margin: 10px 0; 
    }
    .diff-header { 
        color: #ba5757; 
        margin-bottom: 5px; 
        font-size: 14px;
    }
    .diff-content {
        background: rgba(0,0,0,0.3); 
        padding: 10px;
        margin: 0; 
        max-height: 200px; 
        overflow: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 12px;
        line-height: 1.5;
        border-radius: 3px;
    }
    .diff-section {
        margin-bottom: 15px;
    }
    .diff-title {
        color: #f7ebeb;
        font-size: 13px;
        margin-bottom: 5px;
        padding-bottom: 3px;
        border-bottom: 1px solid #ba5757;
    }
</style>

      ${diffSections}
      <div style="color:#888;margin-top:10px;">
          å½“å‰ç‰ˆæœ¬ä¿®æ”¹æ—¶é—´ï¼š${new Date(current.lastModified).toLocaleString()}<br>
          å¯¼å…¥ç‰ˆæœ¬ä¿®æ”¹æ—¶é—´ï¼š${new Date(imported.lastModified).toLocaleString()}
      </div>
  `;
}



function saveToLocalStorage() {
    try {
        const uniqueIds = new Set(posts.map(p => p.id));
        if (uniqueIds.size !== posts.length) {
            console.error('å‘ç°é‡å¤ID');
            return false;
        }
        localStorage.setItem('posts', JSON.stringify(posts));
        localStorage.setItem('tags', JSON.stringify([...allTags]));
        return true;
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        return false;
    }
}
if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/notes-pwa/sw.js')
        .then(reg => console.log('SW registered', reg))
        .catch(err => console.error('SW failed', err));
    }
    window.addEventListener('beforeinstallprompt', e => {
      console.log('PWA å¯å®‰è£…');
    });
</script>
</body>
</html>
