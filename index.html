<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1d1d5c">
	<title>🍊</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
   <link rel="manifest" href="/notes-pwa/manifest.json">
 <style>
    	@font-face {
    font-family: 'KingHwa';
    src: url('/notes-pwa/fonts/KingHwa.woff') format('woff');
    font-weight: 200;
    font-style: normal;
    font-display: swap;
}
        body { 
            font-family: 'KingHwa', "KaiTi", serif;
            padding: 20px; 
            background-color: rgb(var(--theme-background));
            color: rgb(var(--theme-highlight));
            font-size: 11.5px;
           
    background-size: 4px 30px;
    background-position: -1px -1px;
        }
        .post pre, .post div {
    font-weight: 200;
}
/* 顶栏（标签过滤器） */
.tag-filter {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgb(var(--theme-background)); /* 默认纯色背景 */
    z-index: 1000;
    padding: 10px 20px;
    padding-right: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    padding-bottom: 15px;
    height: auto;
    align-items: center;
    overflow-x: auto;
    white-space: nowrap;
    flex-wrap: nowrap;
    scrollbar-width: thin;
    scrollbar-color: rgba(var(--theme-background), 0.2) rgba(var(--theme-background), 0.2);
}

/* 毛玻璃模式下的顶栏 */
.glass-background .tag-filter {
    background: rgba(var(--glass-background, 28, 45, 34), var(--glass-opacity, 0.6));
    backdrop-filter: blur(var(--glass-blur, 7px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 7px));
}

/* 底栏（分页） */
.pagination {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgb(var(--theme-background)); /* 默认纯色背景 */
    box-shadow: 0 -2px 5px rgba(0,0,0,0.3);
    padding: 4px 0;
    z-index: 998;
    margin: 0;
    width: 100%;
    transform: none !important;
    display: flex;
    justify-content: center;
    gap: 10px;
}

/* 毛玻璃模式下的底栏 */
.glass-background .pagination {
    background: rgba(var(--glass-background, 28, 45, 34), var(--glass-opacity, 0.6));
    backdrop-filter: blur(var(--glass-blur, 7px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 7px));
}

/* 通用按钮样式 */
.glass-button {
    background: rgb(var(--theme-background)); /* 默认纯色背景 */
    color: rgb(var(--theme-highlight));
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important;
}

/* 毛玻璃模式下的按钮 */
.glass-background .glass-button {
    background: rgba(var(--glass-background, 28, 45, 34), var(--glass-opacity, 0.6));
    backdrop-filter: blur(var(--glass-blur, 7px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 7px));
}

.add-btn {
    position: fixed;
    bottom: 50px;
    right: 30px;
    width: 45px;
    height: 45px;
    font-size: 24px;
    z-index: 1000;
}

.edit-btn {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 45px;
    height: 45px;
    font-size: 24px;
    z-index: 1000;
}

.theme-btn {
    position: fixed;
    bottom: 200px;
    right: 30px;
    width: 45px;
    height: 45px;
    font-size: 24px;
    z-index: 1000;
}

.tag-manager-btn {
    position: fixed;
    bottom: 150px;
    right: 30px;
    width: 45px;
    height: 45px;
    font-size: 24px;
    z-index: 1000;
}

.search-btn {
    width: 45px;
    height: 45px;
    font-size: 24px;
}

.export-btn, .import-btn, .toggle-pin-mode-btn {
    width: 45px;
    height: 45px;
    font-size: 20px;
    position: relative;
}

.tag-filter::after { /* 新增伪元素 */
    content: "";
    display: inline-block;
    min-width: 20px;
    height: 1px;
}

/* 针对Webkit浏览器（Chrome, Safari等）的滚动条样式 */
.tag-filter::-webkit-scrollbar {
    height: 1px;
    background-color: rgb(var(--theme-background));
}

.tag-filter::-webkit-scrollbar-thumb {
    background-color: transparent; /* 滑块颜色 - 使用标签橙色 */
    border-radius: 1px;
    height: 1px;
}

.tag-filter::-webkit-scrollbar-track {
    background: rgb(var(--theme-background));
}

 .tag {
    background-color: transparent;
    color: rgb(var(--theme-foreground));
    font-size: 12px;
    padding: 5px 6px;
    cursor: pointer;
    border-radius: 3px;
    display: inline-block; /* 确保标签横向排列 */
    white-space: nowrap; /* 防止标签内文字换行 */
}

.tag.active {
    background-color: transparent;
    font-weight: bold;
    text-decoration: underline;
    /* 将外阴影改为内阴影 */
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); /* 使用inset关键字创建内阴影 */
    /* 可选：添加一点文字凹陷效果 */
    text-shadow: 0 -1px 1px rgba(0,0,0,0.3);
}

   .posts-container { 
    column-count: 3;     /* 分三列 */
    column-gap: 7.5px;  /* 列间距 */
    margin-top: 40px; /* 留出顶部空间 */
    margin-bottom: 60px; /* 留出底部空间 */
}
/* 平板横屏/大屏设备 */
@media (min-width: 1024px) {
    .posts-container {
        column-count: 3 !important;
    }
}

/* 手机设备 */
@media (max-width: 550px) {
    .posts-container {
        column-count: 1 !important;
    }
}

/* 平板分屏模式适配（约50%宽度时保持三列）*/
@media (min-width: 550px) and (max-width: 850px) {
    .posts-container {
        column-count: 2 !important;
    }
}
.post {
    break-inside: avoid; /* 防止内容跨列断开 */
    margin-bottom: 0;/* 替代原gap间距 */
    width: 100%;         /* 占满列宽 */
    position: relative;
    z-index: 2;  /* 建立新的层叠上下文并高于遮罩 */
    /* 保持其他原有样式 */
}
        .post { 
            background: transparent; /* 帖子背景 */
            padding: 10px;
            display: flex;
            flex-direction: column;
            line-height: 1.7;    /* 增加行距 */
    letter-spacing: 0.3px; /* 增加字间距 */
    /* 已有样式保持不变 */
    padding-top: 0 !important;
    padding-bottom: 5px !important;
        }
        .post-actions {
    margin-top: 10px;
    display: none; /* 默认隐藏 */
}
.post-content {
    position: relative;
    z-index: 3;
    white-space: pre-wrap !important;
    word-break: break-word !important;
    font-family: inherit !important;
    margin: 0 !important;
    line-height: var(--post-line-height) !important;
    letter-spacing: var(--post-letter-spacing) !important;
    font-size: var(--post-font-size) !important;
    transform: scaleX(var(--post-text-scale-x)) !important;
    transform-origin: left !important;
    width: calc(100% / var(--post-container-width-scale)) !important;
    display: inline-block !important;
    box-sizing: border-box !important;
}

.post-iframe {
    width: 100% !important;
    transform: none !important;
    display: block !important;
    margin: 0.3em 0 !important;
}

.post iframe {
    width: 100% !important;
    transform: none !important;
    display: block !important;
    box-sizing: border-box !important;
}


.post-actions button {
    background-color: rgb(var(--theme-background)) !important;
    color: rgb(var(--theme-highlight)) !important;
    border: none;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    padding: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3) !important;
}

.edit-mode .post-actions {
    display: flex;
    gap: 10px;
    justify-content: space-between; /* 让按钮两端对齐 */
}
        .post-media {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .post-media iframe {
            width: 100%;
            aspect-ratio: 4/3; /* 仅视频保持比例 */
        }
        .post-media img {
            max-width: 100%;
            height: auto; /* 图片自适应 */
        }
        
        
        /* 新增分页定位样式 */
.posts-container {
    position: relative;
}

    

        /* 新增输入框样式 */
        .add-btn {
            position: fixed;
            z-index: 1000;
            bottom: 50px;
            right: 30px;
            width: 45px;
            height: 45px;
            background: rgb(var(--theme-background));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: rgb(var(--theme-highlight));
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important; /* 橙色阴影效果 */
        }
        .edit-btn {
    position: fixed;
    z-index: 1000;
    bottom: 100px;  /* 位于添加按钮上方 */
    right: 30px;
    width: 45px;
    height: 45px;
    background: rgb(var(--theme-background));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 24px;
    color: rgb(var(--theme-highlight));
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important; 
}
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgb(var(--theme-foreground));
            padding: 20px;
            border-radius: 10px;
            border: 0px solid rgb(var(--theme-background));
            width: 400px;
        }
   #content {
    width: 95%;
    height: 400px;
    background: transparent;
    border: none;
    outline: none;
    color: rgb(var(--theme-highlight));
    padding: 10px;
    margin-bottom: 10px;
    white-space: pre-wrap;
}
        .tag-manager {
        display: none;
        position: fixed;
        z-index: 999;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgb(var(--theme-foreground));
        padding: 20px;
        border-radius: 10px;
        border: 0px solid #000000;
        max-width: 80%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .tag-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        margin: 5px 0;
        border-bottom: 1px solid #000000;
    }

    .tag-count {
        color: rgb(var(--theme-highlight));
        font-size: 0.9em;
        margin-right: 10px;
    }

    .tag-actions {
        display: flex;
        gap: 5px;
    }
    .pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
   
}
.page-number {
    color: rgb(var(--theme-foreground));
    font-size: 12px;
    cursor: pointer;
    padding: 5px 10px;
}
.page-number.active {
    text-decoration: underline;
}
.post div {
    white-space: pre-wrap;
    word-wrap: break-word;
}
.youtube-container {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
}

.youtube-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}



.youtube-play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: transparent;
    border: none;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
    color: rgb(var(--theme-highlight));
    font-size: 24px;
    z-index: 1;
}



/* 针对搜索框的placeholder */
#searchInput::placeholder { /* 现代浏览器 */
    color: rgb(var(--theme-foreground));
    opacity: 0.4; /* 确保颜色不透明 */
}

#searchInput::-webkit-input-placeholder { /* Chrome/Safari */
    color: rgb(var(--theme-foreground));
}
#searchInput::-moz-placeholder { /* Firefox 19+ */
    color: rgb(var(--theme-foreground));
}
#searchInput:-ms-input-placeholder { /* IE 10+ */
    color: rgb(var(--theme-foreground));
}

/* 针对模态框输入区的placeholder */
#content::placeholder {
    color: rgb(var(--theme-background));
    opacity: 0.4;
}
#content::-webkit-input-placeholder {
    color: rgb(var(--theme-background));
}
#content::-moz-placeholder {
    color: rgb(var(--theme-background));
}
#content:-ms-input-placeholder {
    color: rgb(var(--theme-background));
}
.bilibili-player-video-top,
.bilibili-player-video-info,
.bilibili-player-video-info-hover,
.bilibili-player-video-info-switch-btn,
.bilibili-player-video-info-container {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

/* 重设音频播放器整体样式 */
audio::-webkit-media-controls-panel {
    background-color: rgb(var(--theme-background)) !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    min-width: unset !important; /* 移除固定最小宽度 */
    width: 100% !important;      /* 强制宽度自适应 */
}

/* 播放按钮和音量按钮样式 */
audio::-webkit-media-controls-play-button,
audio::-webkit-media-controls-mute-button {
    filter: invert(0.1);
    flex: 0 0 auto !important; /* 防止按钮被压缩 */
}
.play-button {
    margin-right: 8px !important;
}

/* 时间显示样式 */
audio::-webkit-media-controls-current-time-display,
audio::-webkit-media-controls-time-remaining-display {
    color: rgba(var(--theme-background));
    font-size: 11px !important;
    padding: 0 0px !important;
    flex: 0 0 auto !important; /* 防止时间显示被压缩 */
    min-width: 35px !important; /* 确保时间显示有足够空间 */
    text-align: center !important;
}

/* 进度条样式 */
audio::-webkit-media-controls-timeline {
    height: 1px !important;
    flex: 1 1 100px !important; /* 允许进度条伸缩但保持最小宽度 */
}
audio::-webkit-media-controls-timeline-container,
audio::-webkit-media-controls-current-time-display,
audio::-webkit-media-controls-time-remaining-display {
    flex: 1 !important; /* 允许时间显示区域伸缩 */
}
.audio-container {
    width: 100% !important;
    max-width: 100% !important;
}
.custom-controls {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 1px !important; /* 增加左右间距 */
}
/* 进度条滑块样式 */
audio::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    width: 2px !important;
    height: 2px !important;
    background: rgb(var(--theme-foreground)) !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    margin-top: -2px !important;
}

/* Firefox浏览器进度条滑块样式 */
audio::-moz-range-thumb {
    width: 2px !important;
    height: 2px !important;
    background: rgb(var(--theme-foreground)) !important;
    border-radius: 50% !important;
    cursor: pointer !important;
}
/* 音频播放器进度条样式 */
input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 2px;
    background: rgb(var(--theme-background));
    border-radius: 1px;
    margin: 0 1px;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 4.5px;
    height: 4.5px;
    background: rgb(var(--theme-secondary));
    border-radius: 50%;
    cursor: pointer;
    margin-top: -1.5px;
}


input[type="range"]::-moz-range-thumb {
    width: 8px;
    height: 8px;
    background: rgb(var(--theme-foreground));
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

input[type="range"]::-webkit-slider-runnable-track {
  height: 1px !important;
  background: rgb(var(--theme-secondary), 0.2)!important;
}

input[type="range"]::-moz-range-track {
  height: 1px !important;
  background: rgba(var(--theme-foreground), 0.2); !important;
}




hr {
    border: 0;
    height: 0;
    border-top: 1px dashed rgba(var(--theme-secondary), 0.3); /* 备用虚线样式 */
    margin: 5px 0;
}
/* 下划线样式 */
.underline-divider {
    border-bottom: 1px solid rgb(var(--theme-secondary));
    margin: 3px 0 !important;
    width: 100%;
}

/* 引用框内补偿 */
/* 引用框内水平线补偿 */
blockquote hr.blockquote-divider {
    border: none;
    border-top: 1px dashed rgba(var(--theme-secondary), 0.3);
    margin: 5px -8px; /* 抵消引用框的内边距 */
    width: calc(100% + 16px); /* 扩展宽度以对齐视觉边缘 */
}
.pinned-container {
    break-inside: avoid; /* 防止被多列分割 */
    break-before: column; /* 强制在第一列开头 */
    display: block; /* 独占一行 */
    margin-bottom: 10px; /* 与下方帖子间距 */
    margin-left: 9px; /* 右移2像素，修正左偏 */
    padding: 0px; /* 与.post一致 */
    padding-top: 0; /* 匹配.post的padding-top */
    padding-bottom: 5px; /* 匹配.post的padding-bottom */
    background: 
        repeating-linear-gradient(
            to bottom,
            transparent 0px,
            transparent 30px,
            rgba(var(--theme-foreground), 0.2) 30px,
            rgba(var(--theme-foreground), 0.2) 31px,
            transparent 31px,
            transparent 30px
        ),
        repeating-linear-gradient(
            to right,
            transparent 0px,
            transparent 30px,
            rgba(var(--theme-foreground), 0.2) 30px,
            rgba(var(--theme-foreground), 0.2) 31px,
            transparent 31px,
            transparent 30px
        );
    backdrop-filter: blur(4px); /* 磨砂玻璃模糊效果 */
    -webkit-backdrop-filter: blur(4px); /* 兼容 Webkit 浏览器 */
    position: relative;
    z-index: 3; /* 高于其他元素 */
    box-sizing: border-box;
    display: none; /* 默认隐藏 */
    width: 100%; /* 默认占满列宽 */
    
}

.pinned-container.active {
    display: block; /* 有置顶帖子时显示 */
}

.pinned-container.fixed {
    position: fixed; /* 固定定位 */
    top: 50px; /* 留出顶部标签栏空间 */
    left: 20px; /* 与页面左边距一致 */
    width: var(--single-column-width, 100%); /* 动态宽度，匹配单列 */
    background: 
        repeating-linear-gradient(
            to bottom,
            transparent 0px,
            transparent 30px,
            rgba(var(--theme-foreground), 0.2) 30px,
            rgba(var(--theme-foreground), 0.2) 31px,
            transparent 31px,
            transparent 30px
        ),
        repeating-linear-gradient(
            to right,
            transparent 0px,
            transparent 30px,
            rgba(var(--theme-foreground), 0.2) 30px,
            rgba(var(--theme-foreground), 0.2) 31px,
            transparent 31px,
            transparent 30px
        ),
        rgba(var(--theme-background), 0.2); /* 半透明底色 */
    backdrop-filter: blur(4px); /* 磨砂玻璃模糊效果 */
    -webkit-backdrop-filter: blur(4px); /* 兼容 Webkit 浏览器 */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* 添加阴影以突出悬浮效果 */
    z-index: 900; /* 确保高于其他元素 */
    margin-left: 18px; /* 移除左边距以对齐 */
    max-height: 90vh; /* 限制最大高度，允许滚动 */
    overflow-y: auto; /* 启用内部垂直滚动 */
    scrollbar-width: 2px; /* 细滚动条 */
    scrollbar-color: rgba(var(--theme-background), 0.2);
}

/* Webkit 浏览器滚动条样式 */
.pinned-container::-webkit-scrollbar {
    width: 1px;
}
.pinned-container::-webkit-scrollbar-thumb {
    background-color: rgba(var(--theme-background), 0.2);
    border-radius: 1px;
}
.pinned-container::-webkit-scrollbar-track {
    background: rgba(var(--theme-background), 0.2);
}

/* 确保置顶帖子样式一致 */
.pinned-container .post {
    margin: 0;
    width: 100%;
    padding: 0px;
    padding-top: 0 !important;
    padding-bottom: 5px !important;
    box-sizing: border-box;
    background: transparent;
}


.okru-container {
    background-color: rgb(var(--theme-background));
}
.okru-play-icon {
    border-color: transparent transparent transparent rgba(var(--theme-highlight), 0.3);
}

.custom-controls {
    background-color: rgba(var(--theme-background), 0);
}
.play-button {
    color: rgb(var(--theme-secondary));
}
.time-display {
    color: rgba(var(--theme-secondary), 0.7);
}
.youtube-play-icon {
    border-left: 12px solid rgba(var(--theme-highlight), 0.2);
}
.conflict-dialog {
    background: rgb(var(--theme-background));
}
.conflict-title {
    color: rgb(var(--theme-foreground));
    margin: 0 0 15px 0;
}
.conflict-btn {
    background: rgb(var(--theme-highlight));
    color: rgb(var(--theme-background));
    border: none;
    padding: 6px 15px;
    border-radius: 5px;
}

/* 主题管理器滚动条样式 */
.theme-manager::-webkit-scrollbar {
    width: 1px;
}
.theme-manager::-webkit-scrollbar-thumb {
    background-color: rgba(var(--theme-background), 0.2);
    border-radius: 1px;
}
.theme-manager::-webkit-scrollbar-track {
    background: rgba(var(--theme-background), 0.2);
}

/* 背景媒体容器 */
.background-media-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -2; /* 在毛玻璃之下 */
    overflow: hidden;
}
.background-media-container img,
.background-media-container video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* 确保视频/图片平铺覆盖 */
    position: absolute;
    top: 0;
    left: 0;
}

/* 毛玻璃效果 */
.glass-background::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* 在内容之下，背景之上 */
    background: rgba(var(--glass-background, 28, 45, 34), var(--glass-opacity, 0.6));
    backdrop-filter: blur(var(--glass-blur, 7px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 7px));
}

/* 雨滴效果 */
.rain-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0; /* 在毛玻璃之上，内容之下 */
    pointer-events: none; /* 防止雨滴干扰交互 */
}
.rain {
    position: absolute;
    width: 2px;
    height: 20px;
    background: rgba(255, 255, 255, 0.5);
    animation: fall linear infinite;
}
@keyframes fall {
    0% {
        transform: translateY(-100vh);
        opacity: 1;
    }
    100% {
        transform: translateY(100vh);
        opacity: 0;
    }
}

/* 更新主题变量 */
:root {
    --theme-background: 29, 29, 92; /* #1d1d5c */
    --theme-foreground: 186, 87, 87; /* #ba5757 */
    --theme-secondary: 168, 168, 228; /* #a8a8e4 */
    --theme-highlight: 247, 235, 235; /* #f7ebeb */
    --glass-background: 28, 45, 34; /* #1c2d22，毛玻璃默认颜色 */
    --glass-opacity: 0.6; /* 默认透明度 */
    --glass-blur: 7px; /* 默认模糊度 */
    --post-letter-spacing: 0; /* 字距 */
    --post-line-height: 1.7; /* 行距 */
    --post-font-size: 12px; /* 字体大小 */
    --post-text-scale-x: 1; /* 文本水平缩放比例 */
    --post-container-width-scale: 1; /* 新增：容器宽度缩放比例 */
}

.search-box {
    position: fixed;
    bottom: 100px;
    left: 30px; /* 调整为靠左，留出边距 */
    z-index: 1000;
    display: flex;
    flex-direction: row; /* 改为 row，确保按钮在输入框左侧 */
    align-items: center;
    gap: 5px;
}

.search-box input#searchInput {
    padding: 5px;
    border-radius: 3px;
    border: none;
    background: transparent;
    color: rgb(var(--theme-foreground));
    width: 150px; /* 固定宽度，避免拉伸 */
    outline: none;
}


.bottom-left-buttons {
    position: fixed;
    bottom: 50px;
    left: 30px;
    z-index: 999;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px; /* 按钮间距 */
}

blockquote {
    border-left: 1.5px solid rgb(var(--theme-background));
    margin: 0.3em 0;
    padding: 4px 8px;
    color: rgb(var(--theme-secondary));
    background: rgba(var(--theme-background), 0.1);
    font-size: 9px !important;
    font-family: 'Arial, sans-serif' !important;
    font-weight: 400 !important;
    white-space: pre-wrap !important;
    line-height: 1.6 !important;
    display: block !important; /* 改为 block，确保独立布局 */
    width: 100% !important; /* 固定宽度 */
    box-sizing: border-box !important;
    transform: none !important; /* 禁止任何缩放 */
    transform-origin: left !important; /* 防止父级影响 */
}


    </style>
</head>
<body>
	<!-- 背景媒体容器 -->
    <div class="background-media-container"></div>
    <!-- 雨滴容器 -->
    <div class="rain-container"></div>
	<div class="bottom-left-buttons">
    <button class="export-btn glass-button" onclick="exportPosts()">⇩</button>
    <input type="file" id="importFile" style="display:none" onchange="importPosts(this)">
    <button class="import-btn glass-button" onclick="document.getElementById('importFile').click()">⇧</button>
<button class="toggle-pin-mode-btn glass-button" onclick="togglePinMode()">☂</button>
</div>

  <!-- 原代码 -->
<div class="add-btn glass-button" onclick="toggleModal(false)">+</div>
<!-- 新增编辑按钮 -->
<div class="edit-btn glass-button" onclick="toggleEditMode()">✎</div>
<button class="theme-btn glass-button" onclick="showThemeSettings()" style="bottom:200px; right:30px;">☃</button>
<div class="theme-manager" id="themeManager" style="display:none; position:fixed; z-index:1001; top:50%; left:50%; transform:translate(-50%,-50%); background:rgb(var(--theme-foreground)); padding:20px; border-radius:10px; max-width:90%; max-height:90vh; overflow-y:auto;">
    <h3 style="color:rgb(var(--theme-highlight)); margin-bottom:20px;">主题设置</h3>
    <div id="themeSettings">
        <div style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">主题名称：</label>
            <input type="text" id="themeName" placeholder="输入主题名称" style="padding:5px; border:none; background:rgba(0,0,0,0.1); color:rgb(var(--theme-highlight)); width:100%; border-radius:3px;">
        </div>
        <div style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">背景类型：</label>
            <select id="backgroundType" style="padding:5px; border:none; background:rgba(0,0,0,0.1); color:rgb(var(--theme-highlight)); width:100%; border-radius:3px;">
                <option value="solid">纯色背景</option>
                <option value="glass">毛玻璃背景</option>
            </select>
        </div>
        <div id="solidColorSettings" style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">纯色背景颜色：</label>
            <input type="color" id="solidBackgroundColor" style="width:100%; height:30px; border:none; cursor:pointer;">
        </div>
        <div id="glassSettings" style="display:none;">
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">毛玻璃背景颜色：</label>
                <input type="color" id="glassBackgroundColor" value="#1c2d22" style="width:100%; height:30px; border:none; cursor:pointer;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">毛玻璃背景透明度（0-1）：</label>
                <input type="range" id="glassOpacity" min="0" max="1" step="0.01" value="0.6" style="width:100%;">
                <span id="glassOpacityValue" style="color:rgb(var(--theme-highlight));">0.6</span>
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">毛玻璃模糊度（px）：</label>
                <input type="range" id="glassBlur" min="0" max="20" step="1" value="7" style="width:100%;">
                <span id="glassBlurValue" style="color:rgb(var(--theme-highlight));">7</span>
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">背景图片/视频/GIF URL：</label>
                <input type="text" id="backgroundMedia" placeholder="输入图片、视频或GIF链接" style="padding:5px; border:none; background:rgba(0,0,0,0.1); color:rgb(var(--theme-highlight)); width:100%; border-radius:3px;">
            </div>
            <div id="videoSpeedSettings" style="display:none; margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">视频播放速度（0.1-2）：</label>
                <input type="range" id="videoSpeed" min="0.1" max="2" step="0.1" value="1" style="width:100%;">
                <span id="videoSpeedValue" style="color:rgb(var(--theme-highlight));">1</span>
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">启用雨滴效果：</label>
                <input type="checkbox" id="enableRain" style="margin-left:10px;">
            </div>
            <div id="rainSettings" style="display:none;">
                <div style="margin-bottom:15px;">
                    <label style="color:rgb(var(--theme-highlight));">雨滴数量（10-200）：</label>
                    <input type="range" id="rainCount" min="10" max="200" step="1" value="100" style="width:100%;">
                    <span id="rainCountValue" style="color:rgb(var(--theme-highlight));">100</span>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:rgb(var(--theme-highlight));">雨滴下落速度（秒）：</label>
                    <input type="range" id="rainSpeed" min="0.5" max="5" step="0.1" value="2" style="width:100%;">
                    <span id="rainSpeedValue" style="color:rgb(var(--theme-highlight));">2</span>
                </div>
            </div>
        </div>
        <div style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">主要颜色设置：</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label style="color:rgb(var(--theme-highlight));">背景颜色 (深蓝)：</label>
                    <input type="color" id="themeBackground" value="#1d1d5c" style="width:100%; height:30px; border:none; cursor:pointer;">
                </div>
                <div>
                    <label style="color:rgb(var(--theme-highlight));">前景颜色 (橙)：</label>
                    <input type="color" id="themeForeground" value="#ba5757" style="width:100%; height:30px; border:none; cursor:pointer;">
                </div>
                <div>
                    <label style="color:rgb(var(--theme-highlight));">次要颜色 (浅紫)：</label>
                    <input type="color" id="themeSecondary" value="#a8a8e4" style="width:100%; height:30px; border:none; cursor:pointer;">
                </div>
                <div>
                    <label style="color:rgb(var(--theme-highlight));">高亮颜色 (白)：</label>
                    <input type="color" id="themeHighlight" value="#f7ebeb" style="width:100%; height:30px; border:none; cursor:pointer;">
                </div>
            </div>
        </div>
<div style="margin-bottom:15px;">
 <label style="color:rgb(var(--theme-highlight));">帖子正文字体设置（不含引用）：</label>
 <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
<div>
    <label style="color:rgb(var(--theme-highlight));">字距（px，-2-2）：</label>
    <input type="range" id="postLetterSpacing" min="-2" max="2" step="0.1" value="0" style="width:100%;">
    <span id="postLetterSpacingValue" style="color:rgb(var(--theme-highlight));">0</span>
</div>
 <div>
 <label style="color:rgb(var(--theme-highlight));">行距（1-2.5）：</label>
 <input type="range" id="postLineHeight" min="1" max="2.5" step="0.1" value="1.7" style="width:100%;">
 <span id="postLineHeightValue" style="color:rgb(var(--theme-highlight));">1.7</span>
 </div>
 <div>
 <label style="color:rgb(var(--theme-highlight));">文本水平缩放（0.5-1.5）：</label>
 <input type="range" id="postTextScaleX" min="0.5" max="1.5" step="0.01" value="1" style="width:100%;">
 <span id="postTextScaleXValue" style="color:rgb(var(--theme-highlight));">1</span>
 </div>
 <div>
 <label style="color:rgb(var(--theme-highlight));">字体大小（px，8-20）：</label>
 <input type="range" id="postFontSize" min="8" max="20" step="1" value="12" style="width:100%;">
 <span id="postFontSizeValue" style="color:rgb(var(--theme-highlight));">16</span>
 </div>
 </div>
</div>
        <div style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">保存的主题方案：</label>
            <select id="themeSelect" style="padding:5px; border:none; background:rgba(0,0,0,0.1); color:rgb(var(--theme-highlight)); width:100%; border-radius:3px;">
                <option value="">选择已有主题</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="saveTheme()" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">保存主题</button>
            <button onclick="applyTheme()" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">应用主题</button>
            <button onclick="exportThemes()" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">导出主题</button>
            <input type="file" id="importThemeFile" style="display:none" onchange="importThemes(this)">
            <button onclick="document.getElementById('importThemeFile').click()" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">导入主题</button>
            <button onclick="document.getElementById('themeManager').style.display='none'" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">关闭</button>
        </div>
    </div>
</div>
<!-- 原代码继续 -->
<button class="tag-manager-btn glass-button" onclick="showTagManager()" style="bottom:150px; right:30px;">♞</button>


    <div class="modal">
    <textarea id="content" placeholder="输入内容、媒体链接和标签（示例）：
今天发现一个好视频
https://youtu.be/abc123
#音乐 
#推荐
搜索：空格=与 /斜杠=或  双星号是粗体
单星号斜体
浪号是删除
三星号是水平线
大于号是引用内容"></textarea>
    <div style="display:flex;gap:10px;justify-content:center;">
        <button id="saveBtn" style="background:rgb(var(--theme-highlight));color:rgb(var(--theme-background));border:none;padding:8px 20px;border-radius:5px;">✔</button>
        
    </div>
</div>
<div class="tag-manager" id="tagManager">
    <h3 style="color:rgb(var(--theme-secondary));margin-bottom:20px;">标签管理</h3>
    <div id="tagList"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">
        <button onclick="cleanUnusedTags()" style="background:rgb(var(--theme-highlight));;color:rgb(var(--theme-background));border:none;padding:8px 20px;border-radius:5px;">清理未使用标签</button>
        <button onclick="document.getElementById('tagManager').style.display='none'" style="background:rgb(var(--theme-highlight));color:rgb(var(--theme-background));border:none;padding:8px 20px;border-radius:5px;">关闭</button>
    </div>
</div>

    <div id="tagFilter" class="tag-filter"></div>
<div class="search-box">
    <button class="search-btn glass-button" onclick="searchPosts()">☞</button>
    <input type="text" id="searchInput" placeholder="☃☂☀">
</div>
<div id="postsContainer" class="posts-container">
    <div id="pinnedContainer" class="pinned-container"></div>
</div>
    <script>
    	// 原代码第45行修改为 ▼▼▼
document.addEventListener('DOMContentLoaded', () => {
    try {
        posts = [];
        allTags = new Set();
        const savedPosts = localStorage.getItem('posts');
        if (savedPosts) {
            posts = JSON.parse(savedPosts).map(p => ({
                ...p,
                id: p.id || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                tags: p.tags || [],
                lastModified: p.lastModified || Date.now()
            })).sort(() => Math.random() - 0.5);
        }
        const savedTags = localStorage.getItem('tags');
        if (savedTags) {
            allTags = new Set(JSON.parse(savedTags));
        }
        // 确保置顶帖子ID存在
        if (!localStorage.getItem('pinnedPosts')) {
            localStorage.setItem('pinnedPosts', '[]');
        }
        renderTags();
        renderPinnedPosts(); // 渲染置顶区
        renderPosts(posts); // 渲染普通帖子区
    } catch (error) {
        console.error('初始化失败:', error);
        alert('数据加载异常，已重置');
        localStorage.clear();
        location.reload();
    }
});
        // 保持原有JavaScript逻辑不变
        let posts = [];
        let allTags = new Set();
        let isEditMode = false;
        let currentFilterTag = null; // 新增全局变量
        let currentSearchTerm = null; // 保存当前搜索词
        
        // ▼▼▼ 新增的切换模态框函数 ▼▼▼
function toggleModal(isEdit = false) {
    const modal = document.querySelector('.modal');
    if (modal.style.display === 'block') {
        modal.style.display = 'none';
        return;
    }

    // 重置模态框为初始状态
    modal.innerHTML = `
        <textarea id="content" placeholder="输入内容、媒体链接和标签（示例）：
今天发现一个好视频
https://youtu.be/abc123
#音乐 #推荐

搜索：空格=与 /斜杠=或  双星号是粗体

*斜体*
**加粗**
~删除线~
***是水平线
> 是引用内容"></textarea>
        <div style="display:flex;justify-content:center;">
            <button id="saveBtn" style="background:#f7ebeb;color:#1d1d5c;border:none;padding:8px 20px;border-radius:5px;">✔</button>
        </div>
    `;

    const saveBtn = modal.querySelector('#saveBtn');
    
    if (!isEdit) {
        saveBtn.onclick = addPost;
    }

    modal.style.display = 'block';
}
// ▲▲▲ 新增的切换模态框函数 ▲▲▲

        function detectMediaType(url) {
        	const originalUrl = url;
        
        // 在 detectMediaType 函数的音频检测逻辑中添加 ▼▼▼
   const audioRegex = /(?:https?:\/\/.*archive\.org\/.*\.mp3|\.mp3)(?:\?.*)?$/i;
   if (audioRegex.test(url)) {
       return {
           type: 'audio',
           url: url,       // 直接使用原始链接（无需处理）
           original: url   // 明确保存原始链接
       };
   }
    
    // B站检测
    const bilibiliRegex = /(?:https?:\/\/)?(?:www\.)?bilibili\.com\/video\/(BV\w+)(\/|\?|&|$)/i;
    const bilibiliMatch = originalUrl.match(bilibiliRegex);
    if (bilibiliMatch) {
        return {
            type: 'bilibili',
            url: `https://player.bilibili.com/player.html?bvid=${bilibiliMatch[1]}&page=1`,
            original: originalUrl // 存储原始链接
        };
    }

	// 检测 MP4 视频直链
const mp4Regex = /https?:\/\/.+\.mp4(\?.+)?$/i;
    if (mp4Regex.test(url)) {
        return {
            type: 'video', // 新增类型
            url: url,
            original: url
        };
    }	
		
    // OK.ru检测
// 修改detectMediaType函数中的正则表达式
const okruRegex = /(?:https?:\/\/)?(?:www\.)?ok\.ru\/video\/(\d+)(?:\/|\?|&|$)/i;
    const okruMatch = originalUrl.match(okruRegex);
    if (okruMatch) {
        return {
            type: 'okru',
            url: `https://ok.ru/videoembed/${okruMatch[1]}`,
            original: originalUrl // 存储原始链接
        };
    }
            // 原有媒体检测逻辑
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
    return { 
        type: 'youtube', 
        url: `https://www.youtube-nocookie.com/embed/${youtubeMatch[1]}` 
    };
}

            const imgurRegex = /https?:\/\/(?:i\.)?imgur\.com\/(\w+)(\.\w+)?/;
            const imgurMatch = url.match(imgurRegex);
            if (imgurMatch) {
                return { 
                    type: 'image', 
                    url: `https://i.imgur.com/${imgurMatch[1]}${imgurMatch[2] || '.jpg'}` 
                };
            }

            if (/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(url)) {
                return { type: 'image', url: url };
            }

            return null;
        }

        function parseInput(input) {
    const lines = input.split('\n');
    const media = [];
    const tags = [];
    const contentLines = [];

    lines.forEach(originalLine => {
        // 改为更精确的段落保留逻辑
        const preservedLine = originalLine
            .replace(/(#\w+)/g, 'SPLIT_MARKER$1SPLIT_MARKER') // 标记标签
            .replace(/(https?:\/\/\S+)/gi, 'SPLIT_MARKER$1SPLIT_MARKER') // 标记链接
            .split('SPLIT_MARKER');

        let lineContent = '';
        preservedLine.forEach(segment => {
            if (!segment) return;
            
            // 检测媒体链接
            const mediaType = detectMediaType(segment);
            if (mediaType) {
                media.push(mediaType);
                return;
            }

            // 检测标签
            if (segment.startsWith('#')) {
                tags.push(segment.slice(1));
                return;
            }

            // 保留原始内容（包含空格）
            lineContent += segment;
        });
        
        contentLines.push(lineContent); // 保留原始换行和空格
    });

    return {
        content: contentLines.join('\n').replace(/\n+$/,''),
        media,
        tags
    };
}

        function addPost() {
    const modal = document.querySelector('.modal');
    const textarea = modal.querySelector('#content');
    const input = textarea.value;

    const { content, media, tags } = parseInput(input);

    tags.forEach(tag => allTags.add(tag));
    posts.unshift({
        id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        content,
        media,
        tags,
        lastModified: Date.now()
    });

    if (saveToLocalStorage()) {
        renderTags();
        renderPosts(posts); // 只渲染非置顶区
        modal.style.display = 'none';
        textarea.value = '';
    } else {
        alert('保存失败，请重试');
    }
}

        // 修改后的 renderTags 函数
function renderTags() {
    const tagContainer = document.getElementById('tagFilter');
    tagContainer.innerHTML = '<div class="tag" onclick="clearFilter()">全部</div>';
    
    // 将 allTags 转换为数组并随机排序
    const shuffledTags = Array.from(allTags).sort(() => Math.random() - 0.5);
    
    shuffledTags.forEach(tag => {
        const tagElement = document.createElement('div');
        tagElement.className = 'tag' + (currentFilterTag === tag ? ' active' : '');
        tagElement.textContent = tag;
        tagElement.onclick = () => filterByTag(tag);
        tagContainer.appendChild(tagElement);
    });
}

function filterByTag(tag) {
    currentFilterTag = tag;
    renderPosts(posts.filter(p => p.tags.includes(tag)));
    renderTags(); // 重新渲染标签以确保 active 状态更新
}

function clearFilter() {
    currentFilterTag = null;
    renderPosts(posts);
    renderTags();
}

function createPostElement(post, mediaStates) {
    const postElement = document.createElement('div');
    postElement.className = 'post';
    postElement.dataset.id = post.id;

    const actions = document.createElement('div');
    actions.className = 'post-actions';
    const isPinned = JSON.parse(localStorage.getItem('pinnedPosts') || '[]').includes(post.id);
    actions.innerHTML = `
        ${isPinned ? 
            `<button onclick="moveDownPinnedPost('${post.id}')" title="下移">↓</button>` : 
            `<button onclick="if(confirm('确定要删除此帖子吗？')) deletePost('${post.id}')" title="删除">×</button>`}
        <button onclick="editPost('${post.id}')" title="编辑">✎</button>
        <button onclick="togglePinPost('${post.id}')" title="${isPinned ? '取消置顶' : '置顶'}">P</button>
    `;
    postElement.appendChild(actions);

        if (post.content) {
        try {
            // 使用临时容器解析内容
            const tempContainer = document.createElement('div');
            // 修改引用处理逻辑：合并连续引用行
            let content = post.content
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/__([^_]+)__/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/_([^_]+)_/g, '<em>$1</em>')
                .replace(/~([^~]+)~/g, '<del>$1</del>')
                .replace(/^>\s*\*{3,}\s*$/gm, '<hr class="blockquote-divider">')
                // 合并连续引用行
                .replace(/(^>\s*.+?(?:\n>\s*.+?)*)(?=\n[^>\n]|\n$|$)/gms, (match) => {
                    // 将连续引用行合并为单个 blockquote
                    const lines = match.split('\n').map(line => line.replace(/^>\s*/, '')).join('<br>');
                    return `<blockquote>${lines}</blockquote>`;
                });

            tempContainer.innerHTML = content;

            // 处理临时容器的子节点
            Array.from(tempContainer.childNodes).forEach(node => {
                if (node.nodeName === 'BLOCKQUOTE') {
                    // 处理引用
                    const blockquote = document.createElement('blockquote');
                    blockquote.innerHTML = node.innerHTML.replace(/\n/g, '<br>');
                    postElement.appendChild(blockquote);
                } else if (node.nodeName === 'IFRAME') {
                    // 处理 iframe
                    const iframeContainer = document.createElement('div');
                    iframeContainer.className = 'post-iframe';
                    iframeContainer.appendChild(node.cloneNode(true));
                    postElement.appendChild(iframeContainer);
                } else {
                    // 处理正文（包括文本、strong、em、del 等）
                    const contentDiv = document.createElement('pre');
                    contentDiv.className = 'post-content';
                    contentDiv.style.whiteSpace = 'pre-wrap';
                    contentDiv.style.wordWrap = 'break-word';
                    contentDiv.style.margin = '0';
                    contentDiv.style.fontFamily = 'inherit';
                    if (node.nodeType === Node.TEXT_NODE) {
                        contentDiv.textContent = node.textContent;
                    } else {
                        contentDiv.appendChild(node.cloneNode(true));
                    }
                    if (contentDiv.textContent.trim() || contentDiv.children.length) {
                        postElement.appendChild(contentDiv);
                    }
                }
            });
        } catch (error) {
            console.error('渲染帖子内容失败:', error, 'Content:', post.content);
            // 回退：显示原始内容
            const contentDiv = document.createElement('pre');
            contentDiv.className = 'post-content';
            contentDiv.style.whiteSpace = 'pre-wrap';
            contentDiv.style.wordWrap = 'break-word';
            contentDiv.style.margin = '0';
            contentDiv.style.fontFamily = 'inherit';
            contentDiv.textContent = post.content;
            postElement.appendChild(contentDiv);
        }
    }


 if (post.media && post.media.length) {
        const mediaContainer = document.createElement('div');
        mediaContainer.className = 'post-media';

        post.media.forEach(media => {
            // 为置顶副本和原帖子分配唯一媒体 ID
            const mediaId = `${post.id}-${media.type}-${Math.random().toString(36).substr(2, 9)}`;
   if (media.type === 'okru') {
    mediaContainer.style.margin = '0';
    mediaContainer.style.display = 'block'; // 添加这行
    mediaContainer.style.lineHeight = '0'; // 添加这行，消除行高造成的空隙

    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.aspectRatio = '4/3';
    container.style.cursor = 'pointer';
    container.classList.add('okru-container');
    container.style.overflow = 'hidden'; // 隐藏溢出部分
    
    // 从帖子内容中提取多个海报URL
    const postContent = post.content;
    const posterMatches = [...postContent.matchAll(/<!--\s*poster="([^"]+)"\s*-->/g)];
    
    if (posterMatches.length > 0) {
        const posterUrls = posterMatches.map(match => match[1]);
        
        // 创建滑动容器
        const slideContainer = document.createElement('div');
        slideContainer.style.position = 'absolute';
        slideContainer.style.top = '0';
        slideContainer.style.left = '0';
        slideContainer.style.width = `${posterUrls.length * 100}%`; // 总宽度为所有图片宽度之和
        slideContainer.style.height = '100%';
        slideContainer.style.display = 'flex';
        slideContainer.style.transition = 'transform 0.2s ease'; // 快速滑动效果
        
        // 创建所有图片
        posterUrls.forEach(url => {
            const imageWrapper = document.createElement('div');
            imageWrapper.style.width = `${100 / posterUrls.length}%`; // 每张图片占总宽度的相等份额
            imageWrapper.style.height = '100%';
            
            const thumbnail = document.createElement('img');
            thumbnail.style.width = '100%';
            thumbnail.style.height = '100%';
            thumbnail.style.objectFit = 'cover';
            thumbnail.src = url;
            
            imageWrapper.appendChild(thumbnail);
            slideContainer.appendChild(imageWrapper);
        });
        
        container.appendChild(slideContainer);
        
        // 创建半透明遮罩
        const overlay = document.createElement('div');
        overlay.style.position = 'absolute';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0, 0, 0, 0.2)';
        overlay.style.zIndex = '1';
        container.appendChild(overlay);
        
        // 创建播放按钮
        const playButton = document.createElement('div');
        playButton.style.position = 'absolute';
        playButton.style.top = '50%';
        playButton.style.left = '50%';
        playButton.style.transform = 'translate(-50%, -50%)';
        playButton.style.width = '60px';
        playButton.style.height = '60px';
        playButton.style.display = 'flex';
        playButton.style.alignItems = 'center';
        playButton.style.justifyContent = 'center';
        playButton.style.zIndex = '2';
        
        // 创建播放图标
        const playIcon = document.createElement('div');
        playIcon.style.width = '0';
        playIcon.style.height = '0';
        playIcon.style.borderStyle = 'solid';
        playIcon.style.borderWidth = '10px 0 10px 18px';
        playIcon.classList.add('okru-play-icon');
        playIcon.style.marginLeft = '5px';
        
        playButton.appendChild(playIcon);
        container.appendChild(playButton);

        // 如果有多个海报，添加自动轮播
        if (posterUrls.length > 1) {
            let currentIndex = 0;
            
            // 切换函数
            const switchPoster = () => {
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * posterUrls.length);
    } while (newIndex === currentIndex && posterUrls.length > 1);
    
    currentIndex = newIndex;
    slideContainer.style.transform = `translateX(-${(100 / posterUrls.length) * currentIndex}%)`;
};

            // 自动轮播，10秒切换一次
            setInterval(switchPoster, 10000);
        }
        
        // 点击播放视频
        container.onclick = () => {
            const iframe = document.createElement('iframe');
            const videoId = media.url.split('/videoembed/')[1];
            
            const wrapperDiv = document.createElement('div');
            wrapperDiv.style.position = 'relative';
            wrapperDiv.style.width = '100%';
            wrapperDiv.style.aspectRatio = '4/3';
            wrapperDiv.style.overflow = 'hidden';
            
            iframe.src = `https://ok.ru/videoembed/${videoId}?autoplay=1`;
            iframe.style.position = 'absolute';
            iframe.style.top = '0';
            iframe.style.left = '0';
            iframe.style.width = '133.33%';
            iframe.style.height = '100%';
            iframe.style.transform = 'translate(-50%, -50%)';
            iframe.style.border = 'none';
            iframe.setAttribute('allowfullscreen', '');
            iframe.setAttribute('allow', 'autoplay');
            
            wrapperDiv.appendChild(iframe);
            container.innerHTML = '';
            container.appendChild(wrapperDiv);
        };
        
    } else {
        // 如果没有海报，使用默认iframe
        const iframe = document.createElement('iframe');
        const videoId = media.url.split('/videoembed/')[1];
        
        iframe.src = `https://ok.ru/videoembed/${videoId}`;
        iframe.style.position = 'absolute';
        iframe.style.top = '0';
        iframe.style.left = '0';
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.setAttribute('allowfullscreen', '');
        
        container.appendChild(iframe);
    }
    
    mediaContainer.appendChild(container);
}
		    if (media.type === 'video') { // 检测视频类型
                    const container = document.createElement('div');
                    container.style.position = 'relative';
                    container.style.width = '100%';
                    container.style.aspectRatio = '16/9'; // 16:9比例
                    container.style.overflow = 'hidden';

                    const video = document.createElement('video');
                    audio.dataset.mediaId = mediaId; // 使用唯一 ID
                    video.src = media.url;
                    video.controls = true; // 添加控制按钮
                    video.style.width = '100%'; // 设置为100%宽度
                    video.style.height = '100%'; // 设置为100%高度
                    video.setAttribute('allowfullscreen', ''); // 允许全屏

                    container.appendChild(video);
                    mediaContainer.appendChild(container);
		    }
                if (media.type === 'image') {
    // 查找或创建专门的图片轮播容器
    let imageSlideContainer = mediaContainer.querySelector('.image-slide-container');
    if (!imageSlideContainer) {
        imageSlideContainer = document.createElement('div');
        imageSlideContainer.className = 'image-slide-container';
        imageSlideContainer.style.position = 'relative';
        imageSlideContainer.style.width = '100%';
        imageSlideContainer.style.overflow = 'hidden';
        
        // 创建图片包装器
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.transition = 'transform 0.5s ease';
        wrapper.style.width = '100%';
        
        imageSlideContainer.appendChild(wrapper);
        mediaContainer.appendChild(imageSlideContainer);
    }
    
    const wrapper = imageSlideContainer.querySelector('div');
    
    // 创建图片容器
    const imgContainer = document.createElement('div');
    imgContainer.style.flex = '0 0 100%';
    imgContainer.style.width = '100%';
    
    // 添加图片
    const img = document.createElement('img');
    img.src = media.url;
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    
    imgContainer.appendChild(img);
    wrapper.appendChild(imgContainer);
}

// 在处理完所有媒体后设置轮播
const imageCount = post.media.filter(m => m.type === 'image').length;
if (imageCount > 1) {
    const imageSlideContainer = mediaContainer.querySelector('.image-slide-container');
    if (imageSlideContainer) {
        const wrapper = imageSlideContainer.querySelector('div');
        
        // 添加随机初始页
        const initialSlide = Math.floor(Math.random() * imageCount);
        let currentSlide = initialSlide;
        
        // 设置初始位置
        wrapper.style.transform = `translateX(-${initialSlide * 100}%)`;
        
        // 自动轮播函数
        function autoSlide() {
            currentSlide = (currentSlide + 1) % imageCount;
            wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        }
        
        // 设置20秒轮播间隔
        setInterval(autoSlide, 50000);
    }
}
                
       if (media.type === 'audio') {
    const audioContainer = document.createElement('div');
    audioContainer.style.position = 'relative';
    audioContainer.style.width = '100%';
    audioContainer.style.height = '30px';
    audioContainer.style.display = 'flex';
    audioContainer.style.alignItems = 'center';
    audioContainer.style.gap = '0'; // 减少控件间距
    audioContainer.style.padding = '0'; // 减少内边距
    audioContainer.style.margin = '0'; // 移除外边距

    const audio = document.createElement('audio');
    audio.preload = 'metadata';
    audio.src = media.url;
    audio.dataset.mediaId = mediaId

    // 自定义控件容器
    const customControls = document.createElement('div');
    customControls.style.width = '100%';
    customControls.style.height = '30px';
    customControls.style.display = 'flex';
    customControls.style.alignItems = 'center';
    customControls.classList.add('custom-controls');
    customControls.style.borderRadius = '5px';
    customControls.style.gap = '0'; // 减少控件间距
    customControls.style.padding = '0'; // 移除内边距
    customControls.style.margin = '0'; // 移除外边距

    // 播放/暂停按钮
    const playButton = document.createElement('button');
    playButton.innerHTML = '▶';
    playButton.style.backgroundColor = 'transparent';
    playButton.style.border = 'none';
    playButton.classList.add('play-button');
    playButton.style.cursor = 'pointer';
    playButton.style.padding = '0';
    playButton.style.margin = '0';
    playButton.style.width = '20px'; // 固定宽度
    playButton.style.height = '20px';
    playButton.style.display = 'flex';
    playButton.style.alignItems = 'center';
    playButton.style.justifyContent = 'center';

    // 进度条
    const progressBar = document.createElement('input');
    progressBar.type = 'range';
    progressBar.value = 0;
    progressBar.min = 0;
    progressBar.max = 100;
    progressBar.step = 0.1;
    progressBar.style.flex = '1';
    progressBar.style.margin = '0 5px'; // 减少进度条边距
    progressBar.style.padding = '0'; // 移除内边距

    // 时间显示
    const timeDisplay = document.createElement('span');
    timeDisplay.style.fontFamily = 'Arial, sans-serif';
    timeDisplay.classList.add('time-display');
    timeDisplay.style.fontSize = '9px';
    timeDisplay.style.whiteSpace = 'nowrap';
    timeDisplay.style.minWidth = '60px'; // 减少最小宽度
    timeDisplay.style.display = 'inline-block';
    timeDisplay.style.textAlign = 'right';
    timeDisplay.style.flexShrink = '0';
    timeDisplay.style.padding = '0 2px'; // 减少内边距
    timeDisplay.style.marginLeft = '0'; // 移除左边距

    // 初始设置为0:00 / 0:00
    timeDisplay.textContent = '0:00-0:00';

    // 添加元数据加载事件
    audio.addEventListener('loadedmetadata', () => {
        const totalMinutes = Math.floor(audio.duration / 60);
        const totalSeconds = Math.floor(audio.duration % 60);
        timeDisplay.textContent = `0:00-${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
    });

    // 播放/暂停逻辑
    playButton.onclick = () => {
        if (audio.paused) {
            audio.play();
            playButton.innerHTML = '❚❚';
        } else {
            audio.pause();
            playButton.innerHTML = '▶';
        }
    };

    // 更新进度条和时间显示
    audio.addEventListener('timeupdate', () => {
        const percentage = (audio.currentTime / audio.duration) * 100;
        progressBar.value = percentage;
        
        const currentMinutes = Math.floor(audio.currentTime / 60);
        const currentSeconds = Math.floor(audio.currentTime % 60);
        const totalMinutes = Math.floor(audio.duration / 60);
        const totalSeconds = Math.floor(audio.duration % 60);
        
        timeDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}-${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
    });

    // 拖动进度条调整播放位置
    progressBar.addEventListener('input', () => {
        const time = (progressBar.value / 100) * audio.duration;
        audio.currentTime = time;
    });

    // 组装控件
    customControls.appendChild(playButton);
    customControls.appendChild(progressBar);
    customControls.appendChild(timeDisplay);
    
    audioContainer.appendChild(audio);
    audioContainer.appendChild(customControls);
    mediaContainer.appendChild(audioContainer);
}



                
             if (media.type === 'bilibili') {
    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.aspectRatio = '4/3';
    container.style.overflow = 'hidden';
    
    const iframe = document.createElement('iframe');
    iframe.src = `${media.url}&high_quality=1&quality=4&qn=112&autoplay=0&danmaku=0`;
    iframe.dataset.mediaId = mediaId;
    iframe.style.position = 'absolute';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '133.33%';
    iframe.style.height = '100%';
    iframe.style.transform = 'translate(-50%, -50%)';
    iframe.style.border = 'none';
    iframe.setAttribute('allowfullscreen', 'true');
    
    // 添加样式来隐藏右上角提示
    const style = document.createElement('style');
    style.textContent = `
        .bilibili-player-video-top,
        .bilibili-player-video-info,
        .bilibili-player-video-info-hover,
        .bilibili-player-video-info-switch-btn,
        .bilibili-player-video-info-container {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
    `;
    container.appendChild(style);
    container.appendChild(iframe);
    mediaContainer.appendChild(container);
}

              
if (media.type === 'youtube') {
    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.cursor = 'pointer';
    container.style.backgroundColor = 'transparent';
    
    // 创建缩略图
    const thumbnail = document.createElement('img');
    const videoId = media.url.split('/').pop();
    thumbnail.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    thumbnail.style.width = '100%';
    thumbnail.style.display = 'block';
    
    
    // 添加播放图标
    const playIcon = document.createElement('div');
    playIcon.style.position = 'absolute';
    playIcon.style.bottom = '15px';
    playIcon.style.right = '15px';
    playIcon.style.width = '0';
    playIcon.style.height = '0';
    playIcon.style.borderTop = '8px solid transparent';
    playIcon.style.borderBottom = '8px solid transparent';
    playIcon.classList.add('youtube-play-icon');
    
    // 点击时替换为iframe
    container.onclick = () => {
    const iframe = document.createElement('iframe');
    const videoId = media.url.match(/(?:\/|v=)([a-zA-Z0-9_-]{11})/)[1];
    
    // 创建一个新的包装容器
    const wrapperDiv = document.createElement('div');
    wrapperDiv.style.position = 'relative';
    wrapperDiv.style.width = '100%';
    wrapperDiv.style.aspectRatio = '4/3'; // 设置4:3的容器比例
    wrapperDiv.style.overflow = 'hidden'; // 确保超出部分被裁剪
    
    // 设置iframe样式
    iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1`;
    iframe.style.position = 'absolute';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '133.33%'; // 4:3容器中显示16:9内容需要的宽度
    iframe.style.height = '100%';
    iframe.style.transform = 'translate(-50%, -50%)'; // 居中
    iframe.style.border = 'none';
    iframe.setAttribute('allowfullscreen', '');
    iframe.setAttribute('allow', 'autoplay');
    
    // 将iframe添加到包装容器中
    wrapperDiv.appendChild(iframe);
    
    // 清空原容器并添加新的包装容器
    container.innerHTML = '';
    container.appendChild(wrapperDiv);
    };
    
    container.appendChild(thumbnail);
    container.appendChild(playIcon);
    mediaContainer.appendChild(container);
}
        });

        postElement.appendChild(mediaContainer);
    }

    // 恢复播放状态
    if (mediaStates[post.id]) {
        setTimeout(() => {
            const media = postElement.querySelector('.post-media audio, .post-media video');
            if (media) {
                media.currentTime = mediaStates[post.id].time;
                if (mediaStates[post.id].playing) media.play();
            }
        }, 0);
    }

    return postElement;
}


        function renderPosts(postsToRender) {
    // 保存播放状态
    const mediaStates = {};
    document.querySelectorAll('.post-media audio, .post-media video').forEach(media => {
        const postId = media.closest('.post').dataset.id;
        mediaStates[postId] = {
            time: media.currentTime,
            playing: !media.paused
        };
    });

    // 获取置顶帖子ID
    let pinnedPostIds = new Set(JSON.parse(localStorage.getItem('pinnedPosts') || '[]'));

    // 确定要渲染的帖子
    if (!postsToRender) {
        if (currentSearchTerm) {
            postsToRender = posts.filter(p =>
                p.content.toLowerCase().includes(currentSearchTerm) ||
                p.tags.some(t => t.toLowerCase().includes(currentSearchTerm))
            );
        } else if (currentFilterTag) {
            postsToRender = posts.filter(p => p.tags.includes(currentFilterTag));
        } else {
            postsToRender = posts;
        }
    }

    // 筛选非置顶帖子
    const nonPinnedPosts = postsToRender.filter(p => !pinnedPostIds.has(p.id));

    // 渲染主帖子区域
    const container = document.getElementById('postsContainer');
    const postsPerPage = 50;
    const totalPages = Math.ceil(nonPinnedPosts.length / postsPerPage);
    if (!window.currentPage) window.currentPage = 1;
    const startIndex = (window.currentPage - 1) * postsPerPage;
    const endIndex = startIndex + postsPerPage;
    const currentPosts = nonPinnedPosts.slice(startIndex, endIndex);

    // 获取现有非置顶帖子
    const existingPosts = document.querySelectorAll('.post:not([data-pinned])');
    const existingPostIds = new Set(Array.from(existingPosts).map(post => post.dataset.id));

    // 移除不再需要的帖子（保留播放中的帖子）
    existingPosts.forEach(postElement => {
        const postId = postElement.dataset.id;
        const isInCurrentPage = currentPosts.some(p => p.id === postId);
        const isPlaying = mediaStates[postId]?.playing;
        if (!isInCurrentPage && !isPlaying) {
            postElement.remove();
        }
    });

    // 渲染主帖子
    currentPosts.forEach(post => {
        if (document.querySelector(`.post[data-id="${post.id}"]:not([data-pinned])`)) return;
        const postElement = createPostElement(post, mediaStates);
        container.appendChild(postElement);
    });

    // 渲染分页
    const pagination = document.createElement('div');
    pagination.className = 'pagination';
    let pageNumbers = [];
    if (totalPages <= 7) {
        pageNumbers = Array.from({length: totalPages}, (_, i) => i + 1);
    } else {
        if (window.currentPage <= 3) {
            pageNumbers = [1, 2, 3, 4, '...', totalPages];
        } else if (window.currentPage >= totalPages - 2) {
            pageNumbers = [1, '...', totalPages-3, totalPages-2, totalPages-1, totalPages];
        } else {
            pageNumbers = [1, '...', window.currentPage-1, window.currentPage, window.currentPage+1, '...', totalPages];
        }
    }

    pageNumbers.forEach(num => {
        const pageElement = document.createElement('span');
        pageElement.className = 'page-number';
        if (num === '...') {
            pageElement.textContent = '...';
        } else {
            pageElement.textContent = num;
            if (num === window.currentPage) {
                pageElement.classList.add('active');
            }
            pageElement.onclick = () => {
                window.currentPage = num;
                renderPosts(postsToRender);
                document.documentElement.scrollTo({ top: 0, behavior: 'smooth' });
            };
        }
        pagination.appendChild(pageElement);
    });

    // 确保分页在postsContainer之后
    const existingPagination = container.querySelector('.pagination');
    if (existingPagination) existingPagination.remove();
    container.appendChild(pagination);
}
        
        function renderPinnedPosts() {
    const pinnedContainer = document.getElementById('pinnedContainer');
    const pinnedPostIds = new Set(JSON.parse(localStorage.getItem('pinnedPosts') || '[]'));

    // 保存播放状态
    const mediaStates = {};
    document.querySelectorAll('.post-media audio, .post-media video').forEach(media => {
        const postId = media.closest('.post').dataset.id;
        mediaStates[postId] = {
            time: media.currentTime,
            playing: !media.paused
        };
    });

    // 获取当前置顶区的帖子 ID
    const existingPosts = Array.from(pinnedContainer.querySelectorAll('.post')).map(post => post.dataset.id);
    const newPostIds = Array.from(pinnedPostIds);

    // 移除不存在的帖子
    existingPosts.forEach(postId => {
        if (!pinnedPostIds.has(postId)) {
            const postElement = pinnedContainer.querySelector(`.post[data-id="${postId}"]`);
            if (postElement) postElement.remove();
        }
    });

    // 添加或更新帖子，并保持顺序
    newPostIds.forEach((postId, index) => {
        const post = posts.find(p => p.id === postId);
        if (!post) return;

        const existingPostElement = pinnedContainer.querySelector(`.post[data-id="${postId}"]`);
        const newPostElement = createPostElement(post, mediaStates);
        newPostElement.dataset.pinned = 'true';

        if (existingPostElement) {
            // 如果帖子已存在，检查是否需要更新
            if (existingPostElement.innerHTML !== newPostElement.innerHTML) {
                pinnedContainer.replaceChild(newPostElement, existingPostElement);
            }
        } else {
            // 插入到正确位置
            if (index === 0) {
                pinnedContainer.prepend(newPostElement);
            } else {
                const prevPostElement = pinnedContainer.querySelector(`.post[data-id="${newPostIds[index - 1]}"]`);
                if (prevPostElement) {
                    prevPostElement.after(newPostElement);
                } else {
                    pinnedContainer.appendChild(newPostElement);
                }
            }
        }
    });

    pinnedContainer.classList.toggle('active', pinnedPostIds.size > 0);
}

function toggleEditMode() {
    isEditMode = !isEditMode; // 切换编辑模式状态
    document.body.classList.toggle('edit-mode', isEditMode); // 切换 body 的 edit-mode 类
}

function togglePinPost(postId) {
    let pinnedPostIds = new Set(JSON.parse(localStorage.getItem('pinnedPosts') || '[]'));
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    // 保存播放状态
    const mediaStates = {};
    document.querySelectorAll('.post-media audio, .post-media video').forEach(media => {
        const postId = media.closest('.post').dataset.id;
        mediaStates[postId] = {
            time: media.currentTime,
            playing: !media.paused
        };
    });

    const pinnedContainer = document.getElementById('pinnedContainer');
    const postsContainer = document.getElementById('postsContainer');

    if (pinnedPostIds.has(postId)) {
        // 取消置顶
        pinnedPostIds.delete(postId);

        // 移除非置顶区的副本
        const nonPinnedCopy = postsContainer.querySelector(`.post[data-id="${postId}"][data-copy="true"]`);
        if (nonPinnedCopy) nonPinnedCopy.remove();

        // 保存置顶帖子 ID
        localStorage.setItem('pinnedPosts', JSON.stringify([...pinnedPostIds]));

        // 重新渲染置顶区
        renderPinnedPosts();

        // 重新渲染非置顶区，根据当前过滤条件
        if (currentSearchTerm) {
            searchPosts();
        } else if (currentFilterTag) {
            renderPosts(posts.filter(p => p.tags.includes(currentFilterTag)));
        } else {
            renderPosts(posts);
        }
    } else {
        // 置顶
        pinnedPostIds.add(postId);
        const originalPostElement = document.querySelector(`.post[data-id="${postId}"]:not([data-pinned])`);
        if (originalPostElement) {
            // 移动原帖子到置顶区
            originalPostElement.dataset.pinned = 'true';
            pinnedContainer.insertBefore(originalPostElement, pinnedContainer.firstChild);

            // 在原位置生成副本
            const copyElement = createPostElement(post, {});
            copyElement.dataset.copy = 'true';
            const allPosts = Array.from(postsContainer.querySelectorAll('.post:not([data-pinned])'));
            const postIndex = allPosts.findIndex(el => el === originalPostElement);
            if (postIndex >= 0) {
                postsContainer.insertBefore(copyElement, allPosts[postIndex]);
            } else {
                postsContainer.appendChild(copyElement);
            }

            // 更新置顶区显示状态
            pinnedContainer.classList.add('active');
        } else {
            // 如果原帖子不存在，创建新副本
            const postElement = createPostElement(post, mediaStates);
            postElement.dataset.pinned = 'true';
            pinnedContainer.insertBefore(postElement, pinnedContainer.firstChild);
            pinnedContainer.classList.add('active');
        }

        // 保存置顶帖子 ID
        localStorage.setItem('pinnedPosts', JSON.stringify([...pinnedPostIds]));
    }

    // 更新置顶按钮的 title 属性
    document.querySelectorAll(`.post[data-id="${postId}"] .post-actions button[title]`).forEach(button => {
        button.title = pinnedPostIds.has(postId) ? '取消置顶' : '置顶';
    });
}

function moveDownPinnedPost(postId) {
    const pinnedPostIds = JSON.parse(localStorage.getItem('pinnedPosts') || '[]');
    const index = pinnedPostIds.indexOf(postId);

    if (index === -1 || index === pinnedPostIds.length - 1) {
        return;
    }

    // 交换数组中的顺序
    [pinnedPostIds[index], pinnedPostIds[index + 1]] = [pinnedPostIds[index + 1], pinnedPostIds[index]];
    localStorage.setItem('pinnedPosts', JSON.stringify(pinnedPostIds));

    // 直接操作 DOM 交换帖子
    const pinnedContainer = document.getElementById('pinnedContainer');
    const currentPost = pinnedContainer.querySelector(`.post[data-id="${postId}"]`);
    const nextPost = currentPost.nextElementSibling;
    if (currentPost && nextPost) {
        pinnedContainer.insertBefore(nextPost, currentPost);
    }
}

function togglePinMode() {
    const pinnedContainer = document.getElementById('pinnedContainer');
    const postsContainer = document.getElementById('postsContainer');
    
    // 计算单列宽度
    const postsContainerWidth = postsContainer.offsetWidth;
    const columnGap = parseFloat(getComputedStyle(postsContainer).columnGap) || 7.5;
    const computedStyle = getComputedStyle(postsContainer);
    const columnCount = parseInt(computedStyle.columnCount || computedStyle.webkitColumnCount || 3);
    const singleColumnWidth = (postsContainerWidth - (columnCount - 1) * columnGap) / columnCount;
    
    // 设置宽度
    pinnedContainer.style.setProperty('--single-column-width', `${singleColumnWidth}px`);
    
    // 切换固定模式
    pinnedContainer.classList.toggle('fixed');
    
    // 更新按钮图标
    const toggleBtn = document.querySelector('.toggle-pin-mode-btn');
    toggleBtn.textContent = pinnedContainer.classList.contains('fixed') ? '☂' : '☄';
}



function deletePost(postId) {
    // Remove post from posts array
    posts = posts.filter(p => p.id !== postId);

    // Remove from pinned posts if present
    let pinnedPostIds = new Set(JSON.parse(localStorage.getItem('pinnedPosts') || '[]'));
    if (pinnedPostIds.has(postId)) {
        pinnedPostIds.delete(postId);
        localStorage.setItem('pinnedPosts', JSON.stringify([...pinnedPostIds]));
    }

    // Update tags
    allTags.clear();
    posts.forEach(post => {
        post.tags.forEach(tag => allTags.add(tag));
    });

    // Save changes to localStorage
    if (saveToLocalStorage()) {
        // Remove post from DOM (both pinned and non-pinned)
        document.querySelectorAll(`.post[data-id="${postId}"]`).forEach(postElement => {
            postElement.remove();
        });

        // Update pinned container visibility
        const pinnedContainer = document.getElementById('pinnedContainer');
        pinnedContainer.classList.toggle('active', pinnedPostIds.size > 0);

        // Re-render tags and posts
        renderTags();
        if (currentSearchTerm) {
            searchPosts();
        } else if (currentFilterTag) {
            renderPosts(posts.filter(p => p.tags.includes(currentFilterTag)));
        } else {
            renderPosts(posts);
        }
    } else {
        alert('删除失败，请重试');
    }
}
// 新增编辑功能
function editPost(postId) {
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    toggleModal(true);
    const modal = document.querySelector('.modal');
    const textarea = modal.querySelector('#content');
    const saveBtn = modal.querySelector('#saveBtn');

    const mediaUrls = post.media.map(m => {
        if (m.original) return m.original;
        if (m.type === 'youtube') {
            const videoId = m.url.split('/').pop().split('?')[0];
            return `https://youtu.be/${videoId}`;
        } else if (m.type === 'bilibili') {
            const bvid = new URL(m.url).searchParams.get('bvid');
            return `https://www.bilibili.com/video/${bvid}/`;
        } else if (m.type === 'okru') {
            const videoId = m.url.split('/videoembed/')[1];
            return `https://ok.ru/video/${videoId}`;
        }
        return m.url;
    });

    textarea.value = [
        post.content,
        ...mediaUrls,
        ...post.tags.map(t => `#${t}`)
    ].join('\n');

    saveBtn.onclick = () => {
        const { content, media, tags } = parseInput(textarea.value);
        Object.assign(post, {
            content,
            media,
            tags,
            id: postId,
            lastModified: Date.now()
        });
        if (saveToLocalStorage()) {
            // 保存置顶区当前播放状态
            const mediaStates = {};
            const pinnedContainer = document.getElementById('pinnedContainer');
            const pinnedPostElement = pinnedContainer.querySelector(`.post[data-id="${postId}"]`);
            if (pinnedPostElement) {
                const media = pinnedPostElement.querySelector('.post-media audio, .post-media video');
                if (media) {
                    mediaStates[postId] = {
                        time: media.currentTime,
                        playing: !media.paused
                    };
                }
                // 更新置顶区（原帖或副本）
                const newElement = createPostElement(post, mediaStates);
                newElement.dataset.pinned = 'true';
                if (pinnedPostElement.dataset.moved) newElement.dataset.moved = 'true';
                pinnedContainer.replaceChild(newElement, pinnedPostElement);
            }

            // 更新非置顶区
            const postsContainer = document.getElementById('postsContainer');
            const nonPinnedPostElement = postsContainer.querySelector(`.post[data-id="${postId}"]:not([data-pinned])`);
            if (nonPinnedPostElement) {
                const newElement = createPostElement(post, {}); // 不播放
                postsContainer.replaceChild(newElement, nonPinnedPostElement);
            }

            // 刷新非置顶区（如果在搜索或标签过滤模式下）
            if (currentSearchTerm) {
                searchPosts();
            } else if (currentFilterTag) {
                renderPosts(posts.filter(p => p.tags.includes(currentFilterTag)));
            } else {
                renderPosts(posts);
            }
            modal.style.display = 'none';
        } else {
            alert('保存失败，请重试');
        }
    };
}
  

// 在现有JavaScript代码末尾添加以下函数
function showTagManager() {
    const tagManager = document.getElementById('tagManager');
    const tagList = document.getElementById('tagList');
    tagList.innerHTML = '';
    
    // 获取每个标签的使用次数
    const tagCounts = {};
    Array.from(allTags).forEach(tag => {
        tagCounts[tag] = posts.filter(post => post.tags.includes(tag)).length;
    });
    
    // 显示标签列表
    Array.from(allTags).sort().forEach(tag => {
        const tagItem = document.createElement('div');
        tagItem.className = 'tag-item';
        tagItem.innerHTML = `
            <span>${tag}</span>
            <div style="display:flex;align-items:center;">
                <span class="tag-count">使用次数: ${tagCounts[tag]}</span>
                <div class="tag-actions">
                    <button onclick="renameTag('${tag}')" style="background:rgb(var(--theme-highlight));color:rgba(var(--theme-background));border:none;padding:4px 8px;border-radius:3px;">重命名</button>
                    <button onclick="deleteTag('${tag}')" style="background:rgb(var(--theme-highlight));rgba(var(--theme-background));border:none;padding:4px 8px;border-radius:3px;">删除</button>
                </div>
            </div>
        `;
        tagList.appendChild(tagItem);
    });
    
    tagManager.style.display = 'block';
}

function renameTag(oldTag) {
    const newTag = prompt(`请输入新的标签名称（当前：${oldTag}）：`);
    if (newTag && newTag !== oldTag) {
        posts.forEach(post => {
            const tagIndex = post.tags.indexOf(oldTag);
            if (tagIndex !== -1) {
                post.tags[tagIndex] = newTag;
            }
        });
        
        allTags.delete(oldTag);
        allTags.add(newTag);
        
        if (saveToLocalStorage()) {
            renderTags();
            renderPosts(posts);
            showTagManager();
        } else {
            alert('保存失败，请重试');
        }
    }
}



function deleteTag(tag) {
    if (confirm(`确定要删除标签"${tag}"吗？`)) {
        posts.forEach(post => {
            post.tags = post.tags.filter(t => t !== tag);
        });
        
        allTags.delete(tag);
        
        if (saveToLocalStorage()) {
            renderTags();
            renderPosts(posts);
            showTagManager();
        } else {
            alert('保存失败，请重试');
        }
    }
}


function cleanUnusedTags() {
    const usedTags = new Set();
    posts.forEach(post => {
        post.tags.forEach(tag => usedTags.add(tag));
    });
    
    const unusedTags = Array.from(allTags).filter(tag => !usedTags.has(tag));
    if (unusedTags.length === 0) {
        alert('没有找到未使用的标签！');
        return;
    }
    
    if (confirm(`发现 ${unusedTags.length} 个未使用的标签，是否清理？\n${unusedTags.join(', ')}`)) {
        unusedTags.forEach(tag => allTags.delete(tag));
        
        // 保存更新
        localStorage.setItem('tags', JSON.stringify([...allTags]));
        
        // 刷新显示
        renderTags();
        showTagManager();
    }
}
function searchPosts() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    currentSearchTerm = searchInput;
    if (!searchInput) {
        currentSearchTerm = null;
        renderPosts(posts);
        return;
    }

    // 判断分隔符类型：包含斜杠则按OR逻辑，否则按AND逻辑
    const isOR = searchInput.includes('/');
    const separator = isOR ? '/' : /\s+/; // 选择分隔符
    
    // 分割关键词（兼容连续分隔符）
    const keywords = searchInput.split(separator)
        .map(k => k.trim())
        .filter(k => k !== '');

    const filteredPosts = posts.filter(post => {
        // 根据逻辑类型选择匹配方式
        return isOR ? 
            // OR逻辑：任意关键词匹配
            keywords.some(keyword => checkKeywordMatch(post, keyword)) : 
            // AND逻辑：所有关键词必须匹配
            keywords.every(keyword => checkKeywordMatch(post, keyword));
    });

    renderPosts(filteredPosts);
}

// 封装关键词匹配逻辑
function checkKeywordMatch(post, keyword) {
    const contentMatch = post.content && post.content.toLowerCase().includes(keyword);
    const tagMatch = post.tags && post.tags.some(tag => tag.toLowerCase().includes(keyword));
    return contentMatch || tagMatch;
}

// 添加回车键搜索功能
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchPosts(); // 触发修改后的搜索逻辑
    }
});
function exportPosts() {
    const data = {
        posts: posts.map(post => ({
            ...post,
            lastModified: post.lastModified || Date.now() // 确保旧数据也有时间戳
        })),
        tags: Array.from(allTags)
    };
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `posts_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// 在importPosts函数中添加冲突检测和提示逻辑
async function importPosts(input) {
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
      try {
          const data = JSON.parse(e.target.result);
            
          let updatedCount = 0;
          const newPosts = [];
          const conflictList = [];
            
          // 第一阶段：收集冲突
          data.posts.forEach(importedPost => {
              if (!importedPost.lastModified) {
                  importedPost.lastModified = Date.now();
              }
                
              const existingIndex = posts.findIndex(p => p.id === importedPost.id);
              if (existingIndex >= 0) {
                    const existingPost = posts[existingIndex];
                    
                    // 检查是否是真正的冲突（内容不同且都有编辑历史）
                    const isRealConflict = () => {
                        // 基本字段比较
                        const basicFieldsDiff = 
                            importedPost.content !== existingPost.content ||
                            JSON.stringify(importedPost.tags) !== JSON.stringify(existingPost.tags) ||
                            JSON.stringify(importedPost.media) !== JSON.stringify(existingPost.media);
                        
                        // 都有编辑历史
                        const bothEdited = importedPost.lastModified && existingPost.lastModified;
                        
                        return basicFieldsDiff && bothEdited;
                    };

                    if (isRealConflict()) {
                        conflictList.push({
                            imported: importedPost,
                            existing: existingPost,
                            index: existingIndex,
                            // 添加冲突类型标识
                            type: 'content'
                        });
                    } else if (!isRealConflict() && importedPost.lastModified > existingPost.lastModified) {
                        // 没有真正冲突但导入版本较新，自动更新
                        posts[existingIndex] = importedPost;
                        updatedCount++;
                    }
                } else {
                    newPosts.push(importedPost);
                }
                // ▲▲▲ 添加结束 ▲▲▲
            });

            // 第二阶段：处理冲突
            for (const conflict of conflictList) {
                const userChoice = await showConflictDialog(conflict);
                if (userChoice === 'import') {
                    posts[conflict.index] = conflict.imported;
                    updatedCount++;
                }
                // 选择"保留"则不做任何操作
            }
            
            // 第三阶段：合并数据
            posts = [...posts, ...newPosts];
            data.tags.forEach(tag => allTags.add(tag));
            
            if (saveToLocalStorage()) {
                renderTags();
                renderPosts(posts);
                alert(`导入完成！\n新增帖子：${newPosts.length}\n更新帖子：${updatedCount}\n解决冲突：${conflictList.length}`);
            }
        } catch(err) {
            alert('导入失败：' + err.message);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// 新增冲突对比对话框
function showConflictDialog(conflict) {
    return new Promise((resolve) => {
        const dialog = document.createElement('div');
        dialog.style.position = 'fixed';
        dialog.style.top = '50%';
        dialog.style.left = '50%';
        dialog.style.transform = 'translate(-50%, -50%)';
        dialog.classList.add('conflict-dialog');
        dialog.style.padding = '20px';
        dialog.style.borderRadius = '10px';
        dialog.style.zIndex = '10000';
        dialog.style.maxWidth = '90vw';
        
        // 对比内容生成
        const diffHtml = generateDiffHtml(conflict.existing, conflict.imported);
        
        dialog.innerHTML = `
         <h3 class="conflict-title">发现内容冲突</h3>
            ${diffHtml}
 <div style="display:flex;justify-content:space-between;margin-top:20px;">
    <button onclick="this.parentElement.parentElement.resolution('keep')" 
        class="conflict-btn";border:none;padding:6px 15px;border-radius:5px;">
        保留当前版本
    </button>
    <button onclick="this.parentElement.parentElement.resolution('import')" 
        style="background:#ba5757;color:white;border:none;padding:6px 15px;border-radius:5px;margin-left:auto;">
        使用导入版本
    </button>
</div>

        `;
        
        // 自定义决议方法
        dialog.resolution = (choice) => {
            document.body.removeChild(dialog);
            resolve(choice);
        };
        
        document.body.appendChild(dialog);
    });
}

// 生成对比HTML
function generateDiffHtml(current, imported) {
  // 只显示实际有差异的字段
  const diffFields = [
      { name: 'content', title: '内容' },
      { name: 'tags', title: '标签', format: v => JSON.stringify(v, null, 2) },
      { name: 'media', title: '媒体', format: v => JSON.stringify(v, null, 2) }
  ].filter(field => {
      const currentVal = field.format ? field.format(current[field.name]) : current[field.name];
      const importedVal = field.format ? field.format(imported[field.name]) : imported[field.name];
      return currentVal !== importedVal;
  });

  if (diffFields.length === 0) {
      return `<div style="color:rgb(var(--theme-foreground));">ID相同但未检测到内容差异</div>`;
  }

  const diffSections = diffFields.map(field => {
      const currentVal = field.format ? field.format(current[field.name]) : current[field.name];
      const importedVal = field.format ? field.format(imported[field.name]) : imported[field.name];
        
      return `
          <div class="diff-section">
              <div class="diff-title">${field.title}对比</div>
              <div class="diff-row">
                  <div class="diff-version" style="border-right:1px solid #ba5757;">
                      <div class="diff-header">当前版本</div>
                      <div class="diff-content">${currentVal}</div>
                  </div>
                  <div class="diff-version">
                      <div class="diff-header">导入版本</div>
                      <div class="diff-content">${importedVal}</div>
                  </div>
              </div>
          </div>
      `;
  }).join('');

  return `
<style>
    .diff-row { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
        margin: 10px 0; 
    }
    .diff-header { 
        color: rgb(var(--theme-foreground));
        margin-bottom: 5px; 
        font-size: 14px;
    }
    .diff-content {
        background: rgba(0,0,0,0.3); 
        padding: 10px;
        margin: 0; 
        max-height: 200px; 
        overflow: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 12px;
        line-height: 1.5;
        border-radius: 3px;
    }
    .diff-section {
        margin-bottom: 15px;
    }
    .diff-title {
        color: rgb(var(--theme-highlight));
        font-size: 13px;
        margin-bottom: 5px;
        padding-bottom: 3px;
        border-bottom: 1px solid rgb(var(--theme-foreground));
    }
</style>

      ${diffSections}
      <div style="color:#888;margin-top:10px;">
          当前版本修改时间：${new Date(current.lastModified).toLocaleString()}<br>
          导入版本修改时间：${new Date(imported.lastModified).toLocaleString()}
      </div>
  `;
}



function saveToLocalStorage() {
    try {
        const uniqueIds = new Set(posts.map(p => p.id));
        if (uniqueIds.size !== posts.length) {
            console.error('发现重复ID');
            return false;
        }
        localStorage.setItem('posts', JSON.stringify(posts));
        localStorage.setItem('tags', JSON.stringify([...allTags]));
        return true;
    } catch (error) {
        console.error('保存失败:', error);
        return false;
    }
}
if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/notes-pwa/sw.js')
        .then(reg => console.log('SW registered', reg))
        .catch(err => console.error('SW failed', err));
    }
    window.addEventListener('beforeinstallprompt', e => {
      console.log('PWA 可安装');
    });
    
    // 主题管理相关变量
let themes = JSON.parse(localStorage.getItem('themes') || '{}');
let currentThemeName = 'default';

// 显示主题设置模态框
function showThemeSettings() {
    const themeManager = document.getElementById('themeManager');
    const themeSelect = document.getElementById('themeSelect');
    
    themeSelect.innerHTML = '<option value="">选择已有主题</option>';
    Object.keys(themes).forEach(themeName => {
        const option = document.createElement('option');
        option.value = themeName;
        option.textContent = themeName;
        themeSelect.appendChild(option);
    });

    updateThemeSettingsUI();
    themeManager.style.display = 'block';

    document.getElementById('backgroundType').addEventListener('change', toggleBackgroundSettings);
    document.getElementById('enableRain').addEventListener('change', toggleRainSettings);
    document.getElementById('backgroundMedia').addEventListener('input', toggleBackgroundSettings);
    document.getElementById('glassOpacity').addEventListener('input', () => {
        document.getElementById('glassOpacityValue').textContent = document.getElementById('glassOpacity').value;
    });
    document.getElementById('glassBlur').addEventListener('input', () => {
        document.getElementById('glassBlurValue').textContent = document.getElementById('glassBlur').value;
    });
    document.getElementById('videoSpeed').addEventListener('input', () => {
        document.getElementById('videoSpeedValue').textContent = document.getElementById('videoSpeed').value;
    });
    document.getElementById('rainCount').addEventListener('input', () => {
        document.getElementById('rainCountValue').textContent = document.getElementById('rainCount').value;
    });
    document.getElementById('rainSpeed').addEventListener('input', () => {
        document.getElementById('rainSpeedValue').textContent = document.getElementById('rainSpeed').value;
    });
    document.getElementById('postLetterSpacing').addEventListener('input', () => {
        document.getElementById('postLetterSpacingValue').textContent = document.getElementById('postLetterSpacing').value;
    });
    document.getElementById('postLineHeight').addEventListener('input', () => {
        document.getElementById('postLineHeightValue').textContent = document.getElementById('postLineHeight').value;
    });
    document.getElementById('postTextScaleX').addEventListener('input', () => {
        document.getElementById('postTextScaleXValue').textContent = document.getElementById('postTextScaleX').value;
    });
    document.getElementById('postFontSize').addEventListener('input', () => {
        document.getElementById('postFontSizeValue').textContent = document.getElementById('postFontSize').value;
    });

    // 实时更新字体设置
    ['postLetterSpacing', 'postLineHeight', 'postTextScaleX', 'postFontSize'].forEach(id => {
        const element = document.getElementById(id);
        const newElement = element.cloneNode(true);
        element.parentNode.replaceChild(newElement, element);
        newElement.addEventListener('input', () => {
            const theme = themes[currentThemeName] || themes['default'];
            theme.postLetterSpacing = parseFloat(document.getElementById('postLetterSpacing').value);
            theme.postLineHeight = parseFloat(document.getElementById('postLineHeight').value);
            theme.postTextScaleX = parseFloat(document.getElementById('postTextScaleX').value);
            theme.postContainerWidthScale = parseFloat(document.getElementById('postTextScaleX').value); // 同步
            theme.postFontSize = parseInt(document.getElementById('postFontSize').value);
            applyTheme();
        });
    });
}

// 更新主题设置UI
function updateThemeSettingsUI() {
    const theme = themes[currentThemeName] || {
        backgroundType: 'solid',
        solidBackgroundColor: '#1d1d5c',
        backgroundMedia: '',
        glassOpacity: 0.6,
        glassBlur: 7,
        videoSpeed: 1,
        enableRain: false,
        rainCount: 100,
        rainSpeed: 2,
        themeBackground: '#1d1d5c',
        themeForeground: '#ba5757',
        themeSecondary: '#a8a8e4',
        themeHighlight: '#f7ebeb',
        postLetterSpacing: 0.3,
        postLineHeight: 1.7,
        postTextScaleX: 1,
        postContainerWidthScale: 1, // 新增
        postFontSize: 16
    };

    document.getElementById('themeName').value = currentThemeName;
    document.getElementById('backgroundType').value = theme.backgroundType;
    document.getElementById('solidBackgroundColor').value = theme.solidBackgroundColor;
    document.getElementById('backgroundMedia').value = theme.backgroundMedia;
    document.getElementById('glassOpacity').value = theme.glassOpacity;
    document.getElementById('glassBlur').value = theme.glassBlur;
    document.getElementById('glassOpacityValue').textContent = theme.glassOpacity;
    document.getElementById('glassBlurValue').textContent = theme.glassBlur;
    document.getElementById('videoSpeed').value = theme.videoSpeed;
    document.getElementById('videoSpeedValue').textContent = theme.videoSpeed;
    document.getElementById('enableRain').checked = theme.enableRain;
    document.getElementById('rainCount').value = theme.rainCount;
    document.getElementById('rainCountValue').textContent = theme.rainCount;
    document.getElementById('rainSpeed').value = theme.rainSpeed;
    document.getElementById('rainSpeedValue').textContent = theme.rainSpeed;
    document.getElementById('themeBackground').value = theme.themeBackground;
    document.getElementById('themeForeground').value = theme.themeForeground;
    document.getElementById('themeSecondary').value = theme.themeSecondary;
    document.getElementById('themeHighlight').value = theme.themeHighlight;
    document.getElementById('postLetterSpacing').value = theme.postLetterSpacing;
    document.getElementById('postLetterSpacingValue').textContent = theme.postLetterSpacing;
    document.getElementById('postLineHeight').value = theme.postLineHeight;
    document.getElementById('postLineHeightValue').textContent = theme.postLineHeight;
    document.getElementById('postTextScaleX').value = theme.postTextScaleX;
    document.getElementById('postTextScaleXValue').textContent = theme.postTextScaleX;
    document.getElementById('postFontSize').value = theme.postFontSize;
    document.getElementById('postFontSizeValue').textContent = theme.postFontSize;

    toggleBackgroundSettings();
    toggleRainSettings();
    applyTheme();
}

// 切换背景类型设置显示
function toggleBackgroundSettings() {
    const backgroundType = document.getElementById('backgroundType').value;
    document.getElementById('solidColorSettings').style.display = backgroundType === 'solid' ? 'block' : 'none';
    document.getElementById('glassSettings').style.display = backgroundType === 'glass' ? 'block' : 'none';
    document.getElementById('videoSpeedSettings').style.display = backgroundType === 'glass' && isVideoUrl(document.getElementById('backgroundMedia').value) ? 'block' : 'none';
}

// 切换雨滴设置显示
function toggleRainSettings() {
    const enableRain = document.getElementById('enableRain').checked;
    document.getElementById('rainSettings').style.display = enableRain ? 'block' : 'none';
}

// 判断是否为视频URL
function isVideoUrl(url) {
    return url.match(/\.(mp4|webm|ogg)$/i);
}

// 创建雨滴效果
function createRain(count, speed) {
    const rainContainer = document.querySelector('.rain-container');
    rainContainer.innerHTML = ''; // 清空现有雨滴
    for (let i = 0; i < count; i++) {
        const rain = document.createElement('div');
        rain.classList.add('rain');
        rain.style.left = `${Math.random() * 100}vw`;
        rain.style.animationDuration = `${Math.random() * (speed * 0.5) + (speed * 0.5)}s`;
        rain.style.animationDelay = `${Math.random() * 5}s`;
        rainContainer.appendChild(rain);
    }
}

// 保存主题
function saveTheme() {
    const themeName = document.getElementById('themeName').value.trim();
    if (!themeName) {
        alert('请输入主题名称');
        return;
    }

    const theme = {
        backgroundType: document.getElementById('backgroundType').value,
        solidBackgroundColor: document.getElementById('solidBackgroundColor').value,
        backgroundMedia: document.getElementById('backgroundMedia').value,
        glassOpacity: parseFloat(document.getElementById('glassOpacity').value),
        glassBlur: parseInt(document.getElementById('glassBlur').value),
        videoSpeed: parseFloat(document.getElementById('videoSpeed').value),
        enableRain: document.getElementById('enableRain').checked,
        rainCount: parseInt(document.getElementById('rainCount').value),
        rainSpeed: parseFloat(document.getElementById('rainSpeed').value),
        themeBackground: document.getElementById('themeBackground').value,
        themeForeground: document.getElementById('themeForeground').value,
        themeSecondary: document.getElementById('themeSecondary').value,
        themeHighlight: document.getElementById('themeHighlight').value,
        postLetterSpacing: parseFloat(document.getElementById('postLetterSpacing').value),
        postLineHeight: parseFloat(document.getElementById('postLineHeight').value),
        postTextScaleX: parseFloat(document.getElementById('postTextScaleX').value),
        postContainerWidthScale: parseFloat(document.getElementById('postTextScaleX').value), // 同步
        postFontSize: parseInt(document.getElementById('postFontSize').value)
    };

    themes[themeName] = theme;
    localStorage.setItem('themes', JSON.stringify(themes));
    currentThemeName = themeName;

    const themeSelect = document.getElementById('themeSelect');
    if (!themeSelect.querySelector(`option[value="${themeName}"]`)) {
        const option = document.createElement('option');
        option.value = themeName;
        option.textContent = themeName;
        themeSelect.appendChild(option);
    }
    themeSelect.value = themeName;

    alert('主题保存成功');
}

// 应用主题
function applyTheme(themeName = currentThemeName) {
    const theme = themes[themeName] || themes['default'] || {
        backgroundType: 'solid',
        solidBackgroundColor: '#1d1d5c',
        backgroundMedia: '',
        glassOpacity: 0.6,
        glassBlur: 7,
        videoSpeed: 1,
        enableRain: false,
        rainCount: 100,
        rainSpeed: 2,
        themeBackground: '#1d1d5c',
        themeForeground: '#ba5757',
        themeSecondary: '#a8a8e4',
        themeHighlight: '#f7ebeb',
        postLetterSpacing: 0.3,
        postLineHeight: 1.7,
        postTextScaleX: 1,
        postContainerWidthScale: 1,
        postFontSize: 16,
        postFontUrl: '',
        postFontName: 'CustomFont'
    };

    const root = document.documentElement;
    const bgColor = hexToRgb(theme.themeBackground);
    const fgColor = hexToRgb(theme.themeForeground);
    const secColor = hexToRgb(theme.themeSecondary);
    const hiColor = hexToRgb(theme.themeHighlight);

    root.style.setProperty('--theme-background', `${bgColor.r}, ${bgColor.g}, ${bgColor.b}`);
    root.style.setProperty('--theme-foreground', `${fgColor.r}, ${fgColor.g}, ${fgColor.b}`);
    root.style.setProperty('--theme-secondary', `${secColor.r}, ${secColor.g}, ${secColor.b}`);
    root.style.setProperty('--theme-highlight', `${hiColor.r}, ${hiColor.g}, ${hiColor.b}`);
    root.style.setProperty('--glass-background', `${bgColor.r}, ${bgColor.g}, ${bgColor.b}`);
    root.style.setProperty('--glass-opacity', theme.glassOpacity);
    root.style.setProperty('--glass-blur', `${theme.glassBlur}px`);
    root.style.setProperty('--post-letter-spacing', `${theme.postLetterSpacing}px`);
    root.style.setProperty('--post-line-height', theme.postLineHeight);
    root.style.setProperty('--post-text-scale-x', theme.postTextScaleX);
    root.style.setProperty('--post-container-width-scale', theme.postContainerWidthScale);
    root.style.setProperty('--post-font-size', `${theme.postFontSize}px`);

    // 动态加载字体
    if (theme.postFontUrl && theme.postFontUrl.endsWith('.woff2')) {
        const fontName = theme.postFontName || 'CustomFont';
        const existingFontStyle = document.getElementById('dynamic-font');
        if (existingFontStyle) existingFontStyle.remove();
        const fontStyle = document.createElement('style');
        fontStyle.id = 'dynamic-font';
        fontStyle.textContent = `
            @font-face {
                font-family: "${fontName}";
                src: url("${theme.postFontUrl}") format("woff2");
                font-weight: normal;
                font-style: normal;
            }
            .post-content {
                font-family: "${fontName}", sans-serif !important;
            }
        `;
        document.head.appendChild(fontStyle);
        const fontTest = new FontFace(fontName, `url(${theme.postFontUrl})`, {
            style: 'normal',
            weight: 'normal'
        });
        fontTest.load().then(() => {
            document.fonts.add(fontTest);
        }).catch(error => {
            console.warn(`字体加载失败: ${theme.postFontUrl}`, error);
            document.querySelectorAll('.post-content').forEach(el => {
                el.style.fontFamily = 'inherit';
            });
        });
    } else {
        document.querySelectorAll('.post-content').forEach(el => {
            el.style.fontFamily = 'inherit';
        });
        const existingFontStyle = document.getElementById('dynamic-font');
        if (existingFontStyle) existingFontStyle.remove();
    }

    // 应用正文缩放
    document.querySelectorAll('.post-content').forEach(el => {
        el.style.transform = `scaleX(${theme.postTextScaleX})`;
        el.style.width = `calc(100% / ${theme.postContainerWidthScale})`;
    });

    // 重置 blockquote 样式
    document.querySelectorAll('.post blockquote').forEach(el => {
        el.style.transform = 'none';
        el.style.width = '100%';
        el.style.fontFamily = 'Arial, sans-serif';
    });

    // 重置 iframe 和 post-iframe 样式
    document.querySelectorAll('.post iframe, .post-iframe').forEach(el => {
        el.style.transform = 'none';
        el.style.width = '100%';
    });

    updateManifest();

    let bgContainer = document.querySelector('.background-media-container');
    if (bgContainer) bgContainer.remove();
    root.classList.remove('glass-background');
    document.querySelector('.rain-container').innerHTML = '';

    if (theme.backgroundType === 'solid') {
        document.body.style.background = theme.solidBackgroundColor;
        document.body.style.backgroundImage = 'none';
    } else {
        root.classList.add('glass-background');
        if (theme.backgroundMedia) {
            bgContainer = document.createElement('div');
            bgContainer.className = 'background-media-container';
            document.body.appendChild(bgContainer);

            if (isVideoUrl(theme.backgroundMedia)) {
                const video = document.createElement('video');
                video.src = theme.backgroundMedia;
                video.autoplay = true;
                video.loop = true;
                video.muted = true;
                video.playbackRate = theme.videoSpeed;
                bgContainer.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = theme.backgroundMedia;
                bgContainer.appendChild(img);
            }
        }

        if (theme.enableRain) {
            createRain(theme.rainCount, theme.rainSpeed);
        }
    }

    currentThemeName = themeName;
}

function hexToRgb(hex) {
    hex = hex.replace('#', '');
    const r = parseInt(hex.length === 3 ? hex[0] + hex[0] : hex.slice(0, 2), 16);
    const g = parseInt(hex.length === 3 ? hex[1] + hex[1] : hex.slice(2, 4), 16);
    const b = parseInt(hex.length === 3 ? hex[2] + hex[2] : hex.slice(4, 6), 16);
    return { r, g, b };
}

function updateManifest() {
    const theme = themes[currentThemeName] || themes['default'];
    const bgColor = hexToRgb(theme.themeBackground);
    const manifest = {
        name: "赛博日记本",
        short_name: "Brood",
        start_url: "/notes-pwa/index.html",
        scope: "/notes-pwa/",
        display: "standalone",
        background_color: `rgb(${bgColor.r}, ${bgColor.g}, ${bgColor.b})`,
        theme_color: `rgb(${bgColor.r}, ${bgColor.g}, ${bgColor.b})`,
        icons: [
            {
                src: "/notes-pwa/images/placeholder.png",
                sizes: "878x878",
                type: "image/png",
                purpose: "any"
            }
        ]
    };

    const manifestLink = document.querySelector('link[rel="manifest"]');
    if (manifestLink.dataset.blobUrl) {
        URL.revokeObjectURL(manifestLink.dataset.blobUrl);
    }
    const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob) + `#t=${Date.now()}`; // 添加时间戳避免缓存
    manifestLink.dataset.blobUrl = url;
    manifestLink.setAttribute('href', url);

    // 强制 Service Worker 更新
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(reg => reg.update());
        });
    }
}

// 在页面加载时初始化 manifest
document.addEventListener('DOMContentLoaded', () => {
    updateManifest();
    initAudioPlayer();
});




// 导出主题
function exportThemes() {
    const blob = new Blob([JSON.stringify(themes)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `themes_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// 导入主题
function importThemes(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedThemes = JSON.parse(e.target.result);
            Object.keys(importedThemes).forEach(name => {
                themes[name] = importedThemes[name];
            });
            localStorage.setItem('themes', JSON.stringify(themes));
            alert('主题导入成功');
            showThemeSettings();
        } catch (err) {
            alert('导入失败：' + err.message);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// 主题选择切换
document.getElementById('themeSelect').addEventListener('change', function() {
    const themeName = this.value;
    if (themeName) {
        currentThemeName = themeName;
        updateThemeSettingsUI();
        applyTheme(themeName);
    }
});

// 初始化默认主题
document.addEventListener('DOMContentLoaded', () => {
    if (!themes['default']) {
themes['default'] = {
    backgroundType: 'solid',
    solidBackgroundColor: '#1d1d5c',
    backgroundMedia: '',
    glassOpacity: 0.6,
    glassBlur: 7,
    videoSpeed: 1,
    enableRain: false,
    rainCount: 100,
    rainSpeed: 2,
    themeBackground: '#1d1d5c',
    themeForeground: '#ba5757',
    themeSecondary: '#a8a8e4',
    themeHighlight: '#f7ebeb',
    postLetterSpacing: 0.3,
    postLineHeight: 1.7,
    postTextScaleX: 1, // 恢复
    postContainerWidthScale: 1, // 新增
    postFontSize: 12
};
        localStorage.setItem('themes', JSON.stringify(themes));
    }
    applyTheme('default');
});
</script>
</body>
</html>  
