<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1d1d5c">
	<title>ğŸŠ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
   <link rel="manifest" href="/notes-pwa/manifest.json">
 <style>
    	@font-face {
    font-family: 'KingHwa';
    src: url('/notes-pwa/fonts/KingHwa.woff') format('woff');
    font-weight: 200;
    font-style: normal;
    font-display: swap;
}
        body { 
            font-family: 'KingHwa', "KaiTi", serif;
            padding: 20px; 
            background-color: rgb(var(--theme-background));
            color: rgb(var(--theme-highlight));
            font-size: 11.5px;
           
    background-size: 4px 30px;
    background-position: -1px -1px;
        }
        .post pre, .post div {
    font-weight: 200;
}
/* é¡¶æ ï¼ˆæ ‡ç­¾è¿‡æ»¤å™¨ï¼‰ */
.tag-filter {
    display: flex;
    gap: 2px;
    margin-bottom: 20px;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgb(var(--theme-background)); /* é»˜è®¤çº¯è‰²èƒŒæ™¯ */
    z-index: 1000;
    padding: 10px 20px;
    padding-right: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    padding-bottom: 15px;
    height: auto;
    align-items: center;
    overflow-x: auto;
    white-space: nowrap;
    flex-wrap: nowrap;
    scrollbar-width: thin;
    scrollbar-color: rgba(var(--theme-background), 0.2) rgba(var(--theme-background), 0.2);
}

/* æ¯›ç»ç’ƒæ¨¡å¼ä¸‹çš„é¡¶æ  */
.glass-background .tag-filter {
    background: rgba(var(--glass-background, 28, 45, 34), var(--glass-opacity, 0.6));
    backdrop-filter: blur(var(--glass-blur, 7px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 7px));
}

/* åº•æ ï¼ˆåˆ†é¡µï¼‰ */
.pagination {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgb(var(--theme-background)); /* é»˜è®¤çº¯è‰²èƒŒæ™¯ */
    box-shadow: 0 -2px 5px rgba(0,0,0,0.3);
    padding: 4px 0;
    z-index: 998;
    margin: 0;
    width: 100%;
    transform: none !important;
    display: flex;
    justify-content: center;
    gap: 10px;
}

/* æ¯›ç»ç’ƒæ¨¡å¼ä¸‹çš„åº•æ  */
.glass-background .pagination {
    background: rgba(var(--glass-background, 28, 45, 34), var(--glass-opacity, 0.6));
    backdrop-filter: blur(var(--glass-blur, 7px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 7px));
}

/* é€šç”¨æŒ‰é’®æ ·å¼ */
.glass-button {
    background: rgb(var(--theme-background)); /* é»˜è®¤çº¯è‰²èƒŒæ™¯ */
    color: rgb(var(--theme-highlight));
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important;
}

/* æ¯›ç»ç’ƒæ¨¡å¼ä¸‹çš„æŒ‰é’® */
.glass-background .glass-button {
    background: rgba(var(--glass-background, 28, 45, 34), var(--glass-opacity, 0.6));
    backdrop-filter: blur(var(--glass-blur, 7px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 7px));
}

.add-btn {
    position: fixed;
    bottom: 50px;
    right: 30px;
    width: 45px;
    height: 45px;
    font-size: 24px;
    z-index: 1000;
}

.edit-btn {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 45px;
    height: 45px;
    font-size: 24px;
    z-index: 1000;
}

.theme-btn {
    position: fixed;
    bottom: 200px;
    right: 30px;
    width: 45px;
    height: 45px;
    font-size: 24px;
    z-index: 1000;
}

.tag-manager-btn {
    position: fixed;
    bottom: 150px;
    right: 30px;
    width: 45px;
    height: 45px;
    font-size: 24px;
    z-index: 1000;
}

.search-btn {
    width: 45px;
    height: 45px;
    font-size: 24px;
}

.export-btn, .import-btn, .toggle-pin-mode-btn {
    width: 45px;
    height: 45px;
    font-size: 20px;
    position: relative;
}

.tag-filter::after { /* æ–°å¢ä¼ªå…ƒç´  */
    content: "";
    display: inline-block;
    min-width: 20px;
    height: 1px;
}

/* é’ˆå¯¹Webkitæµè§ˆå™¨ï¼ˆChrome, Safariç­‰ï¼‰çš„æ»šåŠ¨æ¡æ ·å¼ */
.tag-filter::-webkit-scrollbar {
    height: 1px;
    background-color: rgb(var(--theme-background));
}

.tag-filter::-webkit-scrollbar-thumb {
    background-color: transparent; /* æ»‘å—é¢œè‰² - ä½¿ç”¨æ ‡ç­¾æ©™è‰² */
    border-radius: 1px;
    height: 1px;
}

.tag-filter::-webkit-scrollbar-track {
    background: rgb(var(--theme-background));
}

 .tag {
    background-color: transparent;
    color: rgb(var(--theme-foreground));
    font-size: 12px;
    padding: 5px 6px;
    cursor: pointer;
    border-radius: 3px;
    display: inline-block; /* ç¡®ä¿æ ‡ç­¾æ¨ªå‘æ’åˆ— */
    white-space: nowrap; /* é˜²æ­¢æ ‡ç­¾å†…æ–‡å­—æ¢è¡Œ */
}

.tag.active {
    background-color: transparent;
    font-weight: bold;
    text-decoration: underline;
    /* å°†å¤–é˜´å½±æ”¹ä¸ºå†…é˜´å½± */
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); /* ä½¿ç”¨insetå…³é”®å­—åˆ›å»ºå†…é˜´å½± */
    /* å¯é€‰ï¼šæ·»åŠ ä¸€ç‚¹æ–‡å­—å‡¹é™·æ•ˆæœ */
    text-shadow: 0 -1px 1px rgba(0,0,0,0.3);
}

   .posts-container { 
    column-count: 3;     /* åˆ†ä¸‰åˆ— */
    column-gap: 7.5px;  /* åˆ—é—´è· */
    margin-top: 40px; /* ç•™å‡ºé¡¶éƒ¨ç©ºé—´ */
    margin-bottom: 60px; /* ç•™å‡ºåº•éƒ¨ç©ºé—´ */
}
/* å¹³æ¿æ¨ªå±/å¤§å±è®¾å¤‡ */
@media (min-width: 1024px) {
    .posts-container {
        column-count: 3 !important;
    }
}

/* æ‰‹æœºè®¾å¤‡ */
@media (max-width: 550px) {
    .posts-container {
        column-count: 1 !important;
    }
}

/* å¹³æ¿åˆ†å±æ¨¡å¼é€‚é…ï¼ˆçº¦50%å®½åº¦æ—¶ä¿æŒä¸‰åˆ—ï¼‰*/
@media (min-width: 550px) and (max-width: 850px) {
    .posts-container {
        column-count: 2 !important;
    }
}
.post {
    break-inside: avoid; /* é˜²æ­¢å†…å®¹è·¨åˆ—æ–­å¼€ */
    margin-bottom: 0;/* æ›¿ä»£åŸgapé—´è· */
    width: 100%;         /* å æ»¡åˆ—å®½ */
    position: relative;
    z-index: 2;  /* å»ºç«‹æ–°çš„å±‚å ä¸Šä¸‹æ–‡å¹¶é«˜äºé®ç½© */
    /* ä¿æŒå…¶ä»–åŸæœ‰æ ·å¼ */
}
        .post { 
            background: transparent; /* å¸–å­èƒŒæ™¯ */
            padding: 10px;
            display: flex;
            flex-direction: column;
            line-height: 1.7;    /* å¢åŠ è¡Œè· */
    letter-spacing: 0.3px; /* å¢åŠ å­—é—´è· */
    /* å·²æœ‰æ ·å¼ä¿æŒä¸å˜ */
    padding-top: 0 !important;
    padding-bottom: 5px !important;
        }
        .post-actions {
    margin-top: 10px;
    display: none; /* é»˜è®¤éšè— */
}
.post-content {
    position: relative;
    z-index: 3;
    white-space: pre-wrap !important;
    word-break: break-word !important;
    font-family: inherit !important;
    margin: 0 !important;
    line-height: var(--post-line-height) !important;
    letter-spacing: var(--post-letter-spacing) !important;
    font-size: var(--post-font-size) !important;
    transform: scaleX(var(--post-text-scale-x)) !important;
    transform-origin: left !important;
    width: calc(100% / var(--post-container-width-scale)) !important;
    display: inline-block !important;
    box-sizing: border-box !important;
}

.post-iframe {
    width: 100% !important;
    transform: none !important;
    display: block !important;
    margin: 0.3em 0 !important;
}

.post iframe {
    width: 100% !important;
    transform: none !important;
    display: block !important;
    box-sizing: border-box !important;
}


.post-actions button {
    background-color: rgb(var(--theme-background)) !important;
    color: rgb(var(--theme-highlight)) !important;
    border: none;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 16px;
    padding: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3) !important;
}

.edit-mode .post-actions {
    display: flex;
    gap: 10px;
    justify-content: space-between; /* è®©æŒ‰é’®ä¸¤ç«¯å¯¹é½ */
}
        .post-media {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .post-media iframe {
            width: 100%;
            aspect-ratio: 4/3; /* ä»…è§†é¢‘ä¿æŒæ¯”ä¾‹ */
        }
        .post-media img {
            max-width: 100%;
            height: auto; /* å›¾ç‰‡è‡ªé€‚åº” */
        }
        
        
        /* æ–°å¢åˆ†é¡µå®šä½æ ·å¼ */
.posts-container {
    position: relative;
}

    

        /* æ–°å¢è¾“å…¥æ¡†æ ·å¼ */
        .add-btn {
            position: fixed;
            z-index: 1000;
            bottom: 50px;
            right: 30px;
            width: 45px;
            height: 45px;
            background: rgb(var(--theme-background));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            color: rgb(var(--theme-highlight));
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important; /* æ©™è‰²é˜´å½±æ•ˆæœ */
        }
        .edit-btn {
    position: fixed;
    z-index: 1000;
    bottom: 100px;  /* ä½äºæ·»åŠ æŒ‰é’®ä¸Šæ–¹ */
    right: 30px;
    width: 45px;
    height: 45px;
    background: rgb(var(--theme-background));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 24px;
    color: rgb(var(--theme-highlight));
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.8) !important; 
}
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgb(var(--theme-foreground));
            padding: 20px;
            border-radius: 10px;
            border: 0px solid rgb(var(--theme-background));
            width: 400px;
        }
   #content {
    width: 95%;
    height: 400px;
    background: transparent;
    border: none;
    outline: none;
    color: rgb(var(--theme-highlight));
    padding: 10px;
    margin-bottom: 10px;
    white-space: pre-wrap;
}
        .tag-manager {
        display: none;
        position: fixed;
        z-index: 999;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgb(var(--theme-foreground));
        padding: 20px;
        border-radius: 10px;
        border: 0px solid #000000;
        max-width: 80%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .tag-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        margin: 5px 0;
        border-bottom: 1px solid #000000;
    }

    .tag-count {
        color: rgb(var(--theme-highlight));
        font-size: 0.9em;
        margin-right: 10px;
    }

    .tag-actions {
        display: flex;
        gap: 5px;
    }
    .pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
   
}
.page-number {
    color: rgb(var(--theme-foreground));
    font-size: 12px;
    cursor: pointer;
    padding: 5px 10px;
}
.page-number.active {
    text-decoration: underline;
}
.post div {
    white-space: pre-wrap;
    word-wrap: break-word;
}
.youtube-container {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
}

.youtube-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}



.youtube-play-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: transparent;
    border: none;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
    color: rgb(var(--theme-highlight));
    font-size: 24px;
    z-index: 1;
}



/* é’ˆå¯¹æœç´¢æ¡†çš„placeholder */
#searchInput::placeholder { /* ç°ä»£æµè§ˆå™¨ */
    color: rgb(var(--theme-foreground));
    opacity: 0.4; /* ç¡®ä¿é¢œè‰²ä¸é€æ˜ */
}

#searchInput::-webkit-input-placeholder { /* Chrome/Safari */
    color: rgb(var(--theme-foreground));
}
#searchInput::-moz-placeholder { /* Firefox 19+ */
    color: rgb(var(--theme-foreground));
}
#searchInput:-ms-input-placeholder { /* IE 10+ */
    color: rgb(var(--theme-foreground));
}

/* é’ˆå¯¹æ¨¡æ€æ¡†è¾“å…¥åŒºçš„placeholder */
#content::placeholder {
    color: rgb(var(--theme-background));
    opacity: 0.4;
}
#content::-webkit-input-placeholder {
    color: rgb(var(--theme-background));
}
#content::-moz-placeholder {
    color: rgb(var(--theme-background));
}
#content:-ms-input-placeholder {
    color: rgb(var(--theme-background));
}
.bilibili-player-video-top,
.bilibili-player-video-info,
.bilibili-player-video-info-hover,
.bilibili-player-video-info-switch-btn,
.bilibili-player-video-info-container {
    display: none !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

/* é‡è®¾éŸ³é¢‘æ’­æ”¾å™¨æ•´ä½“æ ·å¼ */
audio::-webkit-media-controls-panel {
    background-color: rgb(var(--theme-background)) !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    min-width: unset !important; /* ç§»é™¤å›ºå®šæœ€å°å®½åº¦ */
    width: 100% !important;      /* å¼ºåˆ¶å®½åº¦è‡ªé€‚åº” */
}

/* æ’­æ”¾æŒ‰é’®å’ŒéŸ³é‡æŒ‰é’®æ ·å¼ */
audio::-webkit-media-controls-play-button,
audio::-webkit-media-controls-mute-button {
    filter: invert(0.1);
    flex: 0 0 auto !important; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
}
.play-button {
    margin-right: 8px !important;
}

/* æ—¶é—´æ˜¾ç¤ºæ ·å¼ */
audio::-webkit-media-controls-current-time-display,
audio::-webkit-media-controls-time-remaining-display {
    color: rgba(var(--theme-background));
    font-size: 11px !important;
    padding: 0 0px !important;
    flex: 0 0 auto !important; /* é˜²æ­¢æ—¶é—´æ˜¾ç¤ºè¢«å‹ç¼© */
    min-width: 35px !important; /* ç¡®ä¿æ—¶é—´æ˜¾ç¤ºæœ‰è¶³å¤Ÿç©ºé—´ */
    text-align: center !important;
}

/* è¿›åº¦æ¡æ ·å¼ */
audio::-webkit-media-controls-timeline {
    height: 1px !important;
    flex: 1 1 100px !important; /* å…è®¸è¿›åº¦æ¡ä¼¸ç¼©ä½†ä¿æŒæœ€å°å®½åº¦ */
}
audio::-webkit-media-controls-timeline-container,
audio::-webkit-media-controls-current-time-display,
audio::-webkit-media-controls-time-remaining-display {
    flex: 1 !important; /* å…è®¸æ—¶é—´æ˜¾ç¤ºåŒºåŸŸä¼¸ç¼© */
}
.audio-container {
    width: 100% !important;
    max-width: 100% !important;
}
.custom-controls {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0 1px !important; /* å¢åŠ å·¦å³é—´è· */
}
/* è¿›åº¦æ¡æ»‘å—æ ·å¼ */
audio::-webkit-slider-thumb {
    -webkit-appearance: none !important;
    width: 2px !important;
    height: 2px !important;
    background: rgb(var(--theme-foreground)) !important;
    border-radius: 50% !important;
    cursor: pointer !important;
    margin-top: -2px !important;
}

/* Firefoxæµè§ˆå™¨è¿›åº¦æ¡æ»‘å—æ ·å¼ */
audio::-moz-range-thumb {
    width: 2px !important;
    height: 2px !important;
    background: rgb(var(--theme-foreground)) !important;
    border-radius: 50% !important;
    cursor: pointer !important;
}
/* éŸ³é¢‘æ’­æ”¾å™¨è¿›åº¦æ¡æ ·å¼ */
input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 2px;
    background: rgb(var(--theme-background));
    border-radius: 1px;
    margin: 0 1px;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 4.5px;
    height: 4.5px;
    background: rgb(var(--theme-secondary));
    border-radius: 50%;
    cursor: pointer;
    margin-top: -1.5px;
}


input[type="range"]::-moz-range-thumb {
    width: 8px;
    height: 8px;
    background: rgb(var(--theme-foreground));
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

input[type="range"]::-webkit-slider-runnable-track {
  height: 1px !important;
  background: rgb(var(--theme-secondary), 0.2)!important;
}

input[type="range"]::-moz-range-track {
  height: 1px !important;
  background: rgba(var(--theme-foreground), 0.2); !important;
}




hr {
    border: 0;
    height: 0;
    border-top: 1px dashed rgba(var(--theme-secondary), 0.3); /* å¤‡ç”¨è™šçº¿æ ·å¼ */
    margin: 5px 0;
}
/* ä¸‹åˆ’çº¿æ ·å¼ */
.underline-divider {
    border-bottom: 1px solid rgb(var(--theme-secondary));
    margin: 3px 0 !important;
    width: 100%;
}

/* å¼•ç”¨æ¡†å†…è¡¥å¿ */
/* å¼•ç”¨æ¡†å†…æ°´å¹³çº¿è¡¥å¿ */
blockquote hr.blockquote-divider {
    border: none;
    border-top: 1px dashed rgba(var(--theme-secondary), 0.3);
    margin: 5px -8px; /* æŠµæ¶ˆå¼•ç”¨æ¡†çš„å†…è¾¹è· */
    width: calc(100% + 16px); /* æ‰©å±•å®½åº¦ä»¥å¯¹é½è§†è§‰è¾¹ç¼˜ */
}
.pinned-container {
    break-inside: avoid; /* é˜²æ­¢è¢«å¤šåˆ—åˆ†å‰² */
    break-before: column; /* å¼ºåˆ¶åœ¨ç¬¬ä¸€åˆ—å¼€å¤´ */
    display: block; /* ç‹¬å ä¸€è¡Œ */
    margin-bottom: 10px; /* ä¸ä¸‹æ–¹å¸–å­é—´è· */
    margin-left: 9px; /* å³ç§»2åƒç´ ï¼Œä¿®æ­£å·¦å */
    padding: 0px; /* ä¸.postä¸€è‡´ */
    padding-top: 0; /* åŒ¹é….postçš„padding-top */
    padding-bottom: 5px; /* åŒ¹é….postçš„padding-bottom */
    background: 
        repeating-linear-gradient(
            to bottom,
            transparent 0px,
            transparent 30px,
            rgba(var(--theme-foreground), 0.2) 30px,
            rgba(var(--theme-foreground), 0.2) 31px,
            transparent 31px,
            transparent 30px
        ),
        repeating-linear-gradient(
            to right,
            transparent 0px,
            transparent 30px,
            rgba(var(--theme-foreground), 0.2) 30px,
            rgba(var(--theme-foreground), 0.2) 31px,
            transparent 31px,
            transparent 30px
        );
    backdrop-filter: blur(4px); /* ç£¨ç ‚ç»ç’ƒæ¨¡ç³Šæ•ˆæœ */
    -webkit-backdrop-filter: blur(4px); /* å…¼å®¹ Webkit æµè§ˆå™¨ */
    position: relative;
    z-index: 3; /* é«˜äºå…¶ä»–å…ƒç´  */
    box-sizing: border-box;
    display: none; /* é»˜è®¤éšè— */
    width: 100%; /* é»˜è®¤å æ»¡åˆ—å®½ */
    
}

.pinned-container.active {
    display: block; /* æœ‰ç½®é¡¶å¸–å­æ—¶æ˜¾ç¤º */
}

.pinned-container.fixed {
    position: fixed; /* å›ºå®šå®šä½ */
    top: 50px; /* ç•™å‡ºé¡¶éƒ¨æ ‡ç­¾æ ç©ºé—´ */
    left: 20px; /* ä¸é¡µé¢å·¦è¾¹è·ä¸€è‡´ */
    width: var(--single-column-width, 100%); /* åŠ¨æ€å®½åº¦ï¼ŒåŒ¹é…å•åˆ— */
    background: 
        repeating-linear-gradient(
            to bottom,
            transparent 0px,
            transparent 30px,
            rgba(var(--theme-foreground), 0.2) 30px,
            rgba(var(--theme-foreground), 0.2) 31px,
            transparent 31px,
            transparent 30px
        ),
        repeating-linear-gradient(
            to right,
            transparent 0px,
            transparent 30px,
            rgba(var(--theme-foreground), 0.2) 30px,
            rgba(var(--theme-foreground), 0.2) 31px,
            transparent 31px,
            transparent 30px
        ),
        rgba(var(--theme-background), 0.2); /* åŠé€æ˜åº•è‰² */
    backdrop-filter: blur(4px); /* ç£¨ç ‚ç»ç’ƒæ¨¡ç³Šæ•ˆæœ */
    -webkit-backdrop-filter: blur(4px); /* å…¼å®¹ Webkit æµè§ˆå™¨ */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* æ·»åŠ é˜´å½±ä»¥çªå‡ºæ‚¬æµ®æ•ˆæœ */
    z-index: 900; /* ç¡®ä¿é«˜äºå…¶ä»–å…ƒç´  */
    margin-left: 18px; /* ç§»é™¤å·¦è¾¹è·ä»¥å¯¹é½ */
    max-height: 90vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œå…è®¸æ»šåŠ¨ */
    overflow-y: auto; /* å¯ç”¨å†…éƒ¨å‚ç›´æ»šåŠ¨ */
    scrollbar-width: 2px; /* ç»†æ»šåŠ¨æ¡ */
    scrollbar-color: rgba(var(--theme-background), 0.2);
}

/* Webkit æµè§ˆå™¨æ»šåŠ¨æ¡æ ·å¼ */
.pinned-container::-webkit-scrollbar {
    width: 1px;
}
.pinned-container::-webkit-scrollbar-thumb {
    background-color: rgba(var(--theme-background), 0.2);
    border-radius: 1px;
}
.pinned-container::-webkit-scrollbar-track {
    background: rgba(var(--theme-background), 0.2);
}

/* ç¡®ä¿ç½®é¡¶å¸–å­æ ·å¼ä¸€è‡´ */
.pinned-container .post {
    margin: 0;
    width: 100%;
    padding: 0px;
    padding-top: 0 !important;
    padding-bottom: 5px !important;
    box-sizing: border-box;
    background: transparent;
}


.okru-container {
    background-color: rgb(var(--theme-background));
}
.okru-play-icon {
    border-color: transparent transparent transparent rgba(var(--theme-highlight), 0.3);
}

.custom-controls {
    background-color: rgba(var(--theme-background), 0);
}
.play-button {
    color: rgb(var(--theme-secondary));
}
.time-display {
    color: rgba(var(--theme-secondary), 0.7);
}
.youtube-play-icon {
    border-left: 12px solid rgba(var(--theme-highlight), 0.2);
}
.conflict-dialog {
    background: rgb(var(--theme-background));
}
.conflict-title {
    color: rgb(var(--theme-foreground));
    margin: 0 0 15px 0;
}
.conflict-btn {
    background: rgb(var(--theme-highlight));
    color: rgb(var(--theme-background));
    border: none;
    padding: 6px 15px;
    border-radius: 5px;
}

/* ä¸»é¢˜ç®¡ç†å™¨æ»šåŠ¨æ¡æ ·å¼ */
.theme-manager::-webkit-scrollbar {
    width: 1px;
}
.theme-manager::-webkit-scrollbar-thumb {
    background-color: rgba(var(--theme-background), 0.2);
    border-radius: 1px;
}
.theme-manager::-webkit-scrollbar-track {
    background: rgba(var(--theme-background), 0.2);
}

/* èƒŒæ™¯åª’ä½“å®¹å™¨ */
.background-media-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -2; /* åœ¨æ¯›ç»ç’ƒä¹‹ä¸‹ */
    overflow: hidden;
}
.background-media-container img,
.background-media-container video {
    width: 100%;
    height: 100%;
    object-fit: cover; /* ç¡®ä¿è§†é¢‘/å›¾ç‰‡å¹³é“ºè¦†ç›– */
    position: absolute;
    top: 0;
    left: 0;
}

/* æ¯›ç»ç’ƒæ•ˆæœ */
.glass-background::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* åœ¨å†…å®¹ä¹‹ä¸‹ï¼ŒèƒŒæ™¯ä¹‹ä¸Š */
    background: rgba(var(--glass-background, 28, 45, 34), var(--glass-opacity, 0.6));
    backdrop-filter: blur(var(--glass-blur, 7px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 7px));
}

/* é›¨æ»´æ•ˆæœ */
.rain-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0; /* åœ¨æ¯›ç»ç’ƒä¹‹ä¸Šï¼Œå†…å®¹ä¹‹ä¸‹ */
    pointer-events: none; /* é˜²æ­¢é›¨æ»´å¹²æ‰°äº¤äº’ */
}
.rain {
    position: absolute;
    width: 2px;
    height: 20px;
    background: rgba(255, 255, 255, 0.5);
    animation: fall linear infinite;
}
@keyframes fall {
    0% {
        transform: translateY(-100vh);
        opacity: 1;
    }
    100% {
        transform: translateY(100vh);
        opacity: 0;
    }
}

/* æ›´æ–°ä¸»é¢˜å˜é‡ */
:root {
    --theme-background: 29, 29, 92; /* #1d1d5c */
    --theme-foreground: 186, 87, 87; /* #ba5757 */
    --theme-secondary: 168, 168, 228; /* #a8a8e4 */
    --theme-highlight: 247, 235, 235; /* #f7ebeb */
    --glass-background: 28, 45, 34; /* #1c2d22ï¼Œæ¯›ç»ç’ƒé»˜è®¤é¢œè‰² */
    --glass-opacity: 0.6; /* é»˜è®¤é€æ˜åº¦ */
    --glass-blur: 7px; /* é»˜è®¤æ¨¡ç³Šåº¦ */
    --post-letter-spacing: 0; /* å­—è· */
    --post-line-height: 1.7; /* è¡Œè· */
    --post-font-size: 12px; /* å­—ä½“å¤§å° */
    --post-text-scale-x: 1; /* æ–‡æœ¬æ°´å¹³ç¼©æ”¾æ¯”ä¾‹ */
    --post-container-width-scale: 1; /* æ–°å¢ï¼šå®¹å™¨å®½åº¦ç¼©æ”¾æ¯”ä¾‹ */
}

.search-box {
    position: fixed;
    bottom: 100px;
    left: 30px; /* è°ƒæ•´ä¸ºé å·¦ï¼Œç•™å‡ºè¾¹è· */
    z-index: 1000;
    display: flex;
    flex-direction: row; /* æ”¹ä¸º rowï¼Œç¡®ä¿æŒ‰é’®åœ¨è¾“å…¥æ¡†å·¦ä¾§ */
    align-items: center;
    gap: 5px;
}

.search-box input#searchInput {
    padding: 5px;
    border-radius: 3px;
    border: none;
    background: transparent;
    color: rgb(var(--theme-foreground));
    width: 150px; /* å›ºå®šå®½åº¦ï¼Œé¿å…æ‹‰ä¼¸ */
    outline: none;
}


.bottom-left-buttons {
    position: fixed;
    bottom: 50px;
    left: 30px;
    z-index: 999;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px; /* æŒ‰é’®é—´è· */
}

blockquote {
    border-left: 1.5px solid rgb(var(--theme-background));
    margin: 0.3em 0;
    padding: 4px 8px;
    color: rgb(var(--theme-secondary));
    background: rgba(var(--theme-background), 0.1);
    font-size: 9px !important;
    font-family: 'Arial, sans-serif' !important;
    font-weight: 400 !important;
    white-space: pre-wrap !important;
    line-height: 1.6 !important;
    display: block !important; /* æ”¹ä¸º blockï¼Œç¡®ä¿ç‹¬ç«‹å¸ƒå±€ */
    width: 100% !important; /* å›ºå®šå®½åº¦ */
    box-sizing: border-box !important;
    transform: none !important; /* ç¦æ­¢ä»»ä½•ç¼©æ”¾ */
    transform-origin: left !important; /* é˜²æ­¢çˆ¶çº§å½±å“ */
}


    </style>
</head>
<body>
	<!-- èƒŒæ™¯åª’ä½“å®¹å™¨ -->
    <div class="background-media-container"></div>
    <!-- é›¨æ»´å®¹å™¨ -->
    <div class="rain-container"></div>
	<div class="bottom-left-buttons">
    <button class="export-btn glass-button" onclick="exportPosts()">â‡©</button>
    <input type="file" id="importFile" style="display:none" onchange="importPosts(this)">
    <button class="import-btn glass-button" onclick="document.getElementById('importFile').click()">â‡§</button>
<button class="toggle-pin-mode-btn glass-button" onclick="togglePinMode()">â˜‚</button>
</div>

  <!-- åŸä»£ç  -->
<div class="add-btn glass-button" onclick="toggleModal(false)">+</div>
<!-- æ–°å¢ç¼–è¾‘æŒ‰é’® -->
<div class="edit-btn glass-button" onclick="toggleEditMode()">âœ</div>
<button class="theme-btn glass-button" onclick="showThemeSettings()" style="bottom:200px; right:30px;">â˜ƒ</button>
<div class="theme-manager" id="themeManager" style="display:none; position:fixed; z-index:1001; top:50%; left:50%; transform:translate(-50%,-50%); background:rgb(var(--theme-foreground)); padding:20px; border-radius:10px; max-width:90%; max-height:90vh; overflow-y:auto;">
    <h3 style="color:rgb(var(--theme-highlight)); margin-bottom:20px;">ä¸»é¢˜è®¾ç½®</h3>
    <div id="themeSettings">
        <div style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">ä¸»é¢˜åç§°ï¼š</label>
            <input type="text" id="themeName" placeholder="è¾“å…¥ä¸»é¢˜åç§°" style="padding:5px; border:none; background:rgba(0,0,0,0.1); color:rgb(var(--theme-highlight)); width:100%; border-radius:3px;">
        </div>
        <div style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">èƒŒæ™¯ç±»å‹ï¼š</label>
            <select id="backgroundType" style="padding:5px; border:none; background:rgba(0,0,0,0.1); color:rgb(var(--theme-highlight)); width:100%; border-radius:3px;">
                <option value="solid">çº¯è‰²èƒŒæ™¯</option>
                <option value="glass">æ¯›ç»ç’ƒèƒŒæ™¯</option>
            </select>
        </div>
        <div id="solidColorSettings" style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">çº¯è‰²èƒŒæ™¯é¢œè‰²ï¼š</label>
            <input type="color" id="solidBackgroundColor" style="width:100%; height:30px; border:none; cursor:pointer;">
        </div>
        <div id="glassSettings" style="display:none;">
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">æ¯›ç»ç’ƒèƒŒæ™¯é¢œè‰²ï¼š</label>
                <input type="color" id="glassBackgroundColor" value="#1c2d22" style="width:100%; height:30px; border:none; cursor:pointer;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">æ¯›ç»ç’ƒèƒŒæ™¯é€æ˜åº¦ï¼ˆ0-1ï¼‰ï¼š</label>
                <input type="range" id="glassOpacity" min="0" max="1" step="0.01" value="0.6" style="width:100%;">
                <span id="glassOpacityValue" style="color:rgb(var(--theme-highlight));">0.6</span>
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">æ¯›ç»ç’ƒæ¨¡ç³Šåº¦ï¼ˆpxï¼‰ï¼š</label>
                <input type="range" id="glassBlur" min="0" max="20" step="1" value="7" style="width:100%;">
                <span id="glassBlurValue" style="color:rgb(var(--theme-highlight));">7</span>
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">èƒŒæ™¯å›¾ç‰‡/è§†é¢‘/GIF URLï¼š</label>
                <input type="text" id="backgroundMedia" placeholder="è¾“å…¥å›¾ç‰‡ã€è§†é¢‘æˆ–GIFé“¾æ¥" style="padding:5px; border:none; background:rgba(0,0,0,0.1); color:rgb(var(--theme-highlight)); width:100%; border-radius:3px;">
            </div>
            <div id="videoSpeedSettings" style="display:none; margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">è§†é¢‘æ’­æ”¾é€Ÿåº¦ï¼ˆ0.1-2ï¼‰ï¼š</label>
                <input type="range" id="videoSpeed" min="0.1" max="2" step="0.1" value="1" style="width:100%;">
                <span id="videoSpeedValue" style="color:rgb(var(--theme-highlight));">1</span>
            </div>
            <div style="margin-bottom:15px;">
                <label style="color:rgb(var(--theme-highlight));">å¯ç”¨é›¨æ»´æ•ˆæœï¼š</label>
                <input type="checkbox" id="enableRain" style="margin-left:10px;">
            </div>
            <div id="rainSettings" style="display:none;">
                <div style="margin-bottom:15px;">
                    <label style="color:rgb(var(--theme-highlight));">é›¨æ»´æ•°é‡ï¼ˆ10-200ï¼‰ï¼š</label>
                    <input type="range" id="rainCount" min="10" max="200" step="1" value="100" style="width:100%;">
                    <span id="rainCountValue" style="color:rgb(var(--theme-highlight));">100</span>
                </div>
                <div style="margin-bottom:15px;">
                    <label style="color:rgb(var(--theme-highlight));">é›¨æ»´ä¸‹è½é€Ÿåº¦ï¼ˆç§’ï¼‰ï¼š</label>
                    <input type="range" id="rainSpeed" min="0.5" max="5" step="0.1" value="2" style="width:100%;">
                    <span id="rainSpeedValue" style="color:rgb(var(--theme-highlight));">2</span>
                </div>
            </div>
        </div>
        <div style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">ä¸»è¦é¢œè‰²è®¾ç½®ï¼š</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label style="color:rgb(var(--theme-highlight));">èƒŒæ™¯é¢œè‰² (æ·±è“)ï¼š</label>
                    <input type="color" id="themeBackground" value="#1d1d5c" style="width:100%; height:30px; border:none; cursor:pointer;">
                </div>
                <div>
                    <label style="color:rgb(var(--theme-highlight));">å‰æ™¯é¢œè‰² (æ©™)ï¼š</label>
                    <input type="color" id="themeForeground" value="#ba5757" style="width:100%; height:30px; border:none; cursor:pointer;">
                </div>
                <div>
                    <label style="color:rgb(var(--theme-highlight));">æ¬¡è¦é¢œè‰² (æµ…ç´«)ï¼š</label>
                    <input type="color" id="themeSecondary" value="#a8a8e4" style="width:100%; height:30px; border:none; cursor:pointer;">
                </div>
                <div>
                    <label style="color:rgb(var(--theme-highlight));">é«˜äº®é¢œè‰² (ç™½)ï¼š</label>
                    <input type="color" id="themeHighlight" value="#f7ebeb" style="width:100%; height:30px; border:none; cursor:pointer;">
                </div>
            </div>
        </div>
<div style="margin-bottom:15px;">
 <label style="color:rgb(var(--theme-highlight));">å¸–å­æ­£æ–‡å­—ä½“è®¾ç½®ï¼ˆä¸å«å¼•ç”¨ï¼‰ï¼š</label>
 <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
<div>
    <label style="color:rgb(var(--theme-highlight));">å­—è·ï¼ˆpxï¼Œ-2-2ï¼‰ï¼š</label>
    <input type="range" id="postLetterSpacing" min="-2" max="2" step="0.1" value="0" style="width:100%;">
    <span id="postLetterSpacingValue" style="color:rgb(var(--theme-highlight));">0</span>
</div>
 <div>
 <label style="color:rgb(var(--theme-highlight));">è¡Œè·ï¼ˆ1-2.5ï¼‰ï¼š</label>
 <input type="range" id="postLineHeight" min="1" max="2.5" step="0.1" value="1.7" style="width:100%;">
 <span id="postLineHeightValue" style="color:rgb(var(--theme-highlight));">1.7</span>
 </div>
 <div>
 <label style="color:rgb(var(--theme-highlight));">æ–‡æœ¬æ°´å¹³ç¼©æ”¾ï¼ˆ0.5-1.5ï¼‰ï¼š</label>
 <input type="range" id="postTextScaleX" min="0.5" max="1.5" step="0.01" value="1" style="width:100%;">
 <span id="postTextScaleXValue" style="color:rgb(var(--theme-highlight));">1</span>
 </div>
 <div>
 <label style="color:rgb(var(--theme-highlight));">å­—ä½“å¤§å°ï¼ˆpxï¼Œ8-20ï¼‰ï¼š</label>
 <input type="range" id="postFontSize" min="8" max="20" step="1" value="12" style="width:100%;">
 <span id="postFontSizeValue" style="color:rgb(var(--theme-highlight));">16</span>
 </div>
 </div>
</div>
        <div style="margin-bottom:15px;">
            <label style="color:rgb(var(--theme-highlight));">ä¿å­˜çš„ä¸»é¢˜æ–¹æ¡ˆï¼š</label>
            <select id="themeSelect" style="padding:5px; border:none; background:rgba(0,0,0,0.1); color:rgb(var(--theme-highlight)); width:100%; border-radius:3px;">
                <option value="">é€‰æ‹©å·²æœ‰ä¸»é¢˜</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="saveTheme()" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">ä¿å­˜ä¸»é¢˜</button>
            <button onclick="applyTheme()" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">åº”ç”¨ä¸»é¢˜</button>
            <button onclick="exportThemes()" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">å¯¼å‡ºä¸»é¢˜</button>
            <input type="file" id="importThemeFile" style="display:none" onchange="importThemes(this)">
            <button onclick="document.getElementById('importThemeFile').click()" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">å¯¼å…¥ä¸»é¢˜</button>
            <button onclick="document.getElementById('themeManager').style.display='none'" style="background:rgb(var(--theme-highlight)); color:rgb(var(--theme-background)); border:none; padding:8px 20px; border-radius:5px;">å…³é—­</button>
        </div>
    </div>
</div>
<!-- åŸä»£ç ç»§ç»­ -->
<button class="tag-manager-btn glass-button" onclick="showTagManager()" style="bottom:150px; right:30px;">â™</button>


    <div class="modal">
    <textarea id="content" placeholder="è¾“å…¥å†…å®¹ã€åª’ä½“é“¾æ¥å’Œæ ‡ç­¾ï¼ˆç¤ºä¾‹ï¼‰ï¼š
ä»Šå¤©å‘ç°ä¸€ä¸ªå¥½è§†é¢‘
https://youtu.be/abc123
#éŸ³ä¹ 
#æ¨è
æœç´¢ï¼šç©ºæ ¼=ä¸ /æ–œæ =æˆ–  åŒæ˜Ÿå·æ˜¯ç²—ä½“
å•æ˜Ÿå·æ–œä½“
æµªå·æ˜¯åˆ é™¤
ä¸‰æ˜Ÿå·æ˜¯æ°´å¹³çº¿
å¤§äºå·æ˜¯å¼•ç”¨å†…å®¹"></textarea>
    <div style="display:flex;gap:10px;justify-content:center;">
        <button id="saveBtn" style="background:rgb(var(--theme-highlight));color:rgb(var(--theme-background));border:none;padding:8px 20px;border-radius:5px;">âœ”</button>
        
    </div>
</div>
<div class="tag-manager" id="tagManager">
    <h3 style="color:rgb(var(--theme-secondary));margin-bottom:20px;">æ ‡ç­¾ç®¡ç†</h3>
    <div id="tagList"></div>
    <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">
        <button onclick="cleanUnusedTags()" style="background:rgb(var(--theme-highlight));;color:rgb(var(--theme-background));border:none;padding:8px 20px;border-radius:5px;">æ¸…ç†æœªä½¿ç”¨æ ‡ç­¾</button>
        <button onclick="document.getElementById('tagManager').style.display='none'" style="background:rgb(var(--theme-highlight));color:rgb(var(--theme-background));border:none;padding:8px 20px;border-radius:5px;">å…³é—­</button>
    </div>
</div>

    <div id="tagFilter" class="tag-filter"></div>
<div class="search-box">
    <button class="search-btn glass-button" onclick="searchPosts()">â˜</button>
    <input type="text" id="searchInput" placeholder="â˜ƒâ˜‚â˜€">
</div>
<div id="postsContainer" class="posts-container">
    <div id="pinnedContainer" class="pinned-container"></div>
</div>
    <script>
    	// åŸä»£ç ç¬¬45è¡Œä¿®æ”¹ä¸º â–¼â–¼â–¼
document.addEventListener('DOMContentLoaded', () => {
    try {
        posts = [];
        allTags = new Set();
        const savedPosts = localStorage.getItem('posts');
        if (savedPosts) {
            posts = JSON.parse(savedPosts).map(p => ({
                ...p,
                id: p.id || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                tags: p.tags || [],
                lastModified: p.lastModified || Date.now()
            })).sort(() => Math.random() - 0.5);
        }
        const savedTags = localStorage.getItem('tags');
        if (savedTags) {
            allTags = new Set(JSON.parse(savedTags));
        }
        // ç¡®ä¿ç½®é¡¶å¸–å­IDå­˜åœ¨
        if (!localStorage.getItem('pinnedPosts')) {
            localStorage.setItem('pinnedPosts', '[]');
        }
        renderTags();
        renderPinnedPosts(); // æ¸²æŸ“ç½®é¡¶åŒº
        renderPosts(posts); // æ¸²æŸ“æ™®é€šå¸–å­åŒº
    } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        alert('æ•°æ®åŠ è½½å¼‚å¸¸ï¼Œå·²é‡ç½®');
        localStorage.clear();
        location.reload();
    }
});
        // ä¿æŒåŸæœ‰JavaScripté€»è¾‘ä¸å˜
        let posts = [];
        let allTags = new Set();
        let isEditMode = false;
        let currentFilterTag = null; // æ–°å¢å…¨å±€å˜é‡
        let currentSearchTerm = null; // ä¿å­˜å½“å‰æœç´¢è¯
        
        // â–¼â–¼â–¼ æ–°å¢çš„åˆ‡æ¢æ¨¡æ€æ¡†å‡½æ•° â–¼â–¼â–¼
function toggleModal(isEdit = false) {
    const modal = document.querySelector('.modal');
    if (modal.style.display === 'block') {
        modal.style.display = 'none';
        return;
    }

    // é‡ç½®æ¨¡æ€æ¡†ä¸ºåˆå§‹çŠ¶æ€
    modal.innerHTML = `
        <textarea id="content" placeholder="è¾“å…¥å†…å®¹ã€åª’ä½“é“¾æ¥å’Œæ ‡ç­¾ï¼ˆç¤ºä¾‹ï¼‰ï¼š
ä»Šå¤©å‘ç°ä¸€ä¸ªå¥½è§†é¢‘
https://youtu.be/abc123
#éŸ³ä¹ #æ¨è

æœç´¢ï¼šç©ºæ ¼=ä¸ /æ–œæ =æˆ–  åŒæ˜Ÿå·æ˜¯ç²—ä½“

*æ–œä½“*
**åŠ ç²—**
~åˆ é™¤çº¿~
***æ˜¯æ°´å¹³çº¿
> æ˜¯å¼•ç”¨å†…å®¹"></textarea>
        <div style="display:flex;justify-content:center;">
            <button id="saveBtn" style="background:#f7ebeb;color:#1d1d5c;border:none;padding:8px 20px;border-radius:5px;">âœ”</button>
        </div>
    `;

    const saveBtn = modal.querySelector('#saveBtn');
    
    if (!isEdit) {
        saveBtn.onclick = addPost;
    }

    modal.style.display = 'block';
}
// â–²â–²â–² æ–°å¢çš„åˆ‡æ¢æ¨¡æ€æ¡†å‡½æ•° â–²â–²â–²

        function detectMediaType(url) {
        	const originalUrl = url;
        
        // åœ¨ detectMediaType å‡½æ•°çš„éŸ³é¢‘æ£€æµ‹é€»è¾‘ä¸­æ·»åŠ  â–¼â–¼â–¼
   const audioRegex = /(?:https?:\/\/.*archive\.org\/.*\.mp3|\.mp3)(?:\?.*)?$/i;
   if (audioRegex.test(url)) {
       return {
           type: 'audio',
           url: url,       // ç›´æ¥ä½¿ç”¨åŸå§‹é“¾æ¥ï¼ˆæ— éœ€å¤„ç†ï¼‰
           original: url   // æ˜ç¡®ä¿å­˜åŸå§‹é“¾æ¥
       };
   }
    
    // Bç«™æ£€æµ‹
    const bilibiliRegex = /(?:https?:\/\/)?(?:www\.)?bilibili\.com\/video\/(BV\w+)(\/|\?|&|$)/i;
    const bilibiliMatch = originalUrl.match(bilibiliRegex);
    if (bilibiliMatch) {
        return {
            type: 'bilibili',
            url: `https://player.bilibili.com/player.html?bvid=${bilibiliMatch[1]}&page=1`,
            original: originalUrl // å­˜å‚¨åŸå§‹é“¾æ¥
        };
    }

	// æ£€æµ‹ MP4 è§†é¢‘ç›´é“¾
const mp4Regex = /https?:\/\/.+\.mp4(\?.+)?$/i;
    if (mp4Regex.test(url)) {
        return {
            type: 'video', // æ–°å¢ç±»å‹
            url: url,
            original: url
        };
    }	
		
    // OK.ruæ£€æµ‹
// ä¿®æ”¹detectMediaTypeå‡½æ•°ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼
const okruRegex = /(?:https?:\/\/)?(?:www\.)?ok\.ru\/video\/(\d+)(?:\/|\?|&|$)/i;
    const okruMatch = originalUrl.match(okruRegex);
    if (okruMatch) {
        return {
            type: 'okru',
            url: `https://ok.ru/videoembed/${okruMatch[1]}`,
            original: originalUrl // å­˜å‚¨åŸå§‹é“¾æ¥
        };
    }
            // åŸæœ‰åª’ä½“æ£€æµ‹é€»è¾‘
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
    return { 
        type: 'youtube', 
        url: `https://www.youtube-nocookie.com/embed/${youtubeMatch[1]}` 
    };
}

            const imgurRegex = /https?:\/\/(?:i\.)?imgur\.com\/(\w+)(\.\w+)?/;
            const imgurMatch = url.match(imgurRegex);
            if (imgurMatch) {
                return { 
                    type: 'image', 
                    url: `https://i.imgur.com/${imgurMatch[1]}${imgurMatch[2] || '.jpg'}` 
                };
            }

            if (/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(url)) {
                return { type: 'image', url: url };
            }

            return null;
        }

        function parseInput(input) {
    const lines = input.split('\n');
    const media = [];
    const tags = [];
    const contentLines = [];

    lines.forEach(originalLine => {
        // æ”¹ä¸ºæ›´ç²¾ç¡®çš„æ®µè½ä¿ç•™é€»è¾‘
        const preservedLine = originalLine
            .replace(/(#\w+)/g, 'SPLIT_MARKER$1SPLIT_MARKER') // æ ‡è®°æ ‡ç­¾
            .replace(/(https?:\/\/\S+)/gi, 'SPLIT_MARKER$1SPLIT_MARKER') // æ ‡è®°é“¾æ¥
            .split('SPLIT_MARKER');

        let lineContent = '';
        preservedLine.forEach(segment => {
            if (!segment) return;
            
            // æ£€æµ‹åª’ä½“é“¾æ¥
            const mediaType = detectMediaType(segment);
            if (mediaType) {
                media.push(mediaType);
                return;
            }

            // æ£€æµ‹æ ‡ç­¾
            if (segment.startsWith('#')) {
                tags.push(segment.slice(1));
                return;
            }

            // ä¿ç•™åŸå§‹å†…å®¹ï¼ˆåŒ…å«ç©ºæ ¼ï¼‰
            lineContent += segment;
        });
        
        contentLines.push(lineContent); // ä¿ç•™åŸå§‹æ¢è¡Œå’Œç©ºæ ¼
    });

    return {
        content: contentLines.join('\n').replace(/\n+$/,''),
        media,
        tags
    };
}

        function addPost() {
    const modal = document.querySelector('.modal');
    const textarea = modal.querySelector('#content');
    const input = textarea.value;

    const { content, media, tags } = parseInput(input);

    tags.forEach(tag => allTags.add(tag));
    posts.unshift({
        id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        content,
        media,
        tags,
        lastModified: Date.now()
    });

    if (saveToLocalStorage()) {
        renderTags();
        renderPosts(posts); // åªæ¸²æŸ“éç½®é¡¶åŒº
        modal.style.display = 'none';
        textarea.value = '';
    } else {
        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

        // ä¿®æ”¹åçš„ renderTags å‡½æ•°
function renderTags() {
    const tagContainer = document.getElementById('tagFilter');
    tagContainer.innerHTML = '<div class="tag" onclick="clearFilter()">å…¨éƒ¨</div>';
    
    // å°† allTags è½¬æ¢ä¸ºæ•°ç»„å¹¶éšæœºæ’åº
    const shuffledTags = Array.from(allTags).sort(() => Math.random() - 0.5);
    
    shuffledTags.forEach(tag => {
        const tagElement = document.createElement('div');
        tagElement.className = 'tag' + (currentFilterTag === tag ? ' active' : '');
        tagElement.textContent = tag;
        tagElement.onclick = () => filterByTag(tag);
        tagContainer.appendChild(tagElement);
    });
}

function filterByTag(tag) {
    currentFilterTag = tag;
    renderPosts(posts.filter(p => p.tags.includes(tag)));
    renderTags(); // é‡æ–°æ¸²æŸ“æ ‡ç­¾ä»¥ç¡®ä¿ active çŠ¶æ€æ›´æ–°
}

function clearFilter() {
    currentFilterTag = null;
    renderPosts(posts);
    renderTags();
}

function createPostElement(post, mediaStates) {
    const postElement = document.createElement('div');
    postElement.className = 'post';
    postElement.dataset.id = post.id;

    const actions = document.createElement('div');
    actions.className = 'post-actions';
    const isPinned = JSON.parse(localStorage.getItem('pinnedPosts') || '[]').includes(post.id);
    actions.innerHTML = `
        ${isPinned ? 
            `<button onclick="moveDownPinnedPost('${post.id}')" title="ä¸‹ç§»">â†“</button>` : 
            `<button onclick="if(confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¸–å­å—ï¼Ÿ')) deletePost('${post.id}')" title="åˆ é™¤">Ã—</button>`}
        <button onclick="editPost('${post.id}')" title="ç¼–è¾‘">âœ</button>
        <button onclick="togglePinPost('${post.id}')" title="${isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}">P</button>
    `;
    postElement.appendChild(actions);

        if (post.content) {
        try {
            // ä½¿ç”¨ä¸´æ—¶å®¹å™¨è§£æå†…å®¹
            const tempContainer = document.createElement('div');
            // ä¿®æ”¹å¼•ç”¨å¤„ç†é€»è¾‘ï¼šåˆå¹¶è¿ç»­å¼•ç”¨è¡Œ
            let content = post.content
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/__([^_]+)__/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/_([^_]+)_/g, '<em>$1</em>')
                .replace(/~([^~]+)~/g, '<del>$1</del>')
                .replace(/^>\s*\*{3,}\s*$/gm, '<hr class="blockquote-divider">')
                // åˆå¹¶è¿ç»­å¼•ç”¨è¡Œ
                .replace(/(^>\s*.+?(?:\n>\s*.+?)*)(?=\n[^>\n]|\n$|$)/gms, (match) => {
                    // å°†è¿ç»­å¼•ç”¨è¡Œåˆå¹¶ä¸ºå•ä¸ª blockquote
                    const lines = match.split('\n').map(line => line.replace(/^>\s*/, '')).join('<br>');
                    return `<blockquote>${lines}</blockquote>`;
                });

            tempContainer.innerHTML = content;

            // å¤„ç†ä¸´æ—¶å®¹å™¨çš„å­èŠ‚ç‚¹
            Array.from(tempContainer.childNodes).forEach(node => {
                if (node.nodeName === 'BLOCKQUOTE') {
                    // å¤„ç†å¼•ç”¨
                    const blockquote = document.createElement('blockquote');
                    blockquote.innerHTML = node.innerHTML.replace(/\n/g, '<br>');
                    postElement.appendChild(blockquote);
                } else if (node.nodeName === 'IFRAME') {
                    // å¤„ç† iframe
                    const iframeContainer = document.createElement('div');
                    iframeContainer.className = 'post-iframe';
                    iframeContainer.appendChild(node.cloneNode(true));
                    postElement.appendChild(iframeContainer);
                } else {
                    // å¤„ç†æ­£æ–‡ï¼ˆåŒ…æ‹¬æ–‡æœ¬ã€strongã€emã€del ç­‰ï¼‰
                    const contentDiv = document.createElement('pre');
                    contentDiv.className = 'post-content';
                    contentDiv.style.whiteSpace = 'pre-wrap';
                    contentDiv.style.wordWrap = 'break-word';
                    contentDiv.style.margin = '0';
                    contentDiv.style.fontFamily = 'inherit';
                    if (node.nodeType === Node.TEXT_NODE) {
                        contentDiv.textContent = node.textContent;
                    } else {
                        contentDiv.appendChild(node.cloneNode(true));
                    }
                    if (contentDiv.textContent.trim() || contentDiv.children.length) {
                        postElement.appendChild(contentDiv);
                    }
                }
            });
        } catch (error) {
            console.error('æ¸²æŸ“å¸–å­å†…å®¹å¤±è´¥:', error, 'Content:', post.content);
            // å›é€€ï¼šæ˜¾ç¤ºåŸå§‹å†…å®¹
            const contentDiv = document.createElement('pre');
            contentDiv.className = 'post-content';
            contentDiv.style.whiteSpace = 'pre-wrap';
            contentDiv.style.wordWrap = 'break-word';
            contentDiv.style.margin = '0';
            contentDiv.style.fontFamily = 'inherit';
            contentDiv.textContent = post.content;
            postElement.appendChild(contentDiv);
        }
    }


 if (post.media && post.media.length) {
        const mediaContainer = document.createElement('div');
        mediaContainer.className = 'post-media';

        post.media.forEach(media => {
            // ä¸ºç½®é¡¶å‰¯æœ¬å’ŒåŸå¸–å­åˆ†é…å”¯ä¸€åª’ä½“ ID
            const mediaId = `${post.id}-${media.type}-${Math.random().toString(36).substr(2, 9)}`;
   if (media.type === 'okru') {
    mediaContainer.style.margin = '0';
    mediaContainer.style.display = 'block'; // æ·»åŠ è¿™è¡Œ
    mediaContainer.style.lineHeight = '0'; // æ·»åŠ è¿™è¡Œï¼Œæ¶ˆé™¤è¡Œé«˜é€ æˆçš„ç©ºéš™

    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.aspectRatio = '4/3';
    container.style.cursor = 'pointer';
    container.classList.add('okru-container');
    container.style.overflow = 'hidden'; // éšè—æº¢å‡ºéƒ¨åˆ†
    
    // ä»å¸–å­å†…å®¹ä¸­æå–å¤šä¸ªæµ·æŠ¥URL
    const postContent = post.content;
    const posterMatches = [...postContent.matchAll(/<!--\s*poster="([^"]+)"\s*-->/g)];
    
    if (posterMatches.length > 0) {
        const posterUrls = posterMatches.map(match => match[1]);
        
        // åˆ›å»ºæ»‘åŠ¨å®¹å™¨
        const slideContainer = document.createElement('div');
        slideContainer.style.position = 'absolute';
        slideContainer.style.top = '0';
        slideContainer.style.left = '0';
        slideContainer.style.width = `${posterUrls.length * 100}%`; // æ€»å®½åº¦ä¸ºæ‰€æœ‰å›¾ç‰‡å®½åº¦ä¹‹å’Œ
        slideContainer.style.height = '100%';
        slideContainer.style.display = 'flex';
        slideContainer.style.transition = 'transform 0.2s ease'; // å¿«é€Ÿæ»‘åŠ¨æ•ˆæœ
        
        // åˆ›å»ºæ‰€æœ‰å›¾ç‰‡
        posterUrls.forEach(url => {
            const imageWrapper = document.createElement('div');
            imageWrapper.style.width = `${100 / posterUrls.length}%`; // æ¯å¼ å›¾ç‰‡å æ€»å®½åº¦çš„ç›¸ç­‰ä»½é¢
            imageWrapper.style.height = '100%';
            
            const thumbnail = document.createElement('img');
            thumbnail.style.width = '100%';
            thumbnail.style.height = '100%';
            thumbnail.style.objectFit = 'cover';
            thumbnail.src = url;
            
            imageWrapper.appendChild(thumbnail);
            slideContainer.appendChild(imageWrapper);
        });
        
        container.appendChild(slideContainer);
        
        // åˆ›å»ºåŠé€æ˜é®ç½©
        const overlay = document.createElement('div');
        overlay.style.position = 'absolute';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0, 0, 0, 0.2)';
        overlay.style.zIndex = '1';
        container.appendChild(overlay);
        
        // åˆ›å»ºæ’­æ”¾æŒ‰é’®
        const playButton = document.createElement('div');
        playButton.style.position = 'absolute';
        playButton.style.top = '50%';
        playButton.style.left = '50%';
        playButton.style.transform = 'translate(-50%, -50%)';
        playButton.style.width = '60px';
        playButton.style.height = '60px';
        playButton.style.display = 'flex';
        playButton.style.alignItems = 'center';
        playButton.style.justifyContent = 'center';
        playButton.style.zIndex = '2';
        
        // åˆ›å»ºæ’­æ”¾å›¾æ ‡
        const playIcon = document.createElement('div');
        playIcon.style.width = '0';
        playIcon.style.height = '0';
        playIcon.style.borderStyle = 'solid';
        playIcon.style.borderWidth = '10px 0 10px 18px';
        playIcon.classList.add('okru-play-icon');
        playIcon.style.marginLeft = '5px';
        
        playButton.appendChild(playIcon);
        container.appendChild(playButton);

        // å¦‚æœæœ‰å¤šä¸ªæµ·æŠ¥ï¼Œæ·»åŠ è‡ªåŠ¨è½®æ’­
        if (posterUrls.length > 1) {
            let currentIndex = 0;
            
            // åˆ‡æ¢å‡½æ•°
            const switchPoster = () => {
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * posterUrls.length);
    } while (newIndex === currentIndex && posterUrls.length > 1);
    
    currentIndex = newIndex;
    slideContainer.style.transform = `translateX(-${(100 / posterUrls.length) * currentIndex}%)`;
};

            // è‡ªåŠ¨è½®æ’­ï¼Œ10ç§’åˆ‡æ¢ä¸€æ¬¡
            setInterval(switchPoster, 10000);
        }
        
        // ç‚¹å‡»æ’­æ”¾è§†é¢‘
        container.onclick = () => {
            const iframe = document.createElement('iframe');
            const videoId = media.url.split('/videoembed/')[1];
            
            const wrapperDiv = document.createElement('div');
            wrapperDiv.style.position = 'relative';
            wrapperDiv.style.width = '100%';
            wrapperDiv.style.aspectRatio = '4/3';
            wrapperDiv.style.overflow = 'hidden';
            
            iframe.src = `https://ok.ru/videoembed/${videoId}?autoplay=1`;
            iframe.style.position = 'absolute';
            iframe.style.top = '0';
            iframe.style.left = '0';
            iframe.style.width = '133.33%';
            iframe.style.height = '100%';
            iframe.style.transform = 'translate(-50%, -50%)';
            iframe.style.border = 'none';
            iframe.setAttribute('allowfullscreen', '');
            iframe.setAttribute('allow', 'autoplay');
            
            wrapperDiv.appendChild(iframe);
            container.innerHTML = '';
            container.appendChild(wrapperDiv);
        };
        
    } else {
        // å¦‚æœæ²¡æœ‰æµ·æŠ¥ï¼Œä½¿ç”¨é»˜è®¤iframe
        const iframe = document.createElement('iframe');
        const videoId = media.url.split('/videoembed/')[1];
        
        iframe.src = `https://ok.ru/videoembed/${videoId}`;
        iframe.style.position = 'absolute';
        iframe.style.top = '0';
        iframe.style.left = '0';
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.setAttribute('allowfullscreen', '');
        
        container.appendChild(iframe);
    }
    
    mediaContainer.appendChild(container);
}
		    if (media.type === 'video') { // æ£€æµ‹è§†é¢‘ç±»å‹
                    const container = document.createElement('div');
                    container.style.position = 'relative';
                    container.style.width = '100%';
                    container.style.aspectRatio = '16/9'; // 16:9æ¯”ä¾‹
                    container.style.overflow = 'hidden';

                    const video = document.createElement('video');
                    audio.dataset.mediaId = mediaId; // ä½¿ç”¨å”¯ä¸€ ID
                    video.src = media.url;
                    video.controls = true; // æ·»åŠ æ§åˆ¶æŒ‰é’®
                    video.style.width = '100%'; // è®¾ç½®ä¸º100%å®½åº¦
                    video.style.height = '100%'; // è®¾ç½®ä¸º100%é«˜åº¦
                    video.setAttribute('allowfullscreen', ''); // å…è®¸å…¨å±

                    container.appendChild(video);
                    mediaContainer.appendChild(container);
		    }
                if (media.type === 'image') {
    // æŸ¥æ‰¾æˆ–åˆ›å»ºä¸“é—¨çš„å›¾ç‰‡è½®æ’­å®¹å™¨
    let imageSlideContainer = mediaContainer.querySelector('.image-slide-container');
    if (!imageSlideContainer) {
        imageSlideContainer = document.createElement('div');
        imageSlideContainer.className = 'image-slide-container';
        imageSlideContainer.style.position = 'relative';
        imageSlideContainer.style.width = '100%';
        imageSlideContainer.style.overflow = 'hidden';
        
        // åˆ›å»ºå›¾ç‰‡åŒ…è£…å™¨
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.transition = 'transform 0.5s ease';
        wrapper.style.width = '100%';
        
        imageSlideContainer.appendChild(wrapper);
        mediaContainer.appendChild(imageSlideContainer);
    }
    
    const wrapper = imageSlideContainer.querySelector('div');
    
    // åˆ›å»ºå›¾ç‰‡å®¹å™¨
    const imgContainer = document.createElement('div');
    imgContainer.style.flex = '0 0 100%';
    imgContainer.style.width = '100%';
    
    // æ·»åŠ å›¾ç‰‡
    const img = document.createElement('img');
    img.src = media.url;
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    
    imgContainer.appendChild(img);
    wrapper.appendChild(imgContainer);
}

// åœ¨å¤„ç†å®Œæ‰€æœ‰åª’ä½“åè®¾ç½®è½®æ’­
const imageCount = post.media.filter(m => m.type === 'image').length;
if (imageCount > 1) {
    const imageSlideContainer = mediaContainer.querySelector('.image-slide-container');
    if (imageSlideContainer) {
        const wrapper = imageSlideContainer.querySelector('div');
        
        // æ·»åŠ éšæœºåˆå§‹é¡µ
        const initialSlide = Math.floor(Math.random() * imageCount);
        let currentSlide = initialSlide;
        
        // è®¾ç½®åˆå§‹ä½ç½®
        wrapper.style.transform = `translateX(-${initialSlide * 100}%)`;
        
        // è‡ªåŠ¨è½®æ’­å‡½æ•°
        function autoSlide() {
            currentSlide = (currentSlide + 1) % imageCount;
            wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        }
        
        // è®¾ç½®20ç§’è½®æ’­é—´éš”
        setInterval(autoSlide, 50000);
    }
}
                
       if (media.type === 'audio') {
    const audioContainer = document.createElement('div');
    audioContainer.style.position = 'relative';
    audioContainer.style.width = '100%';
    audioContainer.style.height = '30px';
    audioContainer.style.display = 'flex';
    audioContainer.style.alignItems = 'center';
    audioContainer.style.gap = '0'; // å‡å°‘æ§ä»¶é—´è·
    audioContainer.style.padding = '0'; // å‡å°‘å†…è¾¹è·
    audioContainer.style.margin = '0'; // ç§»é™¤å¤–è¾¹è·

    const audio = document.createElement('audio');
    audio.preload = 'metadata';
    audio.src = media.url;
    audio.dataset.mediaId = mediaId

    // è‡ªå®šä¹‰æ§ä»¶å®¹å™¨
    const customControls = document.createElement('div');
    customControls.style.width = '100%';
    customControls.style.height = '30px';
    customControls.style.display = 'flex';
    customControls.style.alignItems = 'center';
    customControls.classList.add('custom-controls');
    customControls.style.borderRadius = '5px';
    customControls.style.gap = '0'; // å‡å°‘æ§ä»¶é—´è·
    customControls.style.padding = '0'; // ç§»é™¤å†…è¾¹è·
    customControls.style.margin = '0'; // ç§»é™¤å¤–è¾¹è·

    // æ’­æ”¾/æš‚åœæŒ‰é’®
    const playButton = document.createElement('button');
    playButton.innerHTML = 'â–¶';
    playButton.style.backgroundColor = 'transparent';
    playButton.style.border = 'none';
    playButton.classList.add('play-button');
    playButton.style.cursor = 'pointer';
    playButton.style.padding = '0';
    playButton.style.margin = '0';
    playButton.style.width = '20px'; // å›ºå®šå®½åº¦
    playButton.style.height = '20px';
    playButton.style.display = 'flex';
    playButton.style.alignItems = 'center';
    playButton.style.justifyContent = 'center';

    // è¿›åº¦æ¡
    const progressBar = document.createElement('input');
    progressBar.type = 'range';
    progressBar.value = 0;
    progressBar.min = 0;
    progressBar.max = 100;
    progressBar.step = 0.1;
    progressBar.style.flex = '1';
    progressBar.style.margin = '0 5px'; // å‡å°‘è¿›åº¦æ¡è¾¹è·
    progressBar.style.padding = '0'; // ç§»é™¤å†…è¾¹è·

    // æ—¶é—´æ˜¾ç¤º
    const timeDisplay = document.createElement('span');
    timeDisplay.style.fontFamily = 'Arial, sans-serif';
    timeDisplay.classList.add('time-display');
    timeDisplay.style.fontSize = '9px';
    timeDisplay.style.whiteSpace = 'nowrap';
    timeDisplay.style.minWidth = '60px'; // å‡å°‘æœ€å°å®½åº¦
    timeDisplay.style.display = 'inline-block';
    timeDisplay.style.textAlign = 'right';
    timeDisplay.style.flexShrink = '0';
    timeDisplay.style.padding = '0 2px'; // å‡å°‘å†…è¾¹è·
    timeDisplay.style.marginLeft = '0'; // ç§»é™¤å·¦è¾¹è·

    // åˆå§‹è®¾ç½®ä¸º0:00 / 0:00
    timeDisplay.textContent = '0:00-0:00';

    // æ·»åŠ å…ƒæ•°æ®åŠ è½½äº‹ä»¶
    audio.addEventListener('loadedmetadata', () => {
        const totalMinutes = Math.floor(audio.duration / 60);
        const totalSeconds = Math.floor(audio.duration % 60);
        timeDisplay.textContent = `0:00-${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
    });

    // æ’­æ”¾/æš‚åœé€»è¾‘
    playButton.onclick = () => {
        if (audio.paused) {
            audio.play();
            playButton.innerHTML = 'âšâš';
        } else {
            audio.pause();
            playButton.innerHTML = 'â–¶';
        }
    };

    // æ›´æ–°è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
    audio.addEventListener('timeupdate', () => {
        const percentage = (audio.currentTime / audio.duration) * 100;
        progressBar.value = percentage;
        
        const currentMinutes = Math.floor(audio.currentTime / 60);
        const currentSeconds = Math.floor(audio.currentTime % 60);
        const totalMinutes = Math.floor(audio.duration / 60);
        const totalSeconds = Math.floor(audio.duration % 60);
        
        timeDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')}-${totalMinutes}:${totalSeconds.toString().padStart(2, '0')}`;
    });

    // æ‹–åŠ¨è¿›åº¦æ¡è°ƒæ•´æ’­æ”¾ä½ç½®
    progressBar.addEventListener('input', () => {
        const time = (progressBar.value / 100) * audio.duration;
        audio.currentTime = time;
    });

    // ç»„è£…æ§ä»¶
    customControls.appendChild(playButton);
    customControls.appendChild(progressBar);
    customControls.appendChild(timeDisplay);
    
    audioContainer.appendChild(audio);
    audioContainer.appendChild(customControls);
    mediaContainer.appendChild(audioContainer);
}



                
             if (media.type === 'bilibili') {
    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.aspectRatio = '4/3';
    container.style.overflow = 'hidden';
    
    const iframe = document.createElement('iframe');
    iframe.src = `${media.url}&high_quality=1&quality=4&qn=112&autoplay=0&danmaku=0`;
    iframe.dataset.mediaId = mediaId;
    iframe.style.position = 'absolute';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '133.33%';
    iframe.style.height = '100%';
    iframe.style.transform = 'translate(-50%, -50%)';
    iframe.style.border = 'none';
    iframe.setAttribute('allowfullscreen', 'true');
    
    // æ·»åŠ æ ·å¼æ¥éšè—å³ä¸Šè§’æç¤º
    const style = document.createElement('style');
    style.textContent = `
        .bilibili-player-video-top,
        .bilibili-player-video-info,
        .bilibili-player-video-info-hover,
        .bilibili-player-video-info-switch-btn,
        .bilibili-player-video-info-container {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }
    `;
    container.appendChild(style);
    container.appendChild(iframe);
    mediaContainer.appendChild(container);
}

              
if (media.type === 'youtube') {
    const container = document.createElement('div');
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.cursor = 'pointer';
    container.style.backgroundColor = 'transparent';
    
    // åˆ›å»ºç¼©ç•¥å›¾
    const thumbnail = document.createElement('img');
    const videoId = media.url.split('/').pop();
    thumbnail.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
    thumbnail.style.width = '100%';
    thumbnail.style.display = 'block';
    
    
    // æ·»åŠ æ’­æ”¾å›¾æ ‡
    const playIcon = document.createElement('div');
    playIcon.style.position = 'absolute';
    playIcon.style.bottom = '15px';
    playIcon.style.right = '15px';
    playIcon.style.width = '0';
    playIcon.style.height = '0';
    playIcon.style.borderTop = '8px solid transparent';
    playIcon.style.borderBottom = '8px solid transparent';
    playIcon.classList.add('youtube-play-icon');
    
    // ç‚¹å‡»æ—¶æ›¿æ¢ä¸ºiframe
    container.onclick = () => {
    const iframe = document.createElement('iframe');
    const videoId = media.url.match(/(?:\/|v=)([a-zA-Z0-9_-]{11})/)[1];
    
    // åˆ›å»ºä¸€ä¸ªæ–°çš„åŒ…è£…å®¹å™¨
    const wrapperDiv = document.createElement('div');
    wrapperDiv.style.position = 'relative';
    wrapperDiv.style.width = '100%';
    wrapperDiv.style.aspectRatio = '4/3'; // è®¾ç½®4:3çš„å®¹å™¨æ¯”ä¾‹
    wrapperDiv.style.overflow = 'hidden'; // ç¡®ä¿è¶…å‡ºéƒ¨åˆ†è¢«è£å‰ª
    
    // è®¾ç½®iframeæ ·å¼
    iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1`;
    iframe.style.position = 'absolute';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '133.33%'; // 4:3å®¹å™¨ä¸­æ˜¾ç¤º16:9å†…å®¹éœ€è¦çš„å®½åº¦
    iframe.style.height = '100%';
    iframe.style.transform = 'translate(-50%, -50%)'; // å±…ä¸­
    iframe.style.border = 'none';
    iframe.setAttribute('allowfullscreen', '');
    iframe.setAttribute('allow', 'autoplay');
    
    // å°†iframeæ·»åŠ åˆ°åŒ…è£…å®¹å™¨ä¸­
    wrapperDiv.appendChild(iframe);
    
    // æ¸…ç©ºåŸå®¹å™¨å¹¶æ·»åŠ æ–°çš„åŒ…è£…å®¹å™¨
    container.innerHTML = '';
    container.appendChild(wrapperDiv);
    };
    
    container.appendChild(thumbnail);
    container.appendChild(playIcon);
    mediaContainer.appendChild(container);
}
        });

        postElement.appendChild(mediaContainer);
    }

    // æ¢å¤æ’­æ”¾çŠ¶æ€
    if (mediaStates[post.id]) {
        setTimeout(() => {
            const media = postElement.querySelector('.post-media audio, .post-media video');
            if (media) {
                media.currentTime = mediaStates[post.id].time;
                if (mediaStates[post.id].playing) media.play();
            }
        }, 0);
    }

    return postElement;
}


        function renderPosts(postsToRender) {
    // ä¿å­˜æ’­æ”¾çŠ¶æ€
    const mediaStates = {};
    document.querySelectorAll('.post-media audio, .post-media video').forEach(media => {
        const postId = media.closest('.post').dataset.id;
        mediaStates[postId] = {
            time: media.currentTime,
            playing: !media.paused
        };
    });

    // è·å–ç½®é¡¶å¸–å­ID
    let pinnedPostIds = new Set(JSON.parse(localStorage.getItem('pinnedPosts') || '[]'));

    // ç¡®å®šè¦æ¸²æŸ“çš„å¸–å­
    if (!postsToRender) {
        if (currentSearchTerm) {
            postsToRender = posts.filter(p =>
                p.content.toLowerCase().includes(currentSearchTerm) ||
                p.tags.some(t => t.toLowerCase().includes(currentSearchTerm))
            );
        } else if (currentFilterTag) {
            postsToRender = posts.filter(p => p.tags.includes(currentFilterTag));
        } else {
            postsToRender = posts;
        }
    }

    // ç­›é€‰éç½®é¡¶å¸–å­
    const nonPinnedPosts = postsToRender.filter(p => !pinnedPostIds.has(p.id));

    // æ¸²æŸ“ä¸»å¸–å­åŒºåŸŸ
    const container = document.getElementById('postsContainer');
    const postsPerPage = 50;
    const totalPages = Math.ceil(nonPinnedPosts.length / postsPerPage);
    if (!window.currentPage) window.currentPage = 1;
    const startIndex = (window.currentPage - 1) * postsPerPage;
    const endIndex = startIndex + postsPerPage;
    const currentPosts = nonPinnedPosts.slice(startIndex, endIndex);

    // è·å–ç°æœ‰éç½®é¡¶å¸–å­
    const existingPosts = document.querySelectorAll('.post:not([data-pinned])');
    const existingPostIds = new Set(Array.from(existingPosts).map(post => post.dataset.id));

    // ç§»é™¤ä¸å†éœ€è¦çš„å¸–å­ï¼ˆä¿ç•™æ’­æ”¾ä¸­çš„å¸–å­ï¼‰
    existingPosts.forEach(postElement => {
        const postId = postElement.dataset.id;
        const isInCurrentPage = currentPosts.some(p => p.id === postId);
        const isPlaying = mediaStates[postId]?.playing;
        if (!isInCurrentPage && !isPlaying) {
            postElement.remove();
        }
    });

    // æ¸²æŸ“ä¸»å¸–å­
    currentPosts.forEach(post => {
        if (document.querySelector(`.post[data-id="${post.id}"]:not([data-pinned])`)) return;
        const postElement = createPostElement(post, mediaStates);
        container.appendChild(postElement);
    });

    // æ¸²æŸ“åˆ†é¡µ
    const pagination = document.createElement('div');
    pagination.className = 'pagination';
    let pageNumbers = [];
    if (totalPages <= 7) {
        pageNumbers = Array.from({length: totalPages}, (_, i) => i + 1);
    } else {
        if (window.currentPage <= 3) {
            pageNumbers = [1, 2, 3, 4, '...', totalPages];
        } else if (window.currentPage >= totalPages - 2) {
            pageNumbers = [1, '...', totalPages-3, totalPages-2, totalPages-1, totalPages];
        } else {
            pageNumbers = [1, '...', window.currentPage-1, window.currentPage, window.currentPage+1, '...', totalPages];
        }
    }

    pageNumbers.forEach(num => {
        const pageElement = document.createElement('span');
        pageElement.className = 'page-number';
        if (num === '...') {
            pageElement.textContent = '...';
        } else {
            pageElement.textContent = num;
            if (num === window.currentPage) {
                pageElement.classList.add('active');
            }
            pageElement.onclick = () => {
                window.currentPage = num;
                renderPosts(postsToRender);
                document.documentElement.scrollTo({ top: 0, behavior: 'smooth' });
            };
        }
        pagination.appendChild(pageElement);
    });

    // ç¡®ä¿åˆ†é¡µåœ¨postsContainerä¹‹å
    const existingPagination = container.querySelector('.pagination');
    if (existingPagination) existingPagination.remove();
    container.appendChild(pagination);
}
        
        function renderPinnedPosts() {
    const pinnedContainer = document.getElementById('pinnedContainer');
    const pinnedPostIds = new Set(JSON.parse(localStorage.getItem('pinnedPosts') || '[]'));

    // ä¿å­˜æ’­æ”¾çŠ¶æ€
    const mediaStates = {};
    document.querySelectorAll('.post-media audio, .post-media video').forEach(media => {
        const postId = media.closest('.post').dataset.id;
        mediaStates[postId] = {
            time: media.currentTime,
            playing: !media.paused
        };
    });

    // è·å–å½“å‰ç½®é¡¶åŒºçš„å¸–å­ ID
    const existingPosts = Array.from(pinnedContainer.querySelectorAll('.post')).map(post => post.dataset.id);
    const newPostIds = Array.from(pinnedPostIds);

    // ç§»é™¤ä¸å­˜åœ¨çš„å¸–å­
    existingPosts.forEach(postId => {
        if (!pinnedPostIds.has(postId)) {
            const postElement = pinnedContainer.querySelector(`.post[data-id="${postId}"]`);
            if (postElement) postElement.remove();
        }
    });

    // æ·»åŠ æˆ–æ›´æ–°å¸–å­ï¼Œå¹¶ä¿æŒé¡ºåº
    newPostIds.forEach((postId, index) => {
        const post = posts.find(p => p.id === postId);
        if (!post) return;

        const existingPostElement = pinnedContainer.querySelector(`.post[data-id="${postId}"]`);
        const newPostElement = createPostElement(post, mediaStates);
        newPostElement.dataset.pinned = 'true';

        if (existingPostElement) {
            // å¦‚æœå¸–å­å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
            if (existingPostElement.innerHTML !== newPostElement.innerHTML) {
                pinnedContainer.replaceChild(newPostElement, existingPostElement);
            }
        } else {
            // æ’å…¥åˆ°æ­£ç¡®ä½ç½®
            if (index === 0) {
                pinnedContainer.prepend(newPostElement);
            } else {
                const prevPostElement = pinnedContainer.querySelector(`.post[data-id="${newPostIds[index - 1]}"]`);
                if (prevPostElement) {
                    prevPostElement.after(newPostElement);
                } else {
                    pinnedContainer.appendChild(newPostElement);
                }
            }
        }
    });

    pinnedContainer.classList.toggle('active', pinnedPostIds.size > 0);
}

function toggleEditMode() {
    isEditMode = !isEditMode; // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼çŠ¶æ€
    document.body.classList.toggle('edit-mode', isEditMode); // åˆ‡æ¢ body çš„ edit-mode ç±»
}

function togglePinPost(postId) {
    let pinnedPostIds = new Set(JSON.parse(localStorage.getItem('pinnedPosts') || '[]'));
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    // ä¿å­˜æ’­æ”¾çŠ¶æ€
    const mediaStates = {};
    document.querySelectorAll('.post-media audio, .post-media video').forEach(media => {
        const postId = media.closest('.post').dataset.id;
        mediaStates[postId] = {
            time: media.currentTime,
            playing: !media.paused
        };
    });

    const pinnedContainer = document.getElementById('pinnedContainer');
    const postsContainer = document.getElementById('postsContainer');

    if (pinnedPostIds.has(postId)) {
        // å–æ¶ˆç½®é¡¶
        pinnedPostIds.delete(postId);

        // ç§»é™¤éç½®é¡¶åŒºçš„å‰¯æœ¬
        const nonPinnedCopy = postsContainer.querySelector(`.post[data-id="${postId}"][data-copy="true"]`);
        if (nonPinnedCopy) nonPinnedCopy.remove();

        // ä¿å­˜ç½®é¡¶å¸–å­ ID
        localStorage.setItem('pinnedPosts', JSON.stringify([...pinnedPostIds]));

        // é‡æ–°æ¸²æŸ“ç½®é¡¶åŒº
        renderPinnedPosts();

        // é‡æ–°æ¸²æŸ“éç½®é¡¶åŒºï¼Œæ ¹æ®å½“å‰è¿‡æ»¤æ¡ä»¶
        if (currentSearchTerm) {
            searchPosts();
        } else if (currentFilterTag) {
            renderPosts(posts.filter(p => p.tags.includes(currentFilterTag)));
        } else {
            renderPosts(posts);
        }
    } else {
        // ç½®é¡¶
        pinnedPostIds.add(postId);
        const originalPostElement = document.querySelector(`.post[data-id="${postId}"]:not([data-pinned])`);
        if (originalPostElement) {
            // ç§»åŠ¨åŸå¸–å­åˆ°ç½®é¡¶åŒº
            originalPostElement.dataset.pinned = 'true';
            pinnedContainer.insertBefore(originalPostElement, pinnedContainer.firstChild);

            // åœ¨åŸä½ç½®ç”Ÿæˆå‰¯æœ¬
            const copyElement = createPostElement(post, {});
            copyElement.dataset.copy = 'true';
            const allPosts = Array.from(postsContainer.querySelectorAll('.post:not([data-pinned])'));
            const postIndex = allPosts.findIndex(el => el === originalPostElement);
            if (postIndex >= 0) {
                postsContainer.insertBefore(copyElement, allPosts[postIndex]);
            } else {
                postsContainer.appendChild(copyElement);
            }

            // æ›´æ–°ç½®é¡¶åŒºæ˜¾ç¤ºçŠ¶æ€
            pinnedContainer.classList.add('active');
        } else {
            // å¦‚æœåŸå¸–å­ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å‰¯æœ¬
            const postElement = createPostElement(post, mediaStates);
            postElement.dataset.pinned = 'true';
            pinnedContainer.insertBefore(postElement, pinnedContainer.firstChild);
            pinnedContainer.classList.add('active');
        }

        // ä¿å­˜ç½®é¡¶å¸–å­ ID
        localStorage.setItem('pinnedPosts', JSON.stringify([...pinnedPostIds]));
    }

    // æ›´æ–°ç½®é¡¶æŒ‰é’®çš„ title å±æ€§
    document.querySelectorAll(`.post[data-id="${postId}"] .post-actions button[title]`).forEach(button => {
        button.title = pinnedPostIds.has(postId) ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶';
    });
}

function moveDownPinnedPost(postId) {
    const pinnedPostIds = JSON.parse(localStorage.getItem('pinnedPosts') || '[]');
    const index = pinnedPostIds.indexOf(postId);

    if (index === -1 || index === pinnedPostIds.length - 1) {
        return;
    }

    // äº¤æ¢æ•°ç»„ä¸­çš„é¡ºåº
    [pinnedPostIds[index], pinnedPostIds[index + 1]] = [pinnedPostIds[index + 1], pinnedPostIds[index]];
    localStorage.setItem('pinnedPosts', JSON.stringify(pinnedPostIds));

    // ç›´æ¥æ“ä½œ DOM äº¤æ¢å¸–å­
    const pinnedContainer = document.getElementById('pinnedContainer');
    const currentPost = pinnedContainer.querySelector(`.post[data-id="${postId}"]`);
    const nextPost = currentPost.nextElementSibling;
    if (currentPost && nextPost) {
        pinnedContainer.insertBefore(nextPost, currentPost);
    }
}

function togglePinMode() {
    const pinnedContainer = document.getElementById('pinnedContainer');
    const postsContainer = document.getElementById('postsContainer');
    
    // è®¡ç®—å•åˆ—å®½åº¦
    const postsContainerWidth = postsContainer.offsetWidth;
    const columnGap = parseFloat(getComputedStyle(postsContainer).columnGap) || 7.5;
    const computedStyle = getComputedStyle(postsContainer);
    const columnCount = parseInt(computedStyle.columnCount || computedStyle.webkitColumnCount || 3);
    const singleColumnWidth = (postsContainerWidth - (columnCount - 1) * columnGap) / columnCount;
    
    // è®¾ç½®å®½åº¦
    pinnedContainer.style.setProperty('--single-column-width', `${singleColumnWidth}px`);
    
    // åˆ‡æ¢å›ºå®šæ¨¡å¼
    pinnedContainer.classList.toggle('fixed');
    
    // æ›´æ–°æŒ‰é’®å›¾æ ‡
    const toggleBtn = document.querySelector('.toggle-pin-mode-btn');
    toggleBtn.textContent = pinnedContainer.classList.contains('fixed') ? 'â˜‚' : 'â˜„';
}



function deletePost(postId) {
    // Remove post from posts array
    posts = posts.filter(p => p.id !== postId);

    // Remove from pinned posts if present
    let pinnedPostIds = new Set(JSON.parse(localStorage.getItem('pinnedPosts') || '[]'));
    if (pinnedPostIds.has(postId)) {
        pinnedPostIds.delete(postId);
        localStorage.setItem('pinnedPosts', JSON.stringify([...pinnedPostIds]));
    }

    // Update tags
    allTags.clear();
    posts.forEach(post => {
        post.tags.forEach(tag => allTags.add(tag));
    });

    // Save changes to localStorage
    if (saveToLocalStorage()) {
        // Remove post from DOM (both pinned and non-pinned)
        document.querySelectorAll(`.post[data-id="${postId}"]`).forEach(postElement => {
            postElement.remove();
        });

        // Update pinned container visibility
        const pinnedContainer = document.getElementById('pinnedContainer');
        pinnedContainer.classList.toggle('active', pinnedPostIds.size > 0);

        // Re-render tags and posts
        renderTags();
        if (currentSearchTerm) {
            searchPosts();
        } else if (currentFilterTag) {
            renderPosts(posts.filter(p => p.tags.includes(currentFilterTag)));
        } else {
            renderPosts(posts);
        }
    } else {
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}
// æ–°å¢ç¼–è¾‘åŠŸèƒ½
function editPost(postId) {
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    toggleModal(true);
    const modal = document.querySelector('.modal');
    const textarea = modal.querySelector('#content');
    const saveBtn = modal.querySelector('#saveBtn');

    const mediaUrls = post.media.map(m => {
        if (m.original) return m.original;
        if (m.type === 'youtube') {
            const videoId = m.url.split('/').pop().split('?')[0];
            return `https://youtu.be/${videoId}`;
        } else if (m.type === 'bilibili') {
            const bvid = new URL(m.url).searchParams.get('bvid');
            return `https://www.bilibili.com/video/${bvid}/`;
        } else if (m.type === 'okru') {
            const videoId = m.url.split('/videoembed/')[1];
            return `https://ok.ru/video/${videoId}`;
        }
        return m.url;
    });

    textarea.value = [
        post.content,
        ...mediaUrls,
        ...post.tags.map(t => `#${t}`)
    ].join('\n');

    saveBtn.onclick = () => {
        const { content, media, tags } = parseInput(textarea.value);
        Object.assign(post, {
            content,
            media,
            tags,
            id: postId,
            lastModified: Date.now()
        });
        if (saveToLocalStorage()) {
            // ä¿å­˜ç½®é¡¶åŒºå½“å‰æ’­æ”¾çŠ¶æ€
            const mediaStates = {};
            const pinnedContainer = document.getElementById('pinnedContainer');
            const pinnedPostElement = pinnedContainer.querySelector(`.post[data-id="${postId}"]`);
            if (pinnedPostElement) {
                const media = pinnedPostElement.querySelector('.post-media audio, .post-media video');
                if (media) {
                    mediaStates[postId] = {
                        time: media.currentTime,
                        playing: !media.paused
                    };
                }
                // æ›´æ–°ç½®é¡¶åŒºï¼ˆåŸå¸–æˆ–å‰¯æœ¬ï¼‰
                const newElement = createPostElement(post, mediaStates);
                newElement.dataset.pinned = 'true';
                if (pinnedPostElement.dataset.moved) newElement.dataset.moved = 'true';
                pinnedContainer.replaceChild(newElement, pinnedPostElement);
            }

            // æ›´æ–°éç½®é¡¶åŒº
            const postsContainer = document.getElementById('postsContainer');
            const nonPinnedPostElement = postsContainer.querySelector(`.post[data-id="${postId}"]:not([data-pinned])`);
            if (nonPinnedPostElement) {
                const newElement = createPostElement(post, {}); // ä¸æ’­æ”¾
                postsContainer.replaceChild(newElement, nonPinnedPostElement);
            }

            // åˆ·æ–°éç½®é¡¶åŒºï¼ˆå¦‚æœåœ¨æœç´¢æˆ–æ ‡ç­¾è¿‡æ»¤æ¨¡å¼ä¸‹ï¼‰
            if (currentSearchTerm) {
                searchPosts();
            } else if (currentFilterTag) {
                renderPosts(posts.filter(p => p.tags.includes(currentFilterTag)));
            } else {
                renderPosts(posts);
            }
            modal.style.display = 'none';
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    };
}
  

// åœ¨ç°æœ‰JavaScriptä»£ç æœ«å°¾æ·»åŠ ä»¥ä¸‹å‡½æ•°
function showTagManager() {
    const tagManager = document.getElementById('tagManager');
    const tagList = document.getElementById('tagList');
    tagList.innerHTML = '';
    
    // è·å–æ¯ä¸ªæ ‡ç­¾çš„ä½¿ç”¨æ¬¡æ•°
    const tagCounts = {};
    Array.from(allTags).forEach(tag => {
        tagCounts[tag] = posts.filter(post => post.tags.includes(tag)).length;
    });
    
    // æ˜¾ç¤ºæ ‡ç­¾åˆ—è¡¨
    Array.from(allTags).sort().forEach(tag => {
        const tagItem = document.createElement('div');
        tagItem.className = 'tag-item';
        tagItem.innerHTML = `
            <span>${tag}</span>
            <div style="display:flex;align-items:center;">
                <span class="tag-count">ä½¿ç”¨æ¬¡æ•°: ${tagCounts[tag]}</span>
                <div class="tag-actions">
                    <button onclick="renameTag('${tag}')" style="background:rgb(var(--theme-highlight));color:rgba(var(--theme-background));border:none;padding:4px 8px;border-radius:3px;">é‡å‘½å</button>
                    <button onclick="deleteTag('${tag}')" style="background:rgb(var(--theme-highlight));rgba(var(--theme-background));border:none;padding:4px 8px;border-radius:3px;">åˆ é™¤</button>
                </div>
            </div>
        `;
        tagList.appendChild(tagItem);
    });
    
    tagManager.style.display = 'block';
}

function renameTag(oldTag) {
    const newTag = prompt(`è¯·è¾“å…¥æ–°çš„æ ‡ç­¾åç§°ï¼ˆå½“å‰ï¼š${oldTag}ï¼‰ï¼š`);
    if (newTag && newTag !== oldTag) {
        posts.forEach(post => {
            const tagIndex = post.tags.indexOf(oldTag);
            if (tagIndex !== -1) {
                post.tags[tagIndex] = newTag;
            }
        });
        
        allTags.delete(oldTag);
        allTags.add(newTag);
        
        if (saveToLocalStorage()) {
            renderTags();
            renderPosts(posts);
            showTagManager();
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
}



function deleteTag(tag) {
    if (confirm(`ç¡®å®šè¦åˆ é™¤æ ‡ç­¾"${tag}"å—ï¼Ÿ`)) {
        posts.forEach(post => {
            post.tags = post.tags.filter(t => t !== tag);
        });
        
        allTags.delete(tag);
        
        if (saveToLocalStorage()) {
            renderTags();
            renderPosts(posts);
            showTagManager();
        } else {
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
}


function cleanUnusedTags() {
    const usedTags = new Set();
    posts.forEach(post => {
        post.tags.forEach(tag => usedTags.add(tag));
    });
    
    const unusedTags = Array.from(allTags).filter(tag => !usedTags.has(tag));
    if (unusedTags.length === 0) {
        alert('æ²¡æœ‰æ‰¾åˆ°æœªä½¿ç”¨çš„æ ‡ç­¾ï¼');
        return;
    }
    
    if (confirm(`å‘ç° ${unusedTags.length} ä¸ªæœªä½¿ç”¨çš„æ ‡ç­¾ï¼Œæ˜¯å¦æ¸…ç†ï¼Ÿ\n${unusedTags.join(', ')}`)) {
        unusedTags.forEach(tag => allTags.delete(tag));
        
        // ä¿å­˜æ›´æ–°
        localStorage.setItem('tags', JSON.stringify([...allTags]));
        
        // åˆ·æ–°æ˜¾ç¤º
        renderTags();
        showTagManager();
    }
}
function searchPosts() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    currentSearchTerm = searchInput;
    if (!searchInput) {
        currentSearchTerm = null;
        renderPosts(posts);
        return;
    }

    // åˆ¤æ–­åˆ†éš”ç¬¦ç±»å‹ï¼šåŒ…å«æ–œæ åˆ™æŒ‰ORé€»è¾‘ï¼Œå¦åˆ™æŒ‰ANDé€»è¾‘
    const isOR = searchInput.includes('/');
    const separator = isOR ? '/' : /\s+/; // é€‰æ‹©åˆ†éš”ç¬¦
    
    // åˆ†å‰²å…³é”®è¯ï¼ˆå…¼å®¹è¿ç»­åˆ†éš”ç¬¦ï¼‰
    const keywords = searchInput.split(separator)
        .map(k => k.trim())
        .filter(k => k !== '');

    const filteredPosts = posts.filter(post => {
        // æ ¹æ®é€»è¾‘ç±»å‹é€‰æ‹©åŒ¹é…æ–¹å¼
        return isOR ? 
            // ORé€»è¾‘ï¼šä»»æ„å…³é”®è¯åŒ¹é…
            keywords.some(keyword => checkKeywordMatch(post, keyword)) : 
            // ANDé€»è¾‘ï¼šæ‰€æœ‰å…³é”®è¯å¿…é¡»åŒ¹é…
            keywords.every(keyword => checkKeywordMatch(post, keyword));
    });

    renderPosts(filteredPosts);
}

// å°è£…å…³é”®è¯åŒ¹é…é€»è¾‘
function checkKeywordMatch(post, keyword) {
    const contentMatch = post.content && post.content.toLowerCase().includes(keyword);
    const tagMatch = post.tags && post.tags.some(tag => tag.toLowerCase().includes(keyword));
    return contentMatch || tagMatch;
}

// æ·»åŠ å›è½¦é”®æœç´¢åŠŸèƒ½
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchPosts(); // è§¦å‘ä¿®æ”¹åçš„æœç´¢é€»è¾‘
    }
});
function exportPosts() {
    const data = {
        posts: posts.map(post => ({
            ...post,
            lastModified: post.lastModified || Date.now() // ç¡®ä¿æ—§æ•°æ®ä¹Ÿæœ‰æ—¶é—´æˆ³
        })),
        tags: Array.from(allTags)
    };
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `posts_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// åœ¨importPostså‡½æ•°ä¸­æ·»åŠ å†²çªæ£€æµ‹å’Œæç¤ºé€»è¾‘
async function importPosts(input) {
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
      try {
          const data = JSON.parse(e.target.result);
            
          let updatedCount = 0;
          const newPosts = [];
          const conflictList = [];
            
          // ç¬¬ä¸€é˜¶æ®µï¼šæ”¶é›†å†²çª
          data.posts.forEach(importedPost => {
              if (!importedPost.lastModified) {
                  importedPost.lastModified = Date.now();
              }
                
              const existingIndex = posts.findIndex(p => p.id === importedPost.id);
              if (existingIndex >= 0) {
                    const existingPost = posts[existingIndex];
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯çœŸæ­£çš„å†²çªï¼ˆå†…å®¹ä¸åŒä¸”éƒ½æœ‰ç¼–è¾‘å†å²ï¼‰
                    const isRealConflict = () => {
                        // åŸºæœ¬å­—æ®µæ¯”è¾ƒ
                        const basicFieldsDiff = 
                            importedPost.content !== existingPost.content ||
                            JSON.stringify(importedPost.tags) !== JSON.stringify(existingPost.tags) ||
                            JSON.stringify(importedPost.media) !== JSON.stringify(existingPost.media);
                        
                        // éƒ½æœ‰ç¼–è¾‘å†å²
                        const bothEdited = importedPost.lastModified && existingPost.lastModified;
                        
                        return basicFieldsDiff && bothEdited;
                    };

                    if (isRealConflict()) {
                        conflictList.push({
                            imported: importedPost,
                            existing: existingPost,
                            index: existingIndex,
                            // æ·»åŠ å†²çªç±»å‹æ ‡è¯†
                            type: 'content'
                        });
                    } else if (!isRealConflict() && importedPost.lastModified > existingPost.lastModified) {
                        // æ²¡æœ‰çœŸæ­£å†²çªä½†å¯¼å…¥ç‰ˆæœ¬è¾ƒæ–°ï¼Œè‡ªåŠ¨æ›´æ–°
                        posts[existingIndex] = importedPost;
                        updatedCount++;
                    }
                } else {
                    newPosts.push(importedPost);
                }
                // â–²â–²â–² æ·»åŠ ç»“æŸ â–²â–²â–²
            });

            // ç¬¬äºŒé˜¶æ®µï¼šå¤„ç†å†²çª
            for (const conflict of conflictList) {
                const userChoice = await showConflictDialog(conflict);
                if (userChoice === 'import') {
                    posts[conflict.index] = conflict.imported;
                    updatedCount++;
                }
                // é€‰æ‹©"ä¿ç•™"åˆ™ä¸åšä»»ä½•æ“ä½œ
            }
            
            // ç¬¬ä¸‰é˜¶æ®µï¼šåˆå¹¶æ•°æ®
            posts = [...posts, ...newPosts];
            data.tags.forEach(tag => allTags.add(tag));
            
            if (saveToLocalStorage()) {
                renderTags();
                renderPosts(posts);
                alert(`å¯¼å…¥å®Œæˆï¼\næ–°å¢å¸–å­ï¼š${newPosts.length}\næ›´æ–°å¸–å­ï¼š${updatedCount}\nè§£å†³å†²çªï¼š${conflictList.length}`);
            }
        } catch(err) {
            alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// æ–°å¢å†²çªå¯¹æ¯”å¯¹è¯æ¡†
function showConflictDialog(conflict) {
    return new Promise((resolve) => {
        const dialog = document.createElement('div');
        dialog.style.position = 'fixed';
        dialog.style.top = '50%';
        dialog.style.left = '50%';
        dialog.style.transform = 'translate(-50%, -50%)';
        dialog.classList.add('conflict-dialog');
        dialog.style.padding = '20px';
        dialog.style.borderRadius = '10px';
        dialog.style.zIndex = '10000';
        dialog.style.maxWidth = '90vw';
        
        // å¯¹æ¯”å†…å®¹ç”Ÿæˆ
        const diffHtml = generateDiffHtml(conflict.existing, conflict.imported);
        
        dialog.innerHTML = `
         <h3 class="conflict-title">å‘ç°å†…å®¹å†²çª</h3>
            ${diffHtml}
 <div style="display:flex;justify-content:space-between;margin-top:20px;">
    <button onclick="this.parentElement.parentElement.resolution('keep')" 
        class="conflict-btn";border:none;padding:6px 15px;border-radius:5px;">
        ä¿ç•™å½“å‰ç‰ˆæœ¬
    </button>
    <button onclick="this.parentElement.parentElement.resolution('import')" 
        style="background:#ba5757;color:white;border:none;padding:6px 15px;border-radius:5px;margin-left:auto;">
        ä½¿ç”¨å¯¼å…¥ç‰ˆæœ¬
    </button>
</div>

        `;
        
        // è‡ªå®šä¹‰å†³è®®æ–¹æ³•
        dialog.resolution = (choice) => {
            document.body.removeChild(dialog);
            resolve(choice);
        };
        
        document.body.appendChild(dialog);
    });
}

// ç”Ÿæˆå¯¹æ¯”HTML
function generateDiffHtml(current, imported) {
  // åªæ˜¾ç¤ºå®é™…æœ‰å·®å¼‚çš„å­—æ®µ
  const diffFields = [
      { name: 'content', title: 'å†…å®¹' },
      { name: 'tags', title: 'æ ‡ç­¾', format: v => JSON.stringify(v, null, 2) },
      { name: 'media', title: 'åª’ä½“', format: v => JSON.stringify(v, null, 2) }
  ].filter(field => {
      const currentVal = field.format ? field.format(current[field.name]) : current[field.name];
      const importedVal = field.format ? field.format(imported[field.name]) : imported[field.name];
      return currentVal !== importedVal;
  });

  if (diffFields.length === 0) {
      return `<div style="color:rgb(var(--theme-foreground));">IDç›¸åŒä½†æœªæ£€æµ‹åˆ°å†…å®¹å·®å¼‚</div>`;
  }

  const diffSections = diffFields.map(field => {
      const currentVal = field.format ? field.format(current[field.name]) : current[field.name];
      const importedVal = field.format ? field.format(imported[field.name]) : imported[field.name];
        
      return `
          <div class="diff-section">
              <div class="diff-title">${field.title}å¯¹æ¯”</div>
              <div class="diff-row">
                  <div class="diff-version" style="border-right:1px solid #ba5757;">
                      <div class="diff-header">å½“å‰ç‰ˆæœ¬</div>
                      <div class="diff-content">${currentVal}</div>
                  </div>
                  <div class="diff-version">
                      <div class="diff-header">å¯¼å…¥ç‰ˆæœ¬</div>
                      <div class="diff-content">${importedVal}</div>
                  </div>
              </div>
          </div>
      `;
  }).join('');

  return `
<style>
    .diff-row { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
        margin: 10px 0; 
    }
    .diff-header { 
        color: rgb(var(--theme-foreground));
        margin-bottom: 5px; 
        font-size: 14px;
    }
    .diff-content {
        background: rgba(0,0,0,0.3); 
        padding: 10px;
        margin: 0; 
        max-height: 200px; 
        overflow: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 12px;
        line-height: 1.5;
        border-radius: 3px;
    }
    .diff-section {
        margin-bottom: 15px;
    }
    .diff-title {
        color: rgb(var(--theme-highlight));
        font-size: 13px;
        margin-bottom: 5px;
        padding-bottom: 3px;
        border-bottom: 1px solid rgb(var(--theme-foreground));
    }
</style>

      ${diffSections}
      <div style="color:#888;margin-top:10px;">
          å½“å‰ç‰ˆæœ¬ä¿®æ”¹æ—¶é—´ï¼š${new Date(current.lastModified).toLocaleString()}<br>
          å¯¼å…¥ç‰ˆæœ¬ä¿®æ”¹æ—¶é—´ï¼š${new Date(imported.lastModified).toLocaleString()}
      </div>
  `;
}



function saveToLocalStorage() {
    try {
        const uniqueIds = new Set(posts.map(p => p.id));
        if (uniqueIds.size !== posts.length) {
            console.error('å‘ç°é‡å¤ID');
            return false;
        }
        localStorage.setItem('posts', JSON.stringify(posts));
        localStorage.setItem('tags', JSON.stringify([...allTags]));
        return true;
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        return false;
    }
}
if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/notes-pwa/sw.js')
        .then(reg => console.log('SW registered', reg))
        .catch(err => console.error('SW failed', err));
    }
    window.addEventListener('beforeinstallprompt', e => {
      console.log('PWA å¯å®‰è£…');
    });
    
    // ä¸»é¢˜ç®¡ç†ç›¸å…³å˜é‡
let themes = JSON.parse(localStorage.getItem('themes') || '{}');
let currentThemeName = 'default';

// æ˜¾ç¤ºä¸»é¢˜è®¾ç½®æ¨¡æ€æ¡†
function showThemeSettings() {
    const themeManager = document.getElementById('themeManager');
    const themeSelect = document.getElementById('themeSelect');
    
    themeSelect.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰ä¸»é¢˜</option>';
    Object.keys(themes).forEach(themeName => {
        const option = document.createElement('option');
        option.value = themeName;
        option.textContent = themeName;
        themeSelect.appendChild(option);
    });

    updateThemeSettingsUI();
    themeManager.style.display = 'block';

    document.getElementById('backgroundType').addEventListener('change', toggleBackgroundSettings);
    document.getElementById('enableRain').addEventListener('change', toggleRainSettings);
    document.getElementById('backgroundMedia').addEventListener('input', toggleBackgroundSettings);
    document.getElementById('glassOpacity').addEventListener('input', () => {
        document.getElementById('glassOpacityValue').textContent = document.getElementById('glassOpacity').value;
    });
    document.getElementById('glassBlur').addEventListener('input', () => {
        document.getElementById('glassBlurValue').textContent = document.getElementById('glassBlur').value;
    });
    document.getElementById('videoSpeed').addEventListener('input', () => {
        document.getElementById('videoSpeedValue').textContent = document.getElementById('videoSpeed').value;
    });
    document.getElementById('rainCount').addEventListener('input', () => {
        document.getElementById('rainCountValue').textContent = document.getElementById('rainCount').value;
    });
    document.getElementById('rainSpeed').addEventListener('input', () => {
        document.getElementById('rainSpeedValue').textContent = document.getElementById('rainSpeed').value;
    });
    document.getElementById('postLetterSpacing').addEventListener('input', () => {
        document.getElementById('postLetterSpacingValue').textContent = document.getElementById('postLetterSpacing').value;
    });
    document.getElementById('postLineHeight').addEventListener('input', () => {
        document.getElementById('postLineHeightValue').textContent = document.getElementById('postLineHeight').value;
    });
    document.getElementById('postTextScaleX').addEventListener('input', () => {
        document.getElementById('postTextScaleXValue').textContent = document.getElementById('postTextScaleX').value;
    });
    document.getElementById('postFontSize').addEventListener('input', () => {
        document.getElementById('postFontSizeValue').textContent = document.getElementById('postFontSize').value;
    });

    // å®æ—¶æ›´æ–°å­—ä½“è®¾ç½®
    ['postLetterSpacing', 'postLineHeight', 'postTextScaleX', 'postFontSize'].forEach(id => {
        const element = document.getElementById(id);
        const newElement = element.cloneNode(true);
        element.parentNode.replaceChild(newElement, element);
        newElement.addEventListener('input', () => {
            const theme = themes[currentThemeName] || themes['default'];
            theme.postLetterSpacing = parseFloat(document.getElementById('postLetterSpacing').value);
            theme.postLineHeight = parseFloat(document.getElementById('postLineHeight').value);
            theme.postTextScaleX = parseFloat(document.getElementById('postTextScaleX').value);
            theme.postContainerWidthScale = parseFloat(document.getElementById('postTextScaleX').value); // åŒæ­¥
            theme.postFontSize = parseInt(document.getElementById('postFontSize').value);
            applyTheme();
        });
    });
}

// æ›´æ–°ä¸»é¢˜è®¾ç½®UI
function updateThemeSettingsUI() {
    const theme = themes[currentThemeName] || {
        backgroundType: 'solid',
        solidBackgroundColor: '#1d1d5c',
        backgroundMedia: '',
        glassOpacity: 0.6,
        glassBlur: 7,
        videoSpeed: 1,
        enableRain: false,
        rainCount: 100,
        rainSpeed: 2,
        themeBackground: '#1d1d5c',
        themeForeground: '#ba5757',
        themeSecondary: '#a8a8e4',
        themeHighlight: '#f7ebeb',
        postLetterSpacing: 0.3,
        postLineHeight: 1.7,
        postTextScaleX: 1,
        postContainerWidthScale: 1, // æ–°å¢
        postFontSize: 16
    };

    document.getElementById('themeName').value = currentThemeName;
    document.getElementById('backgroundType').value = theme.backgroundType;
    document.getElementById('solidBackgroundColor').value = theme.solidBackgroundColor;
    document.getElementById('backgroundMedia').value = theme.backgroundMedia;
    document.getElementById('glassOpacity').value = theme.glassOpacity;
    document.getElementById('glassBlur').value = theme.glassBlur;
    document.getElementById('glassOpacityValue').textContent = theme.glassOpacity;
    document.getElementById('glassBlurValue').textContent = theme.glassBlur;
    document.getElementById('videoSpeed').value = theme.videoSpeed;
    document.getElementById('videoSpeedValue').textContent = theme.videoSpeed;
    document.getElementById('enableRain').checked = theme.enableRain;
    document.getElementById('rainCount').value = theme.rainCount;
    document.getElementById('rainCountValue').textContent = theme.rainCount;
    document.getElementById('rainSpeed').value = theme.rainSpeed;
    document.getElementById('rainSpeedValue').textContent = theme.rainSpeed;
    document.getElementById('themeBackground').value = theme.themeBackground;
    document.getElementById('themeForeground').value = theme.themeForeground;
    document.getElementById('themeSecondary').value = theme.themeSecondary;
    document.getElementById('themeHighlight').value = theme.themeHighlight;
    document.getElementById('postLetterSpacing').value = theme.postLetterSpacing;
    document.getElementById('postLetterSpacingValue').textContent = theme.postLetterSpacing;
    document.getElementById('postLineHeight').value = theme.postLineHeight;
    document.getElementById('postLineHeightValue').textContent = theme.postLineHeight;
    document.getElementById('postTextScaleX').value = theme.postTextScaleX;
    document.getElementById('postTextScaleXValue').textContent = theme.postTextScaleX;
    document.getElementById('postFontSize').value = theme.postFontSize;
    document.getElementById('postFontSizeValue').textContent = theme.postFontSize;

    toggleBackgroundSettings();
    toggleRainSettings();
    applyTheme();
}

// åˆ‡æ¢èƒŒæ™¯ç±»å‹è®¾ç½®æ˜¾ç¤º
function toggleBackgroundSettings() {
    const backgroundType = document.getElementById('backgroundType').value;
    document.getElementById('solidColorSettings').style.display = backgroundType === 'solid' ? 'block' : 'none';
    document.getElementById('glassSettings').style.display = backgroundType === 'glass' ? 'block' : 'none';
    document.getElementById('videoSpeedSettings').style.display = backgroundType === 'glass' && isVideoUrl(document.getElementById('backgroundMedia').value) ? 'block' : 'none';
}

// åˆ‡æ¢é›¨æ»´è®¾ç½®æ˜¾ç¤º
function toggleRainSettings() {
    const enableRain = document.getElementById('enableRain').checked;
    document.getElementById('rainSettings').style.display = enableRain ? 'block' : 'none';
}

// åˆ¤æ–­æ˜¯å¦ä¸ºè§†é¢‘URL
function isVideoUrl(url) {
    return url.match(/\.(mp4|webm|ogg)$/i);
}

// åˆ›å»ºé›¨æ»´æ•ˆæœ
function createRain(count, speed) {
    const rainContainer = document.querySelector('.rain-container');
    rainContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰é›¨æ»´
    for (let i = 0; i < count; i++) {
        const rain = document.createElement('div');
        rain.classList.add('rain');
        rain.style.left = `${Math.random() * 100}vw`;
        rain.style.animationDuration = `${Math.random() * (speed * 0.5) + (speed * 0.5)}s`;
        rain.style.animationDelay = `${Math.random() * 5}s`;
        rainContainer.appendChild(rain);
    }
}

// ä¿å­˜ä¸»é¢˜
function saveTheme() {
    const themeName = document.getElementById('themeName').value.trim();
    if (!themeName) {
        alert('è¯·è¾“å…¥ä¸»é¢˜åç§°');
        return;
    }

    const theme = {
        backgroundType: document.getElementById('backgroundType').value,
        solidBackgroundColor: document.getElementById('solidBackgroundColor').value,
        backgroundMedia: document.getElementById('backgroundMedia').value,
        glassOpacity: parseFloat(document.getElementById('glassOpacity').value),
        glassBlur: parseInt(document.getElementById('glassBlur').value),
        videoSpeed: parseFloat(document.getElementById('videoSpeed').value),
        enableRain: document.getElementById('enableRain').checked,
        rainCount: parseInt(document.getElementById('rainCount').value),
        rainSpeed: parseFloat(document.getElementById('rainSpeed').value),
        themeBackground: document.getElementById('themeBackground').value,
        themeForeground: document.getElementById('themeForeground').value,
        themeSecondary: document.getElementById('themeSecondary').value,
        themeHighlight: document.getElementById('themeHighlight').value,
        postLetterSpacing: parseFloat(document.getElementById('postLetterSpacing').value),
        postLineHeight: parseFloat(document.getElementById('postLineHeight').value),
        postTextScaleX: parseFloat(document.getElementById('postTextScaleX').value),
        postContainerWidthScale: parseFloat(document.getElementById('postTextScaleX').value), // åŒæ­¥
        postFontSize: parseInt(document.getElementById('postFontSize').value)
    };

    themes[themeName] = theme;
    localStorage.setItem('themes', JSON.stringify(themes));
    currentThemeName = themeName;

    const themeSelect = document.getElementById('themeSelect');
    if (!themeSelect.querySelector(`option[value="${themeName}"]`)) {
        const option = document.createElement('option');
        option.value = themeName;
        option.textContent = themeName;
        themeSelect.appendChild(option);
    }
    themeSelect.value = themeName;

    alert('ä¸»é¢˜ä¿å­˜æˆåŠŸ');
}

// åº”ç”¨ä¸»é¢˜
function applyTheme(themeName = currentThemeName) {
    const theme = themes[themeName] || themes['default'] || {
        backgroundType: 'solid',
        solidBackgroundColor: '#1d1d5c',
        backgroundMedia: '',
        glassOpacity: 0.6,
        glassBlur: 7,
        videoSpeed: 1,
        enableRain: false,
        rainCount: 100,
        rainSpeed: 2,
        themeBackground: '#1d1d5c',
        themeForeground: '#ba5757',
        themeSecondary: '#a8a8e4',
        themeHighlight: '#f7ebeb',
        postLetterSpacing: 0.3,
        postLineHeight: 1.7,
        postTextScaleX: 1,
        postContainerWidthScale: 1,
        postFontSize: 16,
        postFontUrl: '',
        postFontName: 'CustomFont'
    };

    const root = document.documentElement;
    const bgColor = hexToRgb(theme.themeBackground);
    const fgColor = hexToRgb(theme.themeForeground);
    const secColor = hexToRgb(theme.themeSecondary);
    const hiColor = hexToRgb(theme.themeHighlight);

    root.style.setProperty('--theme-background', `${bgColor.r}, ${bgColor.g}, ${bgColor.b}`);
    root.style.setProperty('--theme-foreground', `${fgColor.r}, ${fgColor.g}, ${fgColor.b}`);
    root.style.setProperty('--theme-secondary', `${secColor.r}, ${secColor.g}, ${secColor.b}`);
    root.style.setProperty('--theme-highlight', `${hiColor.r}, ${hiColor.g}, ${hiColor.b}`);
    root.style.setProperty('--glass-background', `${bgColor.r}, ${bgColor.g}, ${bgColor.b}`);
    root.style.setProperty('--glass-opacity', theme.glassOpacity);
    root.style.setProperty('--glass-blur', `${theme.glassBlur}px`);
    root.style.setProperty('--post-letter-spacing', `${theme.postLetterSpacing}px`);
    root.style.setProperty('--post-line-height', theme.postLineHeight);
    root.style.setProperty('--post-text-scale-x', theme.postTextScaleX);
    root.style.setProperty('--post-container-width-scale', theme.postContainerWidthScale);
    root.style.setProperty('--post-font-size', `${theme.postFontSize}px`);

    // åŠ¨æ€åŠ è½½å­—ä½“
    if (theme.postFontUrl && theme.postFontUrl.endsWith('.woff2')) {
        const fontName = theme.postFontName || 'CustomFont';
        const existingFontStyle = document.getElementById('dynamic-font');
        if (existingFontStyle) existingFontStyle.remove();
        const fontStyle = document.createElement('style');
        fontStyle.id = 'dynamic-font';
        fontStyle.textContent = `
            @font-face {
                font-family: "${fontName}";
                src: url("${theme.postFontUrl}") format("woff2");
                font-weight: normal;
                font-style: normal;
            }
            .post-content {
                font-family: "${fontName}", sans-serif !important;
            }
        `;
        document.head.appendChild(fontStyle);
        const fontTest = new FontFace(fontName, `url(${theme.postFontUrl})`, {
            style: 'normal',
            weight: 'normal'
        });
        fontTest.load().then(() => {
            document.fonts.add(fontTest);
        }).catch(error => {
            console.warn(`å­—ä½“åŠ è½½å¤±è´¥: ${theme.postFontUrl}`, error);
            document.querySelectorAll('.post-content').forEach(el => {
                el.style.fontFamily = 'inherit';
            });
        });
    } else {
        document.querySelectorAll('.post-content').forEach(el => {
            el.style.fontFamily = 'inherit';
        });
        const existingFontStyle = document.getElementById('dynamic-font');
        if (existingFontStyle) existingFontStyle.remove();
    }

    // åº”ç”¨æ­£æ–‡ç¼©æ”¾
    document.querySelectorAll('.post-content').forEach(el => {
        el.style.transform = `scaleX(${theme.postTextScaleX})`;
        el.style.width = `calc(100% / ${theme.postContainerWidthScale})`;
    });

    // é‡ç½® blockquote æ ·å¼
    document.querySelectorAll('.post blockquote').forEach(el => {
        el.style.transform = 'none';
        el.style.width = '100%';
        el.style.fontFamily = 'Arial, sans-serif';
    });

    // é‡ç½® iframe å’Œ post-iframe æ ·å¼
    document.querySelectorAll('.post iframe, .post-iframe').forEach(el => {
        el.style.transform = 'none';
        el.style.width = '100%';
    });

    updateManifest();

    let bgContainer = document.querySelector('.background-media-container');
    if (bgContainer) bgContainer.remove();
    root.classList.remove('glass-background');
    document.querySelector('.rain-container').innerHTML = '';

    if (theme.backgroundType === 'solid') {
        document.body.style.background = theme.solidBackgroundColor;
        document.body.style.backgroundImage = 'none';
    } else {
        root.classList.add('glass-background');
        if (theme.backgroundMedia) {
            bgContainer = document.createElement('div');
            bgContainer.className = 'background-media-container';
            document.body.appendChild(bgContainer);

            if (isVideoUrl(theme.backgroundMedia)) {
                const video = document.createElement('video');
                video.src = theme.backgroundMedia;
                video.autoplay = true;
                video.loop = true;
                video.muted = true;
                video.playbackRate = theme.videoSpeed;
                bgContainer.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = theme.backgroundMedia;
                bgContainer.appendChild(img);
            }
        }

        if (theme.enableRain) {
            createRain(theme.rainCount, theme.rainSpeed);
        }
    }

    currentThemeName = themeName;
}

function hexToRgb(hex) {
    hex = hex.replace('#', '');
    const r = parseInt(hex.length === 3 ? hex[0] + hex[0] : hex.slice(0, 2), 16);
    const g = parseInt(hex.length === 3 ? hex[1] + hex[1] : hex.slice(2, 4), 16);
    const b = parseInt(hex.length === 3 ? hex[2] + hex[2] : hex.slice(4, 6), 16);
    return { r, g, b };
}

function updateManifest() {
    const theme = themes[currentThemeName] || themes['default'];
    const bgColor = hexToRgb(theme.themeBackground);
    const manifest = {
        name: "èµ›åšæ—¥è®°æœ¬",
        short_name: "Brood",
        start_url: "/notes-pwa/index.html",
        scope: "/notes-pwa/",
        display: "standalone",
        background_color: `rgb(${bgColor.r}, ${bgColor.g}, ${bgColor.b})`,
        theme_color: `rgb(${bgColor.r}, ${bgColor.g}, ${bgColor.b})`,
        icons: [
            {
                src: "/notes-pwa/images/placeholder.png",
                sizes: "878x878",
                type: "image/png",
                purpose: "any"
            }
        ]
    };

    const manifestLink = document.querySelector('link[rel="manifest"]');
    if (manifestLink.dataset.blobUrl) {
        URL.revokeObjectURL(manifestLink.dataset.blobUrl);
    }
    const blob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob) + `#t=${Date.now()}`; // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
    manifestLink.dataset.blobUrl = url;
    manifestLink.setAttribute('href', url);

    // å¼ºåˆ¶ Service Worker æ›´æ–°
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(reg => reg.update());
        });
    }
}

// åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– manifest
document.addEventListener('DOMContentLoaded', () => {
    updateManifest();
    initAudioPlayer();
});




// å¯¼å‡ºä¸»é¢˜
function exportThemes() {
    const blob = new Blob([JSON.stringify(themes)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `themes_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// å¯¼å…¥ä¸»é¢˜
function importThemes(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedThemes = JSON.parse(e.target.result);
            Object.keys(importedThemes).forEach(name => {
                themes[name] = importedThemes[name];
            });
            localStorage.setItem('themes', JSON.stringify(themes));
            alert('ä¸»é¢˜å¯¼å…¥æˆåŠŸ');
            showThemeSettings();
        } catch (err) {
            alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// ä¸»é¢˜é€‰æ‹©åˆ‡æ¢
document.getElementById('themeSelect').addEventListener('change', function() {
    const themeName = this.value;
    if (themeName) {
        currentThemeName = themeName;
        updateThemeSettingsUI();
        applyTheme(themeName);
    }
});

// åˆå§‹åŒ–é»˜è®¤ä¸»é¢˜
document.addEventListener('DOMContentLoaded', () => {
    if (!themes['default']) {
themes['default'] = {
    backgroundType: 'solid',
    solidBackgroundColor: '#1d1d5c',
    backgroundMedia: '',
    glassOpacity: 0.6,
    glassBlur: 7,
    videoSpeed: 1,
    enableRain: false,
    rainCount: 100,
    rainSpeed: 2,
    themeBackground: '#1d1d5c',
    themeForeground: '#ba5757',
    themeSecondary: '#a8a8e4',
    themeHighlight: '#f7ebeb',
    postLetterSpacing: 0.3,
    postLineHeight: 1.7,
    postTextScaleX: 1, // æ¢å¤
    postContainerWidthScale: 1, // æ–°å¢
    postFontSize: 12
};
        localStorage.setItem('themes', JSON.stringify(themes));
    }
    applyTheme('default');
});
</script>
</body>
</html>  
